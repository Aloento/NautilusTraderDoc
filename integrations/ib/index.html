<!doctype html>
<html lang="zh" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-integrations/ib" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.1">
<title data-rh="true">Interactive Brokers | NautilusTrader 文档</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://nautilus.aloen.to/integrations/ib"><meta data-rh="true" property="og:locale" content="zh"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Interactive Brokers | NautilusTrader 文档"><meta data-rh="true" name="description" content="Interactive Brokers（IB）是一个覆盖广泛金融工具的交易平台，包括股票、期权、期货、外汇、债券、基金和加密货币。NautilusTrader 提供了一个适配器，通过其 Python 库 ibapi（https//ibkrcampus.com/ibkr-api-page/trader-workstation-api/）来与 IB 集成。"><meta data-rh="true" property="og:description" content="Interactive Brokers（IB）是一个覆盖广泛金融工具的交易平台，包括股票、期权、期货、外汇、债券、基金和加密货币。NautilusTrader 提供了一个适配器，通过其 Python 库 ibapi（https//ibkrcampus.com/ibkr-api-page/trader-workstation-api/）来与 IB 集成。"><link data-rh="true" rel="icon" href="/logo.png"><link data-rh="true" rel="canonical" href="https://nautilus.aloen.to/integrations/ib"><link data-rh="true" rel="alternate" href="https://nautilus.aloen.to/integrations/ib" hreflang="zh"><link data-rh="true" rel="alternate" href="https://nautilus.aloen.to/integrations/ib" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"集成","item":"https://nautilus.aloen.to/integrations/"},{"@type":"ListItem","position":2,"name":"Interactive Brokers","item":"https://nautilus.aloen.to/integrations/ib"}]}</script><link rel="stylesheet" href="/assets/css/styles.33db920f.css">
<script src="/assets/js/runtime~main.461aeaee.js" defer="defer"></script>
<script src="/assets/js/main.3352860b.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/logo.png"><div role="region" aria-label="跳到主要内容"><a class="skipToContent__uWo" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/logo.png" alt="NautilusTrader Logo" class="themedComponent_WkLn themedComponent--light_cjoX"><img src="/logo.png" alt="NautilusTrader Logo" class="themedComponent_WkLn themedComponent--dark_jZId"></div><b class="navbar__title text--truncate">NautilusTrader</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/api_reference/">文档</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/Aloento/NautilusTraderDoc" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_KfBJ"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_RWFU colorModeToggle_sA1q"><button class="clean-btn toggleButton_qjfc toggleButtonDisabled_cpNp" type="button" disabled="" title="system mode" aria-label="切换浅色/暗黑模式（当前为system mode）"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_CetX lightToggleIcon_UYsV"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_CetX darkToggleIcon_i1s2"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_CetX systemToggleIcon_yIQx"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_PsjF"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_jk42"><div class="docsWrapper_KWBO"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_XpKL" type="button"></button><div class="docRoot_joIP"><aside class="theme-doc-sidebar-container docSidebarContainer_DOen"><div class="sidebarViewport_j7YP"><div class="sidebar_nPgc"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_MTDt"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_GgI9 menu__link menu__link--sublist" href="/api_reference/"><span title="Python API" class="categoryLinkLabel_XKxb">Python API</span></a><button aria-label="展开侧边栏分类 &#x27;Python API&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_GgI9 menu__link menu__link--sublist" href="/concepts/"><span title="Concepts" class="categoryLinkLabel_XKxb">Concepts</span></a><button aria-label="展开侧边栏分类 &#x27;Concepts&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_GgI9 menu__link menu__link--sublist" href="/developer_guide/"><span title="开发者指南" class="categoryLinkLabel_XKxb">开发者指南</span></a><button aria-label="展开侧边栏分类 &#x27;开发者指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_GgI9 menu__link menu__link--sublist" href="/getting_started/"><span title="入门" class="categoryLinkLabel_XKxb">入门</span></a><button aria-label="展开侧边栏分类 &#x27;入门&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_GgI9 menu__link menu__link--sublist menu__link--active" href="/integrations/"><span title="集成" class="categoryLinkLabel_XKxb">集成</span></a><button aria-label="折叠侧边栏分类 &#x27;集成&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/integrations/betfair"><span title="Betfair" class="linkLabel_CNtA">Betfair</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/integrations/binance"><span title="Binance" class="linkLabel_CNtA">Binance</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/integrations/bitmex"><span title="BitMEX" class="linkLabel_CNtA">BitMEX</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/integrations/blockchain"><span title="Blockchain" class="linkLabel_CNtA">Blockchain</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/integrations/bybit"><span title="Bybit" class="linkLabel_CNtA">Bybit</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/integrations/coinbase_intx"><span title="Coinbase International" class="linkLabel_CNtA">Coinbase International</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/integrations/databento"><span title="Databento" class="linkLabel_CNtA">Databento</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/integrations/dydx"><span title="dYdX" class="linkLabel_CNtA">dYdX</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/integrations/hyperliquid"><span title="Hyperliquid" class="linkLabel_CNtA">Hyperliquid</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/integrations/ib"><span title="Interactive Brokers" class="linkLabel_CNtA">Interactive Brokers</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/integrations/okx"><span title="OKX" class="linkLabel_CNtA">OKX</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/integrations/polymarket"><span title="Polymarket" class="linkLabel_CNtA">Polymarket</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/integrations/tardis"><span title="Tardis" class="linkLabel_CNtA">Tardis</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_GgI9 menu__link menu__link--sublist" href="/tutorials/"><span title="教程" class="categoryLinkLabel_XKxb">教程</span></a><button aria-label="展开侧边栏分类 &#x27;教程&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_bw1l"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_PIhC"><div class="docItemContainer_pFw3"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_HRKZ" aria-label="页面路径"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_sX5c"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/integrations/"><span>集成</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Interactive Brokers</span></li></ul></nav><div class="tocCollapsible_DhUt theme-doc-toc-mobile tocMobile_Izjv"><button type="button" class="clean-btn tocCollapsibleButton_eYR5">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>Interactive Brokers</h1></header>
<p>Interactive Brokers（IB）是一个覆盖广泛金融工具的交易平台，包括股票、期权、期货、外汇、债券、基金和加密货币。NautilusTrader 提供了一个适配器，通过其 Python 库 <code>ibapi</code>（<a href="https://github.com/nautechsystems/ibapi" target="_blank" rel="noopener noreferrer">https://github.com/nautechsystems/ibapi</a>）调用 Trader Workstation（TWS）API（<a href="https://ibkrcampus.com/ibkr-api-page/trader-workstation-api/" target="_blank" rel="noopener noreferrer">https://ibkrcampus.com/ibkr-api-page/trader-workstation-api/</a>）来与 IB 集成。</p>
<p>TWS API 用于连接 IB 的独立交易应用程序：TWS 和 IB Gateway。两者均可从 IB 官网下载。如果你尚未安装 TWS 或 IB Gateway，请参阅「初始设置」指南（<a href="https://ibkrcampus.com/ibkr-api-page/trader-workstation-api/#tws-download" target="_blank" rel="noopener noreferrer">https://ibkrcampus.com/ibkr-api-page/trader-workstation-api/#tws-download</a>）。在 NautilusTrader 中，你可以通过 <code>InteractiveBrokersClient</code> 与其中任一应用建立连接。</p>
<p>另一种选择是使用 IB Gateway 的 Docker 化版本（<a href="https://github.com/gnzsnz/ib-gateway-docker" target="_blank" rel="noopener noreferrer">https://github.com/gnzsnz/ib-gateway-docker</a>），这对在云端自动化部署交易策略尤为方便。该方案要求本机安装 Docker（<a href="https://www.docker.com/" target="_blank" rel="noopener noreferrer">https://www.docker.com/</a>）以及 Python 的 <code>docker</code> 包（<a href="https://pypi.org/project/docker/" target="_blank" rel="noopener noreferrer">https://pypi.org/project/docker/</a>），NautilusTrader 已把该包作为可选 extras 一并提供。</p>
<div class="theme-admonition theme-admonition-note admonition_lEzE alert alert--secondary"><div class="admonitionHeading_aAf0"><span class="admonitionIcon_xtBN"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_Vfkp"><p>独立版的 TWS 与 IB Gateway 在启动时需要手动输入用户名、密码及交易模式（live 或 paper）。Docker 化的 IB Gateway 则可通过程序化方式完成这些步骤，无需人工干预。</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="安装">安装<a href="#安装" class="hash-link" aria-label="安装的直接链接" title="安装的直接链接" translate="no">​</a></h2>
<p>要安装包含 Interactive Brokers（以及 Docker）支持的 NautilusTrader：</p>
<div class="language-bash codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-bash codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">pip install --upgrade &quot;nautilus_trader[ib,docker]&quot;</span><br></span></code></pre></div></div>
<p>如果从源码构建并希望安装全部可选项（包括 IB 与 Docker）：</p>
<div class="language-bash codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-bash codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">uv sync --all-extras</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-note admonition_lEzE alert alert--secondary"><div class="admonitionHeading_aAf0"><span class="admonitionIcon_xtBN"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_Vfkp"><p>由于 IB 官方未提供 <code>ibapi</code> 的 wheel 包，NautilusTrader 在 PyPI 上对其进行了重打包发布（<a href="https://pypi.org/project/nautilus-ibapi/" target="_blank" rel="noopener noreferrer">https://pypi.org/project/nautilus-ibapi/</a>）。</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="示例">示例<a href="#示例" class="hash-link" aria-label="示例的直接链接" title="示例的直接链接" translate="no">​</a></h2>
<p>可在仓库中找到实时示例脚本：<a href="https://github.com/nautechsystems/nautilus_trader/tree/develop/examples/live/interactive_brokers/" target="_blank" rel="noopener noreferrer">https://github.com/nautechsystems/nautilus_trader/tree/develop/examples/live/interactive_brokers/</a></p>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="快速上手">快速上手<a href="#快速上手" class="hash-link" aria-label="快速上手的直接链接" title="快速上手的直接链接" translate="no">​</a></h2>
<p>在实现策略之前，请确保已运行 TWS（Trader Workstation）或 IB Gateway。你可以使用个人凭据登录上述任一独立应用，也可以使用 <code>DockerizedIBGateway</code> 以编程方式连接。</p>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="连接方式">连接方式<a href="#连接方式" class="hash-link" aria-label="连接方式的直接链接" title="连接方式的直接链接" translate="no">​</a></h3>
<p>主要有两种连接 IB 的方式：</p>
<ol>
<li>连接到已有的 TWS 或 IB Gateway 实例</li>
<li>使用 Docker 化的 IB Gateway（推荐用于自动化部署）</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="默认端口">默认端口<a href="#默认端口" class="hash-link" aria-label="默认端口的直接链接" title="默认端口的直接链接" translate="no">​</a></h3>
<p>根据运行的应用与交易模式不同，IB 使用不同的默认端口：</p>
<table><thead><tr><th>应用</th><th>模拟交易（Paper）</th><th>实盘交易（Live）</th></tr></thead><tbody><tr><td>TWS</td><td>7497</td><td>7496</td></tr><tr><td>IB Gateway</td><td>4002</td><td>4001</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="连接到已有的-gateway-或-tws">连接到已有的 Gateway 或 TWS<a href="#连接到已有的-gateway-或-tws" class="hash-link" aria-label="连接到已有的 Gateway 或 TWS的直接链接" title="连接到已有的 Gateway 或 TWS的直接链接" translate="no">​</a></h3>
<p>连接到已有实例时，需要在 <code>InteractiveBrokersDataClientConfig</code> 和 <code>InteractiveBrokersExecClientConfig</code> 中分别指定 <code>ibg_host</code> 与 <code>ibg_port</code>：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive_brokers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> InteractiveBrokersDataClientConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive_brokers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> InteractiveBrokersExecClientConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 针对 TWS 模拟交易的示例（默认端口 7497）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> InteractiveBrokersDataClientConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ibg_host</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;127.0.0.1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ibg_port</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7497</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ibg_client_id</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exec_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> InteractiveBrokersExecClientConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ibg_host</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;127.0.0.1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ibg_port</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7497</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ibg_client_id</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    account_id</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;DU123456&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 你的模拟交易账户 ID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="使用-docker-化的-ib-gateway">使用 Docker 化的 IB Gateway<a href="#使用-docker-化的-ib-gateway" class="hash-link" aria-label="使用 Docker 化的 IB Gateway的直接链接" title="使用 Docker 化的 IB Gateway的直接链接" translate="no">​</a></h3>
<p>对于自动化部署，推荐使用 Docker 化的 Gateway。在客户端配置中传入 <code>dockerized_gateway</code>（<code>DockerizedIBGatewayConfig</code> 的实例），因为主机和端口由容器管理，无需再手动设置 <code>ibg_host</code>/<code>ibg_port</code>：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive_brokers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> DockerizedIBGatewayConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive_brokers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gateway </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> DockerizedIBGateway</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gateway_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> DockerizedIBGatewayConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    username</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;your_username&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 或使用环境变量 TWS_USERNAME</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    password</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;your_password&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 或使用环境变量 TWS_PASSWORD</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    trading_mode</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;paper&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># &quot;paper&quot; 或 &quot;live&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    read_only_api</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic"># 如需下单则设为 False</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    timeout</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">300</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic"># 启动超时时间（秒）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 首次启动可能需要一些时间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gateway </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> DockerizedIBGateway</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">gateway_config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gateway</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 确认是否已登录</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gateway</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_logged_in</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gateway</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">container</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 查看容器日志</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gateway</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">container</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">logs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="环境变量">环境变量<a href="#环境变量" class="hash-link" aria-label="环境变量的直接链接" title="环境变量的直接链接" translate="no">​</a></h3>
<p>可通过向 <code>DockerizedIBGatewayConfig</code> 传入 <code>username</code> 与 <code>password</code>，或者设置下列环境变量来提供凭据：</p>
<ul>
<li><code>TWS_USERNAME</code>：IB 账户用户名</li>
<li><code>TWS_PASSWORD</code>：IB 账户密码</li>
<li><code>TWS_ACCOUNT</code>：IB 账户 ID（作为 <code>account_id</code> 的回退值）</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="连接管理">连接管理<a href="#连接管理" class="hash-link" aria-label="连接管理的直接链接" title="连接管理的直接链接" translate="no">​</a></h3>
<p>该适配器提供健壮的连接管理功能：</p>
<ul>
<li>自动重连：可通过环境变量 <code>IB_MAX_CONNECTION_ATTEMPTS</code> 配置重试次数。</li>
<li>连接超时：可通过 <code>connection_timeout</code> 参数调整（默认 300 秒）。</li>
<li>连接看门狗：监控连接健康并在需要时触发重连。</li>
<li>优雅的错误处理：对各种连接场景进行分类处理并提供友好的错误信息。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="概览">概览<a href="#概览" class="hash-link" aria-label="概览的直接链接" title="概览的直接链接" translate="no">​</a></h2>
<p>Interactive Brokers 适配器与 IB 的 TWS API 深度集成，主要包含以下几个核心组件：</p>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="核心组件">核心组件<a href="#核心组件" class="hash-link" aria-label="核心组件的直接链接" title="核心组件的直接链接" translate="no">​</a></h3>
<ul>
<li><code>InteractiveBrokersClient</code>：核心客户端，基于 <code>ibapi</code> 执行 TWS API 请求，负责连接管理、错误处理与 API 交互协调。</li>
<li><code>InteractiveBrokersDataClient</code>：连接到 Gateway，用于流式接收行情（Quotes、Trades、Bars）等市场数据。</li>
<li><code>InteractiveBrokersExecutionClient</code>：负责账户信息、订单管理与交易执行。</li>
<li><code>InteractiveBrokersInstrumentProvider</code>：检索与管理合约/标的定义，支持期权与期货链的加载。</li>
<li><code>HistoricInteractiveBrokersClient</code>：用于检索历史数据与合约信息，适合回测与研究使用。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="支持组件">支持组件<a href="#支持组件" class="hash-link" aria-label="支持组件的直接链接" title="支持组件的直接链接" translate="no">​</a></h3>
<ul>
<li><code>DockerizedIBGateway</code>：管理 Docker 化的 IB Gateway 实例，便于自动化部署。</li>
<li>配置类：为各组件提供详细配置项。</li>
<li>工厂类：创建并配置客户端实例所需的依赖。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="支持的资产类别">支持的资产类别<a href="#支持的资产类别" class="hash-link" aria-label="支持的资产类别的直接链接" title="支持的资产类别的直接链接" translate="no">​</a></h3>
<p>该适配器支持通过 IB 提供的主要资产类别进行交易：</p>
<ul>
<li>股票类：股票、ETF、以及股票期权</li>
<li>固定收益类：债券与债券基金</li>
<li>衍生品：期货、期权与权证</li>
<li>外汇：现货外汇与远期</li>
<li>加密货币：如比特币、以太坊等</li>
<li>商品：实物商品与商品期货</li>
<li>指数类：指数产品与指数期权</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="interactive-brokers-客户端">Interactive Brokers 客户端<a href="#interactive-brokers-客户端" class="hash-link" aria-label="Interactive Brokers 客户端的直接链接" title="Interactive Brokers 客户端的直接链接" translate="no">​</a></h2>
<p><code>InteractiveBrokersClient</code> 是 IB 适配器的核心，负责一系列关键职能，包括建立与维护连接、处理 API 错误、执行交易以及获取行情、合约与账户等多类数据。</p>
<p>为便于管理这些职责，<code>InteractiveBrokersClient</code> 采用 mixin（混入）架构，将不同职责拆分到若干专门的 mixin 中，从而提高可维护性与清晰度。</p>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="客户端架构">客户端架构<a href="#客户端架构" class="hash-link" aria-label="客户端架构的直接链接" title="客户端架构的直接链接" translate="no">​</a></h3>
<p>客户端采用 mixin 架构，每个 mixin 负责 IB API 的一块功能：</p>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="连接管理interactivebrokersclientconnectionmixin">连接管理（<code>InteractiveBrokersClientConnectionMixin</code>）<a href="#连接管理interactivebrokersclientconnectionmixin" class="hash-link" aria-label="连接管理interactivebrokersclientconnectionmixin的直接链接" title="连接管理interactivebrokersclientconnectionmixin的直接链接" translate="no">​</a></h4>
<ul>
<li>建立并维护与 TWS/Gateway 的套接字连接。</li>
<li>处理连接超时与重连逻辑。</li>
<li>管理连接状态与健康监控。</li>
<li>支持通过环境变量 <code>IB_MAX_CONNECTION_ATTEMPTS</code> 配置重连尝试次数。</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="错误处理interactivebrokersclienterrormixin">错误处理（<code>InteractiveBrokersClientErrorMixin</code>）<a href="#错误处理interactivebrokersclienterrormixin" class="hash-link" aria-label="错误处理interactivebrokersclienterrormixin的直接链接" title="错误处理interactivebrokersclienterrormixin的直接链接" translate="no">​</a></h4>
<ul>
<li>处理所有 API 错误与警告。</li>
<li>将错误按类型分类（客户端错误、连通性问题、请求错误等）。</li>
<li>针对订阅与请求的特定错误场景进行处理。</li>
<li>提供详尽的错误日志与调试信息。</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="账户管理interactivebrokersclientaccountmixin">账户管理（<code>InteractiveBrokersClientAccountMixin</code>）<a href="#账户管理interactivebrokersclientaccountmixin" class="hash-link" aria-label="账户管理interactivebrokersclientaccountmixin的直接链接" title="账户管理interactivebrokersclientaccountmixin的直接链接" translate="no">​</a></h4>
<ul>
<li>检索账户信息与余额。</li>
<li>管理持仓数据与投资组合更新。</li>
<li>处理多账户场景。</li>
<li>处理与账户相关的通知。</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="合约标的管理interactivebrokersclientcontractmixin">合约/标的管理（<code>InteractiveBrokersClientContractMixin</code>）<a href="#合约标的管理interactivebrokersclientcontractmixin" class="hash-link" aria-label="合约标的管理interactivebrokersclientcontractmixin的直接链接" title="合约标的管理interactivebrokersclientcontractmixin的直接链接" translate="no">​</a></h4>
<ul>
<li>检索合约详情与规范。</li>
<li>处理标的搜索与查找。</li>
<li>管理合约验证与校验。</li>
<li>支持复杂的标的类型（期权链、期货链等）。</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="行情数据管理interactivebrokersclientmarketdatamixin">行情数据管理（<code>InteractiveBrokersClientMarketDataMixin</code>）<a href="#行情数据管理interactivebrokersclientmarketdatamixin" class="hash-link" aria-label="行情数据管理interactivebrokersclientmarketdatamixin的直接链接" title="行情数据管理interactivebrokersclientmarketdatamixin的直接链接" translate="no">​</a></h4>
<ul>
<li>处理实时与历史行情数据订阅。</li>
<li>处理报价（quotes）、成交（trades）与 K 线（bars）数据。</li>
<li>管理行情数据类型设置（实时、延迟、冻结等）。</li>
<li>支持逐笔（tick-by-tick）数据与市场深度（market depth）。</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="订单管理interactivebrokersclientordermixin">订单管理（<code>InteractiveBrokersClientOrderMixin</code>）<a href="#订单管理interactivebrokersclientordermixin" class="hash-link" aria-label="订单管理interactivebrokersclientordermixin的直接链接" title="订单管理interactivebrokersclientordermixin的直接链接" translate="no">​</a></h4>
<ul>
<li>处理订单下单、修改与撤单。</li>
<li>处理订单状态更新与成交回报。</li>
<li>管理订单校验与错误处理。</li>
<li>支持复杂订单类型与条件。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="主要特性">主要特性<a href="#主要特性" class="hash-link" aria-label="主要特性的直接链接" title="主要特性的直接链接" translate="no">​</a></h3>
<ul>
<li>异步操作：所有操作均基于 Python 的 asyncio 异步实现。</li>
<li>健壮的错误处理：全面的错误分类与处理机制。</li>
<li>连接弹性：可配重试逻辑的自动重连。</li>
<li>消息处理：高吞吐场景下的高效消息队列处理。</li>
<li>状态管理：对连接、订阅与请求进行准确跟踪。</li>
</ul>
<div class="theme-admonition theme-admonition-tip admonition_lEzE alert alert--success"><div class="admonitionHeading_aAf0"><span class="admonitionIcon_xtBN"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>提示</div><div class="admonitionContent_Vfkp"><p>当排查 TWS API 的入站消息问题时，可以从 <code>InteractiveBrokersClient._process_message</code> 方法入手，该方法是处理来自 API 的所有消息的主要入口。</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="标识符symbology">标识符（Symbology）<a href="#标识符symbology" class="hash-link" aria-label="标识符（Symbology）的直接链接" title="标识符（Symbology）的直接链接" translate="no">​</a></h2>
<p><code>InteractiveBrokersInstrumentProvider</code> 支持三种构造 <code>InstrumentId</code> 的方法，可通过 <code>InteractiveBrokersInstrumentProviderConfig</code> 中的 <code>symbology_method</code> 枚举来配置。</p>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="标识符方法">标识符方法<a href="#标识符方法" class="hash-link" aria-label="标识符方法的直接链接" title="标识符方法的直接链接" translate="no">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="1-简化标识法ib_simplified--默认">1. 简化标识法（<code>IB_SIMPLIFIED</code>） — 默认<a href="#1-简化标识法ib_simplified--默认" class="hash-link" aria-label="1-简化标识法ib_simplified--默认的直接链接" title="1-简化标识法ib_simplified--默认的直接链接" translate="no">​</a></h4>
<p>当 <code>symbology_method</code> 设为 <code>IB_SIMPLIFIED</code>（默认）时，系统使用直观且便于阅读的标识规则：</p>
<p>按资产类别的格式规则：</p>
<ul>
<li>外汇（Forex）：<code>{symbol}/{currency}.{exchange}</code>
<ul>
<li>例子：<code>EUR/USD.IDEALPRO</code></li>
</ul>
</li>
<li>股票（Stocks）：<code>{localSymbol}.{primaryExchange}</code>
<ul>
<li>localSymbol 中的空格会被替换为连字符</li>
<li>例子：<code>BF-B.NYSE</code>、<code>SPY.ARCA</code></li>
</ul>
</li>
<li>期货（Futures）：<code>{localSymbol}.{exchange}</code>
<ul>
<li>个别合约使用单数字年份</li>
<li>例子：<code>ESM4.CME</code>、<code>CLZ7.NYMEX</code></li>
</ul>
</li>
<li>连续期货（Continuous Futures）：<code>{symbol}.{exchange}</code>
<ul>
<li>表示前月合约，自动滚动</li>
<li>例子：<code>ES.CME</code>、<code>CL.NYMEX</code></li>
</ul>
</li>
<li>期货期权（FOP）：<code>{localSymbol}.{exchange}</code>
<ul>
<li>格式：<code>{symbol}{month}{year} {right}{strike}</code></li>
<li>例子：<code>ESM4 C4200.CME</code></li>
</ul>
</li>
<li>期权（Options）：<code>{localSymbol}.{exchange}</code>
<ul>
<li>localSymbol 中的空格全部移除</li>
<li>例子：<code>AAPL230217P00155000.SMART</code></li>
</ul>
</li>
<li>指数（Indices）：<code>^{localSymbol}.{exchange}</code>
<ul>
<li>例子：<code>^SPX.CBOE</code>、<code>^NDX.NASDAQ</code></li>
</ul>
</li>
<li>债券（Bonds）：<code>{localSymbol}.{exchange}</code>
<ul>
<li>例子：<code>912828XE8.SMART</code></li>
</ul>
</li>
<li>加密货币（Cryptocurrencies）：<code>{symbol}/{currency}.{exchange}</code>
<ul>
<li>例子：<code>BTC/USD.PAXOS</code>、<code>ETH/USD.PAXOS</code></li>
</ul>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="2-原始标识法ib_raw">2. 原始标识法（<code>IB_RAW</code>）<a href="#2-原始标识法ib_raw" class="hash-link" aria-label="2-原始标识法ib_raw的直接链接" title="2-原始标识法ib_raw的直接链接" translate="no">​</a></h4>
<p>将 <code>symbology_method</code> 设为 <code>IB_RAW</code> 时，会采用与 IB API 字段直接对应的严格解析规则，适用于各种地区与复杂品种：</p>
<p>格式规则：</p>
<ul>
<li>差价合约（CFDs）：<code>{localSymbol}={secType}.IBCFD</code></li>
<li>大宗商品（Commodities）：<code>{localSymbol}={secType}.IBCMDTY</code></li>
<li>其他类型默认：<code>{localSymbol}={secType}.{exchange}</code></li>
</ul>
<p>示例：</p>
<ul>
<li><code>IBUS30=CFD.IBCFD</code></li>
<li><code>XAUUSD=CMDTY.IBCMDTY</code></li>
<li><code>AAPL=STK.SMART</code></li>
</ul>
<p>此配置可确保标的标识的明确性，适用于简化规则无法正确解析的国际化或非标准标的。</p>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="mic-交易所代码转换">MIC 交易所代码转换<a href="#mic-交易所代码转换" class="hash-link" aria-label="MIC 交易所代码转换的直接链接" title="MIC 交易所代码转换的直接链接" translate="no">​</a></h3>
<p>适配器支持将 IB 的交易所代码转换为市场标识码（MIC），以便统一表示交易场所：</p>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="convert_exchange_to_mic_venue"><code>convert_exchange_to_mic_venue</code><a href="#convert_exchange_to_mic_venue" class="hash-link" aria-label="convert_exchange_to_mic_venue的直接链接" title="convert_exchange_to_mic_venue的直接链接" translate="no">​</a></h4>
<p>将此项设为 <code>True</code> 时，适配器会自动把 IB 的交易所代码映射为对应的 MIC：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">instrument_provider_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> InteractiveBrokersInstrumentProviderConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    convert_exchange_to_mic_venue</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 启用 MIC 转换</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    symbology_method</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">SymbologyMethod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IB_SIMPLIFIED</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>MIC 转换示例：</p>
<ul>
<li><code>CME</code> → <code>XCME</code>（芝加哥商品交易所）</li>
<li><code>NASDAQ</code> → <code>XNAS</code>（纳斯达克交易所）</li>
<li><code>NYSE</code> → <code>XNYS</code>（纽约证券交易所）</li>
<li><code>LSE</code> → <code>XLON</code>（伦敦证券交易所）</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="symbol_to_mic_venue"><code>symbol_to_mic_venue</code><a href="#symbol_to_mic_venue" class="hash-link" aria-label="symbol_to_mic_venue的直接链接" title="symbol_to_mic_venue的直接链接" translate="no">​</a></h4>
<p>若需自定义映射，可使用 <code>symbol_to_mic_venue</code> 字典覆盖默认映射：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">instrument_provider_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> InteractiveBrokersInstrumentProviderConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    convert_exchange_to_mic_venue</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    symbol_to_mic_venue</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;ES&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;XCME&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 所有 ES 期货/期权使用 CME 的 MIC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;SPY&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ARCX&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 针对 SPY 指定 ARCA</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="支持的合约格式">支持的合约格式<a href="#支持的合约格式" class="hash-link" aria-label="支持的合约格式的直接链接" title="支持的合约格式的直接链接" translate="no">​</a></h3>
<p>适配器支持基于 Interactive Brokers 合约规范的多种合约格式：</p>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="期货月份代码">期货月份代码<a href="#期货月份代码" class="hash-link" aria-label="期货月份代码的直接链接" title="期货月份代码的直接链接" translate="no">​</a></h4>
<ul>
<li><strong>F</strong> = 一月，<strong>G</strong> = 二月，<strong>H</strong> = 三月，<strong>J</strong> = 四月</li>
<li><strong>K</strong> = 五月，<strong>M</strong> = 六月，<strong>N</strong> = 七月，<strong>Q</strong> = 八月</li>
<li><strong>U</strong> = 九月，<strong>V</strong> = 十月，<strong>X</strong> = 十一月，<strong>Z</strong> = 十二月</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="按资产类别支持的交易所">按资产类别支持的交易所<a href="#按资产类别支持的交易所" class="hash-link" aria-label="按资产类别支持的交易所的直接链接" title="按资产类别支持的交易所的直接链接" translate="no">​</a></h4>
<p>期货交易所（Futures Exchanges）：</p>
<ul>
<li><code>CME</code>, <code>CBOT</code>, <code>NYMEX</code>, <code>COMEX</code>, <code>KCBT</code>, <code>MGE</code>, <code>NYBOT</code>, <code>SNFE</code></li>
</ul>
<p>期权交易所（Options Exchanges）：</p>
<ul>
<li><code>SMART</code>（IB 的智能路由）</li>
</ul>
<p>外汇交易所（Forex Exchanges）：</p>
<ul>
<li><code>IDEALPRO</code>（IB 的外汇平台）</li>
</ul>
<p>加密货币交易所（Cryptocurrency Exchanges）：</p>
<ul>
<li><code>PAXOS</code>（IB 的加密货币平台）</li>
</ul>
<p>CFD/商品交易所（CFD/Commodity Exchanges）：</p>
<ul>
<li><code>IBCFD</code>, <code>IBCMDTY</code>（IB 的内部路由）</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="如何选择合适的标识方法">如何选择合适的标识方法<a href="#如何选择合适的标识方法" class="hash-link" aria-label="如何选择合适的标识方法的直接链接" title="如何选择合适的标识方法的直接链接" translate="no">​</a></h3>
<ul>
<li>对大多数场景使用 <code>IB_SIMPLIFIED</code>（默认），它能生成清晰且易读的 InstrumentId</li>
<li>在处理复杂的国际化合约或简化规则失效时使用 <code>IB_RAW</code></li>
<li>若需合规或数据一致性，请启用 <code>convert_exchange_to_mic_venue</code> 以获得标准化的 MIC 代码</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="合约instruments与-contract">合约（Instruments）与 Contract<a href="#合约instruments与-contract" class="hash-link" aria-label="合约（Instruments）与 Contract的直接链接" title="合约（Instruments）与 Contract的直接链接" translate="no">​</a></h2>
<p>在 Interactive Brokers 中，NautilusTrader 的 <code>Instrument</code> 对应于 IB 的 Contract（合约）。该适配器处理两类合约表示：</p>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="合约类型">合约类型<a href="#合约类型" class="hash-link" aria-label="合约类型的直接链接" title="合约类型的直接链接" translate="no">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="基础合约ibcontract">基础合约（<code>IBContract</code>）<a href="#基础合约ibcontract" class="hash-link" aria-label="基础合约ibcontract的直接链接" title="基础合约ibcontract的直接链接" translate="no">​</a></h4>
<ul>
<li>包含合约的基本识别字段</li>
<li>用于合约搜索与基础操作</li>
<li>无法直接转换为 NautilusTrader 的 <code>Instrument</code></li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="合约详情ibcontractdetails">合约详情（<code>IBContractDetails</code>）<a href="#合约详情ibcontractdetails" class="hash-link" aria-label="合约详情ibcontractdetails的直接链接" title="合约详情ibcontractdetails的直接链接" translate="no">​</a></h4>
<ul>
<li>包含更全面的合约信息，包括：<!-- -->
<ul>
<li>支持的订单类型</li>
<li>交易时间与日历</li>
<li>保证金要求</li>
<li>价格刻度与乘数</li>
<li>行情权限</li>
</ul>
</li>
<li>可转换为 NautilusTrader 的 <code>Instrument</code></li>
<li>交易操作通常需要 <code>IBContractDetails</code></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="合约查询">合约查询<a href="#合约查询" class="hash-link" aria-label="合约查询的直接链接" title="合约查询的直接链接" translate="no">​</a></h3>
<p>欲查询合约信息，可使用 IB 的 Contract Information Center（<a href="https://pennies.interactivebrokers.com/cstools/contract_info/" target="_blank" rel="noopener noreferrer">https://pennies.interactivebrokers.com/cstools/contract_info/</a>）。</p>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="加载合约">加载合约<a href="#加载合约" class="hash-link" aria-label="加载合约的直接链接" title="加载合约的直接链接" translate="no">​</a></h3>
<p>加载合约主要有两种方式：</p>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="1-使用-load_ids推荐">1. 使用 <code>load_ids</code>（推荐）<a href="#1-使用-load_ids推荐" class="hash-link" aria-label="1-使用-load_ids推荐的直接链接" title="1-使用-load_ids推荐的直接链接" translate="no">​</a></h4>
<p>在大多数场景下，使用 <code>symbology_method=SymbologyMethod.IB_SIMPLIFIED</code>（默认）搭配 <code>load_ids</code> 能得到清晰且直观的标识：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive_brokers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> InteractiveBrokersInstrumentProviderConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive_brokers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> SymbologyMethod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">instrument_provider_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> InteractiveBrokersInstrumentProviderConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    symbology_method</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">SymbologyMethod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IB_SIMPLIFIED</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    load_ids</span><span class="token operator" style="color:#393A34">=</span><span class="token builtin">frozenset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;EUR/USD.IDEALPRO&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 外汇</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;SPY.ARCA&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># 股票</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;ESM24.CME&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic"># 期货（个别合约）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;BTC/USD.PAXOS&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic"># 加密货币</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;^SPX.CBOE&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic"># 指数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="2-使用-load_contracts处理复杂合约">2. 使用 <code>load_contracts</code>（处理复杂合约）<a href="#2-使用-load_contracts处理复杂合约" class="hash-link" aria-label="2-使用-load_contracts处理复杂合约的直接链接" title="2-使用-load_contracts处理复杂合约的直接链接" translate="no">​</a></h4>
<p>对于期权链、期货链等复杂场景，可通过传入 <code>IBContract</code> 实例到 <code>load_contracts</code> 进行加载：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive_brokers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">common </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> IBContract</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 为指定到期日加载期权链</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">options_chain_expiry </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> IBContract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    secType</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;IND&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    symbol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;SPX&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    exchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;CBOE&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    build_options_chain</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lastTradeDateOrContractMonth</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;20240718&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 按到期日范围加载期权链</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">options_chain_range </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> IBContract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    secType</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;IND&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    symbol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;SPX&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    exchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;CBOE&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    build_options_chain</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    min_expiry_days</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    max_expiry_days</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 加载期货链</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">futures_chain </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> IBContract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    secType</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;CONTFUT&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    exchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;CME&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    symbol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;ES&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    build_futures_chain</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">instrument_provider_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> InteractiveBrokersInstrumentProviderConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    load_contracts</span><span class="token operator" style="color:#393A34">=</span><span class="token builtin">frozenset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        options_chain_expiry</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        options_chain_range</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        futures_chain</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="按资产类别的-ibcontract-示例">按资产类别的 <code>IBContract</code> 示例<a href="#按资产类别的-ibcontract-示例" class="hash-link" aria-label="按资产类别的-ibcontract-示例的直接链接" title="按资产类别的-ibcontract-示例的直接链接" translate="no">​</a></h3>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive_brokers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">common </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> IBContract</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 股票</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBContract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">secType</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;STK&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;SMART&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> primaryExchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;ARCA&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> symbol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;SPY&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBContract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">secType</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;STK&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;SMART&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> primaryExchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;NASDAQ&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> symbol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;AAPL&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 债券</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBContract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">secType</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;BOND&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> secIdType</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;ISIN&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> secId</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;US03076KAA60&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBContract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">secType</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;BOND&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> secIdType</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;CUSIP&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> secId</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;912828XE8&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 单张期权</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBContract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">secType</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;OPT&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;SMART&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> symbol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;SPY&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           lastTradeDateOrContractMonth</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;20251219&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> strike</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">500</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> right</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;C&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 期权链（加载所有行权价/到期日）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBContract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">secType</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;STK&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;SMART&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> primaryExchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;ARCA&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> symbol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;SPY&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           build_options_chain</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> min_expiry_days</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> max_expiry_days</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">60</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 差价合约（CFD）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBContract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">secType</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;CFD&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> symbol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;IBUS30&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBContract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">secType</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;CFD&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> symbol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;DE40EUR&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;SMART&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 单张期货</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBContract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">secType</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;FUT&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;CME&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> symbol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;ES&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           lastTradeDateOrContractMonth</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;20240315&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 期货链（加载所有到期日）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBContract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">secType</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;CONTFUT&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;CME&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> symbol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;ES&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> build_futures_chain</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 期货期权（FOP）- 单张</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBContract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">secType</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;FOP&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;CME&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> symbol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;ES&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           lastTradeDateOrContractMonth</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;20240315&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> strike</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">4200</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> right</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;C&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 期货期权链（加载所有行权价/到期日）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBContract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">secType</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;CONTFUT&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;CME&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> symbol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;ES&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           build_options_chain</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> min_expiry_days</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> max_expiry_days</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">60</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 外汇</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBContract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">secType</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;CASH&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;IDEALPRO&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> symbol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;EUR&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> currency</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;USD&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBContract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">secType</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;CASH&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;IDEALPRO&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> symbol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;GBP&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> currency</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;JPY&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 加密货币</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBContract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">secType</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;CRYPTO&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> symbol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;BTC&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;PAXOS&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> currency</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;USD&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBContract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">secType</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;CRYPTO&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> symbol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;ETH&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;PAXOS&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> currency</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;USD&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 指数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBContract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">secType</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;IND&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> symbol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;SPX&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;CBOE&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBContract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">secType</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;IND&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> symbol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;NDX&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;NASDAQ&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 商品</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBContract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">secType</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;CMDTY&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> symbol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;XAUUSD&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;SMART&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="高级配置选项">高级配置选项<a href="#高级配置选项" class="hash-link" aria-label="高级配置选项的直接链接" title="高级配置选项的直接链接" translate="no">​</a></h3>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 使用自定义交易所的期权链</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBContract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    secType</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;STK&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    symbol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;AAPL&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    exchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;SMART&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    primaryExchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;NASDAQ&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    build_options_chain</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    options_chain_exchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;CBOE&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 使用 CBOE 而非 SMART 来加载期权</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    min_expiry_days</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    max_expiry_days</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">45</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 指定月份的期货链</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBContract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    secType</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;CONTFUT&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    exchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;NYMEX&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    symbol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;CL&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 原油</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    build_futures_chain</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    min_expiry_days</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    max_expiry_days</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">180</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="连续期货continuous-futures">连续期货（Continuous futures）<a href="#连续期货continuous-futures" class="hash-link" aria-label="连续期货（Continuous futures）的直接链接" title="连续期货（Continuous futures）的直接链接" translate="no">​</a></h3>
<p>对于使用 <code>secType=&#x27;CONTFUT&#x27;</code> 的连续期货，适配器只使用符号与交易所来生成 InstrumentId：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 连续期货示例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBContract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">secType</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;CONTFUT&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;CME&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> symbol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;ES&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># → ES.CME</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IBContract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">secType</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;CONTFUT&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;NYMEX&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> symbol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;CL&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># → CL.NYMEX</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 启用 MIC 转换时</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">instrument_provider_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> InteractiveBrokersInstrumentProviderConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    convert_exchange_to_mic_venue</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 结果为：</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ES.XCME（代替 ES.CME）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># CL.XNYM（代替 CL.NYMEX）</span><br></span></code></pre></div></div>
<p>连续期货 vs 单张期货：</p>
<ul>
<li>连续（Continuous）：<code>ES.CME</code> — 表示前月合约并自动滚动</li>
<li>单张（Individual）：<code>ESM4.CME</code> — 指定的 2024 年 3 月合约</li>
</ul>
<div class="theme-admonition theme-admonition-note admonition_lEzE alert alert--secondary"><div class="admonitionHeading_aAf0"><span class="admonitionIcon_xtBN"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_Vfkp"><p>在使用 <code>build_options_chain=True</code> 或 <code>build_futures_chain=True</code> 时，应为基础合约指定 <code>secType</code> 与 <code>symbol</code>；适配器会在指定的到期范围内自动发现并加载所有相关的衍生合约。</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="期权价差option-spreads">期权价差（Option spreads）<a href="#期权价差option-spreads" class="hash-link" aria-label="期权价差（Option spreads）的直接链接" title="期权价差（Option spreads）的直接链接" translate="no">​</a></h2>
<p>Interactive Brokers 通过 BAG 合约支持期权价差（spreads），将多个期权腿组合成一个可交易合约。NautilusTrader 为创建、加载及交易价差提供了完整支持。</p>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="创建期权价差的-instrumentid">创建期权价差的 InstrumentId<a href="#创建期权价差的-instrumentid" class="hash-link" aria-label="创建期权价差的 InstrumentId的直接链接" title="创建期权价差的 InstrumentId的直接链接" translate="no">​</a></h3>
<p>期权价差可通过 <code>InstrumentId.new_spread()</code> 方法创建，该方法将各腿及其比例组合起来：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">identifiers </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> InstrumentId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 创建单个期权腿的 InstrumentId</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">call_leg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> InstrumentId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;SPY C400.SMART&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">put_leg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> InstrumentId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;SPY P390.SMART&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 创建 1:1 的看涨价差（买入看涨，卖出看涨）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">call_spread_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> InstrumentId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">new_spread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">call_leg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># 多头 1 张</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">put_leg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># 空头 1 张</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 创建 1:2 的比例价差</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ratio_spread_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> InstrumentId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">new_spread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">call_leg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># 多头 1 张</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">put_leg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 多头 2 张</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="动态加载价差">动态加载价差<a href="#动态加载价差" class="hash-link" aria-label="动态加载价差的直接链接" title="动态加载价差的直接链接" translate="no">​</a></h3>
<p>在交易或订阅行情前，必须先请求加载价差合约。可在策略中调用 <code>request_instrument()</code> 动态加载价差：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 在策略的 on_start 方法中</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">on_start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 请求加载价差合约</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">request_instrument</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">spread_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">on_instrument</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> instrument</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 处理已加载的价差合约</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Loaded spread: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">instrument</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation builtin">id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 现在可以订阅行情</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">subscribe_quote_ticks</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 并下单</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    order </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">order_factory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">market</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        instrument_id</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        order_side</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">OrderSide</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BUY</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        quantity</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">make_qty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        time_in_force</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">TimeInForce</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DAY</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">submit_order</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">order</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="价差交易要求">价差交易要求<a href="#价差交易要求" class="hash-link" aria-label="价差交易要求的直接链接" title="价差交易要求的直接链接" translate="no">​</a></h3>
<ol>
<li>先加载各个腿（Load individual legs first）：确保价差的组成腿都已可用。</li>
<li>请求加载价差合约（Request the spread instrument）：在交易前调用 <code>request_instrument()</code>。</li>
<li>订阅行情（Subscribe to market data）：价差加载后再请求报价逐笔数据。</li>
<li>下单（Place orders）：价差可用后可使用任意订单类型进行交易。</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="历史数据与回测">历史数据与回测<a href="#历史数据与回测" class="hash-link" aria-label="历史数据与回测的直接链接" title="历史数据与回测的直接链接" translate="no">​</a></h2>
<p><code>HistoricInteractiveBrokersClient</code> 提供了从 Interactive Brokers 获取历史数据的完整方法，适用于回测与研究。</p>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="支持的数据类型">支持的数据类型<a href="#支持的数据类型" class="hash-link" aria-label="支持的数据类型的直接链接" title="支持的数据类型的直接链接" translate="no">​</a></h3>
<ul>
<li>K 线（Bar data）：带时间、逐笔与成交量聚合的 OHLCV 数据</li>
<li>逐笔（Tick data）：交易逐笔与报价逐笔数据，精度可达微秒</li>
<li>合约数据（Instrument data）：完整的合约规格与交易规则</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="历史数据客户端">历史数据客户端<a href="#历史数据客户端" class="hash-link" aria-label="历史数据客户端的直接链接" title="历史数据客户端的直接链接" translate="no">​</a></h3>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive_brokers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">historical</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">client </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> HistoricInteractiveBrokersClient</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> ibapi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">common </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> MarketDataTypeEnum</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 初始化客户端</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> HistoricInteractiveBrokersClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    host</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;127.0.0.1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    port</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7497</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    client_id</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    market_data_type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">MarketDataTypeEnum</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DELAYED_FROZEN</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 若无订阅则使用延迟冻结数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log_level</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;INFO&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 连接到 TWS/Gateway</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">connect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="获取合约信息">获取合约信息<a href="#获取合约信息" class="hash-link" aria-label="获取合约信息的直接链接" title="获取合约信息的直接链接" translate="no">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="基本合约检索">基本合约检索<a href="#基本合约检索" class="hash-link" aria-label="基本合约检索的直接链接" title="基本合约检索的直接链接" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive_brokers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">common </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> IBContract</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 定义合约列表</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">contracts </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IBContract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">secType</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;STK&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> symbol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;AAPL&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;SMART&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> primaryExchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;NASDAQ&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IBContract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">secType</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;STK&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> symbol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;MSFT&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;SMART&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> primaryExchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;NASDAQ&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IBContract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">secType</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;CASH&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> symbol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;EUR&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> currency</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;USD&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;IDEALPRO&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 请求合约定义</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">instruments </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">request_instruments</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">contracts</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">contracts</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="下载期权链并保存到-catalog">下载期权链并保存到 Catalog<a href="#下载期权链并保存到-catalog" class="hash-link" aria-label="下载期权链并保存到 Catalog的直接链接" title="下载期权链并保存到 Catalog的直接链接" translate="no">​</a></h4>
<p>你可以在策略中使用 <code>request_instruments</code> 下载整条期权链，并通过 <code>update_catalog=True</code> 将数据保存到 Catalog：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 在策略的 on_start 方法中</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">on_start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">request_instruments</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        venue</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">IB_VENUE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        update_catalog</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        params</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;update_catalog&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;ib_contracts&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic"># SPY 期权</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string" style="color:#e3116c">&quot;secType&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;STK&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string" style="color:#e3116c">&quot;symbol&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;SPY&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string" style="color:#e3116c">&quot;exchange&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;SMART&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string" style="color:#e3116c">&quot;primaryExchange&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ARCA&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string" style="color:#e3116c">&quot;build_options_chain&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string" style="color:#e3116c">&quot;min_expiry_days&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string" style="color:#e3116c">&quot;max_expiry_days&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic"># QQQ 期权</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string" style="color:#e3116c">&quot;secType&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;STK&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string" style="color:#e3116c">&quot;symbol&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;QQQ&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string" style="color:#e3116c">&quot;exchange&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;SMART&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string" style="color:#e3116c">&quot;primaryExchange&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;NASDAQ&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string" style="color:#e3116c">&quot;build_options_chain&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string" style="color:#e3116c">&quot;min_expiry_days&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string" style="color:#e3116c">&quot;max_expiry_days&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic"># ES 期货期权</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string" style="color:#e3116c">&quot;secType&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CONTFUT&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string" style="color:#e3116c">&quot;exchange&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CME&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string" style="color:#e3116c">&quot;symbol&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ES&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string" style="color:#e3116c">&quot;build_options_chain&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string" style="color:#e3116c">&quot;min_expiry_days&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string" style="color:#e3116c">&quot;max_expiry_days&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">60</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="请求历史-k-线">请求历史 K 线<a href="#请求历史-k-线" class="hash-link" aria-label="请求历史 K 线的直接链接" title="请求历史 K 线的直接链接" translate="no">​</a></h3>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> datetime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 请求历史 K 线</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bars </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">request_bars</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bar_specifications</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;1-MINUTE-LAST&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 1 分钟 K 线，使用最新价</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;5-MINUTE-MID&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic"># 5 分钟 K 线，使用中间价</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;1-HOUR-LAST&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># 1 小时 K 线，使用最新价</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;1-DAY-LAST&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic"># 日线，使用最新价</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    start_date_time</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">datetime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">datetime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2023</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end_date_time</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">datetime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">datetime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2023</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tz_name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;America/New_York&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    contracts</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">contracts</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    use_rth</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 仅常规交易时段</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    timeout</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">120</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># 请求超时（秒）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="请求历史逐笔">请求历史逐笔<a href="#请求历史逐笔" class="hash-link" aria-label="请求历史逐笔的直接链接" title="请求历史逐笔的直接链接" translate="no">​</a></h3>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 请求历史逐笔数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ticks </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">request_ticks</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tick_types</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;TRADES&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;BID_ASK&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 成交逐笔与买卖价逐笔</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    start_date_time</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">datetime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">datetime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2023</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end_date_time</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">datetime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">datetime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2023</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tz_name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;America/New_York&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    contracts</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">contracts</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    use_rth</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    timeout</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">120</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="k-线规格">K 线规格<a href="#k-线规格" class="hash-link" aria-label="K 线规格的直接链接" title="K 线规格的直接链接" translate="no">​</a></h3>
<p>适配器支持多种 K 线规格：</p>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="时间型-k-线">时间型 K 线<a href="#时间型-k-线" class="hash-link" aria-label="时间型 K 线的直接链接" title="时间型 K 线的直接链接" translate="no">​</a></h4>
<ul>
<li><code>&quot;1-SECOND-LAST&quot;</code>, <code>&quot;5-SECOND-LAST&quot;</code>, <code>&quot;10-SECOND-LAST&quot;</code>, <code>&quot;15-SECOND-LAST&quot;</code>, <code>&quot;30-SECOND-LAST&quot;</code></li>
<li><code>&quot;1-MINUTE-LAST&quot;</code>, <code>&quot;2-MINUTE-LAST&quot;</code>, <code>&quot;3-MINUTE-LAST&quot;</code>, <code>&quot;5-MINUTE-LAST&quot;</code>, <code>&quot;10-MINUTE-LAST&quot;</code>, <code>&quot;15-MINUTE-LAST&quot;</code>, <code>&quot;20-MINUTE-LAST&quot;</code>, <code>&quot;30-MINUTE-LAST&quot;</code></li>
<li><code>&quot;1-HOUR-LAST&quot;</code>, <code>&quot;2-HOUR-LAST&quot;</code>, <code>&quot;3-HOUR-LAST&quot;</code>, <code>&quot;4-HOUR-LAST&quot;</code>, <code>&quot;8-HOUR-LAST&quot;</code></li>
<li><code>&quot;1-DAY-LAST&quot;</code>, <code>&quot;1-WEEK-LAST&quot;</code>, <code>&quot;1-MONTH-LAST&quot;</code></li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="价格类型">价格类型<a href="#价格类型" class="hash-link" aria-label="价格类型的直接链接" title="价格类型的直接链接" translate="no">​</a></h4>
<ul>
<li><code>LAST</code> - 最新成交价</li>
<li><code>MID</code> - 买卖价中间价</li>
<li><code>BID</code> - 买价</li>
<li><code>ASK</code> - 卖价</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="完整示例">完整示例<a href="#完整示例" class="hash-link" aria-label="完整示例的直接链接" title="完整示例的直接链接" translate="no">​</a></h3>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> asyncio</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> datetime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive_brokers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">common </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> IBContract</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive_brokers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">historical</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">client </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> HistoricInteractiveBrokersClient</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">persistence</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">catalog </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> ParquetDataCatalog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">download_historical_data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 初始化客户端</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    client </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> HistoricInteractiveBrokersClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        host</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;127.0.0.1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        port</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7497</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        client_id</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 连接</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">connect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> asyncio</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 等待连接稳定</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 定义合约</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    contracts </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        IBContract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">secType</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;STK&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> symbol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;AAPL&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;SMART&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> primaryExchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;NASDAQ&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        IBContract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">secType</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;CASH&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> symbol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;EUR&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> currency</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;USD&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;IDEALPRO&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 请求合约</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instruments </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">request_instruments</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">contracts</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">contracts</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 请求历史 K 线</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bars </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">request_bars</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bar_specifications</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;1-HOUR-LAST&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1-DAY-LAST&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        start_date_time</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">datetime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">datetime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2023</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        end_date_time</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">datetime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">datetime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2023</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tz_name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;America/New_York&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        contracts</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">contracts</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        use_rth</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 请求逐笔数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ticks </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">request_ticks</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tick_types</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;TRADES&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        start_date_time</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">datetime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">datetime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2023</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        end_date_time</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">datetime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">datetime</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2023</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">15</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tz_name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;America/New_York&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        contracts</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">contracts</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 保存到 catalog</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    catalog </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ParquetDataCatalog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;./catalog&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    catalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">write_data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">instruments</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    catalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">write_data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bars</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    catalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">write_data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ticks</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Downloaded </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation builtin">len</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation">instruments</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> instruments&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Downloaded </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation builtin">len</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation">bars</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> bars&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Downloaded </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation builtin">len</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation">ticks</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> ticks&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 断开连接</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">disconnect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 运行示例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;__main__&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    asyncio</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">download_historical_data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="数据限制">数据限制<a href="#数据限制" class="hash-link" aria-label="数据限制的直接链接" title="数据限制的直接链接" translate="no">​</a></h3>
<p>请注意 Interactive Brokers 在历史数据使用上的一些限制：</p>
<ul>
<li><strong>速率限制（Rate Limits）</strong>：IB 对历史数据请求会施加速率限制</li>
<li><strong>数据可用性（Data Availability）</strong>：历史数据的可用性取决于具体合约类型和订阅权限</li>
<li><strong>市场数据权限（Market Data Permissions）</strong>：部分数据需要特定的市场数据订阅才能访问</li>
<li><strong>时间范围（Time Ranges）</strong>：不同的 Bar 粒度和合约类型对最大回溯时长有不同限制</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="推荐最佳实践">推荐最佳实践<a href="#推荐最佳实践" class="hash-link" aria-label="推荐最佳实践的直接链接" title="推荐最佳实践的直接链接" translate="no">​</a></h3>
<ol>
<li><strong>使用延迟数据（Use Delayed Data）</strong>：用于回测时，<code>MarketDataTypeEnum.DELAYED_FROZEN</code> 常常已足够</li>
<li><strong>批量请求（Batch Requests）</strong>：在可能的情况下把多个合约合并为一次请求以降低速率消耗</li>
<li><strong>处理超时（Handle Timeouts）</strong>：对大规模数据请求设置合适的超时值</li>
<li><strong>遵守速率限制（Respect Rate Limits）</strong>：在请求之间加延迟以避免触发速率限制</li>
<li><strong>验证数据（Validate Data）</strong>：回测前务必检查数据质量和完整性</li>
</ol>
<div class="theme-admonition theme-admonition-warning admonition_lEzE alert alert--warning"><div class="admonitionHeading_aAf0"><span class="admonitionIcon_xtBN"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_Vfkp"><p>IB 会强制执行 pacing 限制；过量的历史数据或下单请求会触发 pacing 违规，IB 可能会暂停 API 会话数分钟。</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="实盘交易">实盘交易<a href="#实盘交易" class="hash-link" aria-label="实盘交易的直接链接" title="实盘交易的直接链接" translate="no">​</a></h2>
<p>在 Interactive Brokers 上做实盘交易时，需要搭建包含 <code>InteractiveBrokersDataClient</code> 与 <code>InteractiveBrokersExecutionClient</code> 的 <code>TradingNode</code>；两个客户端都依赖 <code>InteractiveBrokersInstrumentProvider</code> 来管理合约信息。</p>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="架构概览">架构概览<a href="#架构概览" class="hash-link" aria-label="架构概览的直接链接" title="架构概览的直接链接" translate="no">​</a></h3>
<p>实盘交易部署通常由三部分组成：</p>
<ol>
<li><strong>InstrumentProvider（合约提供器）</strong>：管理合约定义和 Contract 详情</li>
<li><strong>DataClient（数据客户端）</strong>：处理实时行情订阅</li>
<li><strong>ExecutionClient（执行客户端）</strong>：管理订单、持仓和账户信息</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="instrumentprovider-配置">InstrumentProvider 配置<a href="#instrumentprovider-配置" class="hash-link" aria-label="InstrumentProvider 配置的直接链接" title="InstrumentProvider 配置的直接链接" translate="no">​</a></h3>
<p><code>InteractiveBrokersInstrumentProvider</code> 是访问 IB 合约信息的桥梁，支持加载单个合约、期权链和期货链等。</p>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="基本配置">基本配置<a href="#基本配置" class="hash-link" aria-label="基本配置的直接链接" title="基本配置的直接链接" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive_brokers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> InteractiveBrokersInstrumentProviderConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive_brokers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> SymbologyMethod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive_brokers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">common </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> IBContract</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">instrument_provider_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> InteractiveBrokersInstrumentProviderConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    symbology_method</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">SymbologyMethod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IB_SIMPLIFIED</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    build_futures_chain</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 若需获取期货链则设为 True</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    build_options_chain</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 若需获取期权链则设为 True</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    min_expiry_days</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic"># 衍生品最小到期天数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    max_expiry_days</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">60</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic"># 衍生品最大到期天数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    convert_exchange_to_mic_venue</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 是否使用 MIC 码进行交易所映射</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cache_validity_days</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># 合约缓存有效期（天）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    load_ids</span><span class="token operator" style="color:#393A34">=</span><span class="token builtin">frozenset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 使用简化符号的单个合约示例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;EUR/USD.IDEALPRO&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic"># 外汇</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;BTC/USD.PAXOS&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 加密货币</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;SPY.ARCA&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">             </span><span class="token comment" style="color:#999988;font-style:italic"># 股票 ETF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;V.NYSE&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">               </span><span class="token comment" style="color:#999988;font-style:italic"># 个股</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;ESM4.CME&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">             </span><span class="token comment" style="color:#999988;font-style:italic"># 期货（年份为一位数字的示例）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;^SPX.CBOE&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># 指数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    load_contracts</span><span class="token operator" style="color:#393A34">=</span><span class="token builtin">frozenset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 使用 IBContract 指定的复杂合约示例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        IBContract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">secType</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;STK&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> symbol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;AAPL&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;SMART&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> primaryExchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;NASDAQ&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        IBContract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">secType</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;CASH&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> symbol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;GBP&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> currency</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;USD&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;IDEALPRO&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="衍生品的高级配置">衍生品的高级配置<a href="#衍生品的高级配置" class="hash-link" aria-label="衍生品的高级配置的直接链接" title="衍生品的高级配置的直接链接" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 配置期权与期货链</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">advanced_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> InteractiveBrokersInstrumentProviderConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    symbology_method</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">SymbologyMethod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IB_SIMPLIFIED</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    build_futures_chain</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># 启用期货链加载</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    build_options_chain</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># 启用期权链加载</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    min_expiry_days</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># 加载 7 天以上到期的合约</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    max_expiry_days</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">90</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic"># 加载 90 天内到期的合约</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    load_contracts</span><span class="token operator" style="color:#393A34">=</span><span class="token builtin">frozenset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 加载 SPY 的期权链</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        IBContract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            secType</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;STK&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            symbol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;SPY&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            exchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;SMART&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            primaryExchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;ARCA&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            build_options_chain</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 加载 ES 期货链</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        IBContract</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            secType</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;CONTFUT&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            exchange</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;CME&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            symbol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;ES&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            build_futures_chain</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="与外部数据提供方集成">与外部数据提供方集成<a href="#与外部数据提供方集成" class="hash-link" aria-label="与外部数据提供方集成的直接链接" title="与外部数据提供方集成的直接链接" translate="no">​</a></h3>
<p>Interactive Brokers 适配器可以与其他数据源并用以扩展行情覆盖。使用多数据源时应注意：</p>
<ul>
<li>在各数据源间采用一致的符号方法（symbology method）</li>
<li>可考虑设置 <code>convert_exchange_to_mic_venue=True</code> 以标准化交易场所标识</li>
<li>合理管理合约缓存以避免冲突</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="数据客户端配置">数据客户端配置<a href="#数据客户端配置" class="hash-link" aria-label="数据客户端配置的直接链接" title="数据客户端配置的直接链接" translate="no">​</a></h3>
<p><code>InteractiveBrokersDataClient</code> 负责与 IB 建立流式与请求式行情连接。连接后会根据 <code>InteractiveBrokersInstrumentProviderConfig</code> 的配置设置行情类型并加载合约。有关市场数据类型的说明可参考链接：<a href="https://ibkrcampus.com/ibkr-api-page/trader-workstation-api/#delayed-market-data" target="_blank" rel="noopener noreferrer">market data type</a>。</p>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="支持的数据类型-1">支持的数据类型<a href="#支持的数据类型-1" class="hash-link" aria-label="支持的数据类型的直接链接" title="支持的数据类型的直接链接" translate="no">​</a></h4>
<ul>
<li><strong>Quote Ticks（报价 Tick）</strong>：实时买卖价及量</li>
<li><strong>Trade Ticks（成交 Tick）</strong>：实时成交价和成交量</li>
<li><strong>Bar Data（Bar 数据）</strong>：实时 OHLCV 条（从 1 秒到 1 天粒度）</li>
<li><strong>Market Depth（市场深度）</strong>：二级行情（Level 2）订单薄数据（若可用）</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="市场数据类型market-data-types">市场数据类型（Market data types）<a href="#市场数据类型market-data-types" class="hash-link" aria-label="市场数据类型（Market data types）的直接链接" title="市场数据类型（Market data types）的直接链接" translate="no">​</a></h4>
<p>IB 支持多种市场数据类型：</p>
<ul>
<li><code>REALTIME</code>：实时行情（需要相应的市场数据订阅）</li>
<li><code>DELAYED</code>：延迟 15-20 分钟的数据（多数市场免费）</li>
<li><code>DELAYED_FROZEN</code>：延迟且不更新的数据（适用于测试）</li>
<li><code>FROZEN</code>：市场收盘时的最后已知实时数据</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="基本的数据客户端配置">基本的数据客户端配置<a href="#基本的数据客户端配置" class="hash-link" aria-label="基本的数据客户端配置的直接链接" title="基本的数据客户端配置的直接链接" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive_brokers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> IBMarketDataTypeEnum</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive_brokers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> InteractiveBrokersDataClientConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data_client_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> InteractiveBrokersDataClientConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ibg_host</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;127.0.0.1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ibg_port</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7497</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># TWS paper trading port</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ibg_client_id</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    use_regular_trading_hours</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 仅 RTH（股票）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    market_data_type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">IBMarketDataTypeEnum</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DELAYED_FROZEN</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 使用延迟数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ignore_quote_tick_size_updates</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 包括仅大小变动的更新</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instrument_provider</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">instrument_provider_config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    connection_timeout</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">300</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 5 分钟</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    request_timeout</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">60</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># 1 分钟</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="生产实时的高级配置">生产/实时的高级配置<a href="#生产实时的高级配置" class="hash-link" aria-label="生产/实时的高级配置的直接链接" title="生产/实时的高级配置的直接链接" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 面向生产的实时数据配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">production_data_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> InteractiveBrokersDataClientConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ibg_host</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;127.0.0.1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ibg_port</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">4001</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># IB Gateway live trading port</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ibg_client_id</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    use_regular_trading_hours</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 包含盘前盘后</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    market_data_type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">IBMarketDataTypeEnum</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">REALTIME</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 实时数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ignore_quote_tick_size_updates</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 降低 tick 量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    handle_revised_bars</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 处理 bar 的修正</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instrument_provider</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">instrument_provider_config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dockerized_gateway</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">dockerized_gateway_config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 使用 Docker 时的配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    connection_timeout</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">300</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    request_timeout</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">60</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="数据客户端配置选项">数据客户端配置选项<a href="#数据客户端配置选项" class="hash-link" aria-label="数据客户端配置选项的直接链接" title="数据客户端配置选项的直接链接" translate="no">​</a></h3>
<table><thead><tr><th>Option</th><th>Default</th><th>Description</th></tr></thead><tbody><tr><td><code>instrument_provider</code></td><td><code>InteractiveBrokersInstrumentProviderConfig()</code></td><td>控制启动时加载哪些合约的提供器配置</td></tr><tr><td><code>ibg_host</code></td><td><code>127.0.0.1</code></td><td>TWS/IB Gateway 的主机名或 IP</td></tr><tr><td><code>ibg_port</code></td><td><code>None</code></td><td>TWS/IB Gateway 端口（TWS 常用 7497/7496，IBG 常用 4002/4001）</td></tr><tr><td><code>ibg_client_id</code></td><td><code>1</code></td><td>连接到 TWS/IB Gateway 时使用的唯一客户端 ID</td></tr><tr><td><code>use_regular_trading_hours</code></td><td><code>True</code></td><td>为 True 时请求仅限常规交易时段（主要影响股票的 Bar 数据）</td></tr><tr><td><code>market_data_type</code></td><td><code>REALTIME</code></td><td>市场数据类型（<code>REALTIME</code>, <code>DELAYED</code>, <code>DELAYED_FROZEN</code> 等）</td></tr><tr><td><code>ignore_quote_tick_size_updates</code></td><td><code>False</code></td><td>为 True 时抑制仅大小变动的报价 Tick，以降低数据量</td></tr><tr><td><code>dockerized_gateway</code></td><td><code>None</code></td><td>可选的 <code>DockerizedIBGatewayConfig</code>，用于容器化部署</td></tr><tr><td><code>connection_timeout</code></td><td><code>300</code></td><td>等待初始 API 连接的最大秒数</td></tr><tr><td><code>request_timeout</code></td><td><code>60</code></td><td>历史数据请求的超时时间（秒）</td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="备注">备注<a href="#备注" class="hash-link" aria-label="备注的直接链接" title="备注的直接链接" translate="no">​</a></h4>
<ul>
<li><strong><code>use_regular_trading_hours</code></strong>：当为 True 时，数据请求仅覆盖常规交易时段，主要影响股票的 Bar 数据</li>
<li><strong><code>ignore_quote_tick_size_updates</code></strong>：为 True 时会过滤掉仅大小变化（价格未变）的报价 Tick，从而减少数据量</li>
<li><strong><code>handle_revised_bars</code></strong>：为 True 时会处理来自 IB 的 bar 修正（bar 可能在初次发布后被更新）</li>
<li><strong><code>connection_timeout</code></strong>：初始化连接允许的最长等待时间</li>
<li><strong><code>request_timeout</code></strong>：历史数据请求的最大等待时间</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="执行客户端execution-client配置选项">执行客户端（Execution client）配置选项<a href="#执行客户端execution-client配置选项" class="hash-link" aria-label="执行客户端（Execution client）配置选项的直接链接" title="执行客户端（Execution client）配置选项的直接链接" translate="no">​</a></h3>
<table><thead><tr><th>Option</th><th>Default</th><th>Description</th></tr></thead><tbody><tr><td><code>instrument_provider</code></td><td><code>InteractiveBrokersInstrumentProviderConfig()</code></td><td>控制启动时加载哪些合约的提供器配置</td></tr><tr><td><code>ibg_host</code></td><td><code>127.0.0.1</code></td><td>TWS/IB Gateway 的主机名或 IP</td></tr><tr><td><code>ibg_port</code></td><td><code>None</code></td><td>TWS/IB Gateway 端口（TWS 常用 7497/7496，IBG 常用 4002/4001）</td></tr><tr><td><code>ibg_client_id</code></td><td><code>1</code></td><td>连接到 TWS/IB Gateway 时使用的唯一客户端 ID</td></tr><tr><td><code>account_id</code></td><td><code>None</code></td><td>Interactive Brokers 的账户 ID（若为空则使用环境变量 <code>TWS_ACCOUNT</code>）</td></tr><tr><td><code>dockerized_gateway</code></td><td><code>None</code></td><td>可选的 <code>DockerizedIBGatewayConfig</code>，用于容器化部署</td></tr><tr><td><code>connection_timeout</code></td><td><code>300</code></td><td>等待初始 API 连接的最大秒数</td></tr><tr><td><code>fetch_all_open_orders</code></td><td><code>False</code></td><td>为 True 时会拉取所有 API client id 下的未结订单（而非仅当前会话）</td></tr><tr><td><code>track_option_exercise_from_position_update</code></td><td><code>False</code></td><td>为 True 时订阅实时持仓更新以检测期权行权事件</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="执行客户端配置">执行客户端配置<a href="#执行客户端配置" class="hash-link" aria-label="执行客户端配置的直接链接" title="执行客户端配置的直接链接" translate="no">​</a></h3>
<p><code>InteractiveBrokersExecutionClient</code> 负责交易执行、订单管理、账户信息和持仓跟踪，提供端到端的订单生命周期管理与实时账户更新。</p>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="支持的功能">支持的功能<a href="#支持的功能" class="hash-link" aria-label="支持的功能的直接链接" title="支持的功能的直接链接" translate="no">​</a></h4>
<ul>
<li><strong>订单管理（Order Management）</strong>：下单、修改与撤单</li>
<li><strong>订单类型（Order Types）</strong>：市价、限价、止损、止损限价、跟踪止损等多种类型</li>
<li><strong>账户信息（Account Information）</strong>：实时余额与保证金更新</li>
<li><strong>持仓跟踪（Position Tracking）</strong>：实时持仓更新与 P&amp;L</li>
<li><strong>交易报告（Trade Reporting）</strong>：执行报告与成交回报通知</li>
<li><strong>风控（Risk Management）</strong>：下单前风控检查与仓位限制</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="支持的订单类型">支持的订单类型<a href="#支持的订单类型" class="hash-link" aria-label="支持的订单类型的直接链接" title="支持的订单类型的直接链接" translate="no">​</a></h4>
<p>适配器支持大多数 IB 的订单类型：</p>
<ul>
<li><strong>市价单（Market Orders）</strong>：<code>OrderType.MARKET</code></li>
<li><strong>限价单（Limit Orders）</strong>：<code>OrderType.LIMIT</code></li>
<li><strong>止损单（Stop Orders）</strong>：<code>OrderType.STOP_MARKET</code></li>
<li><strong>止损限价单（Stop-Limit Orders）</strong>：<code>OrderType.STOP_LIMIT</code></li>
<li><strong>触及成市（Market-If-Touched）</strong>：<code>OrderType.MARKET_IF_TOUCHED</code></li>
<li><strong>触及成限（Limit-If-Touched）</strong>：<code>OrderType.LIMIT_IF_TOUCHED</code></li>
<li><strong>跟踪止损市价（Trailing Stop Market）</strong>：<code>OrderType.TRAILING_STOP_MARKET</code></li>
<li><strong>跟踪止损限价（Trailing Stop Limit）</strong>：<code>OrderType.TRAILING_STOP_LIMIT</code></li>
<li><strong>收盘市价（Market-on-Close）</strong>：使用 <code>OrderType.MARKET</code> 并配 <code>TimeInForce.AT_THE_CLOSE</code></li>
<li><strong>收盘限价（Limit-on-Close）</strong>：使用 <code>OrderType.LIMIT</code> 并配 <code>TimeInForce.AT_THE_CLOSE</code></li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="有效期time-in-force选项">有效期（Time in force）选项<a href="#有效期time-in-force选项" class="hash-link" aria-label="有效期（Time in force）选项的直接链接" title="有效期（Time in force）选项的直接链接" translate="no">​</a></h4>
<ul>
<li><strong>日内订单（Day Orders）</strong>：<code>TimeInForce.DAY</code></li>
<li><strong>直到撤销（Good-Till-Canceled）</strong>：<code>TimeInForce.GTC</code></li>
<li><strong>立即成交或取消（Immediate-or-Cancel）</strong>：<code>TimeInForce.IOC</code></li>
<li><strong>全部成交或取消（Fill-or-Kill）</strong>：<code>TimeInForce.FOK</code></li>
<li><strong>到期日有效（Good-Till-Date）</strong>：<code>TimeInForce.GTD</code></li>
<li><strong>日开盘（At-the-Open）</strong>：<code>TimeInForce.AT_THE_OPEN</code></li>
<li><strong>日收盘（At-the-Close）</strong>：<code>TimeInForce.AT_THE_CLOSE</code></li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="批量操作">批量操作<a href="#批量操作" class="hash-link" aria-label="批量操作的直接链接" title="批量操作的直接链接" translate="no">​</a></h4>
<table><thead><tr><th>Operation</th><th>Supported</th><th>Notes</th></tr></thead><tbody><tr><td>Batch Submit</td><td>✓</td><td>在单次请求中提交多笔订单</td></tr><tr><td>Batch Modify</td><td>✓</td><td>在单次请求中修改多笔订单</td></tr><tr><td>Batch Cancel</td><td>✓</td><td>在单次请求中撤销多笔订单</td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="持仓管理">持仓管理<a href="#持仓管理" class="hash-link" aria-label="持仓管理的直接链接" title="持仓管理的直接链接" translate="no">​</a></h4>
<table><thead><tr><th>Feature</th><th>Supported</th><th>Notes</th></tr></thead><tbody><tr><td>Query positions</td><td>✓</td><td>实时持仓查询</td></tr><tr><td>Position mode</td><td>✓</td><td>支持净头寸与多头/空头分离模式</td></tr><tr><td>Leverage control</td><td>✓</td><td>支持账户级别保证金控制</td></tr><tr><td>Margin mode</td><td>✓</td><td>支持组合与单合约保证金模式</td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="订单查询">订单查询<a href="#订单查询" class="hash-link" aria-label="订单查询的直接链接" title="订单查询的直接链接" translate="no">​</a></h4>
<table><thead><tr><th>Feature</th><th>Supported</th><th>Notes</th></tr></thead><tbody><tr><td>Query open orders</td><td>✓</td><td>列出所有活动订单</td></tr><tr><td>Query order history</td><td>✓</td><td>订单历史数据</td></tr><tr><td>Order status updates</td><td>✓</td><td>实时订单状态变更</td></tr><tr><td>Trade history</td><td>✓</td><td>执行与成交报告</td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="连带条件订单contingent-orders">连带/条件订单（Contingent orders）<a href="#连带条件订单contingent-orders" class="hash-link" aria-label="连带/条件订单（Contingent orders）的直接链接" title="连带/条件订单（Contingent orders）的直接链接" translate="no">​</a></h4>
<table><thead><tr><th>Feature</th><th>Supported</th><th>Notes</th></tr></thead><tbody><tr><td>Order lists</td><td>✓</td><td>原子化的多单一起提交（Order lists）</td></tr><tr><td>OCO orders</td><td>✓</td><td>支持 One-Cancels-Other，且可自定义 OCA 类型（1、2、3）</td></tr><tr><td>Bracket orders</td><td>✓</td><td>支持父子单（止盈/止损）</td></tr><tr><td>Conditional orders</td><td>✓</td><td>支持高级条件触发与取消</td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="基本的执行客户端配置">基本的执行客户端配置<a href="#基本的执行客户端配置" class="hash-link" aria-label="基本的执行客户端配置的直接链接" title="基本的执行客户端配置的直接链接" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive_brokers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> InteractiveBrokersExecClientConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> RoutingConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exec_client_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> InteractiveBrokersExecClientConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ibg_host</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;127.0.0.1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ibg_port</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7497</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># TWS paper trading port</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ibg_client_id</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    account_id</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;DU123456&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 你的 IB 账户 ID（测试或实盘）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instrument_provider</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">instrument_provider_config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    connection_timeout</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">300</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    routing</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">RoutingConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">default</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 将所有订单路由到此客户端</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="高级执行客户端配置生产">高级执行客户端配置（生产）<a href="#高级执行客户端配置生产" class="hash-link" aria-label="高级执行客户端配置（生产）的直接链接" title="高级执行客户端配置（生产）的直接链接" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 生产环境下使用 dockerized gateway 的配置示例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">production_exec_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> InteractiveBrokersExecClientConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ibg_host</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;127.0.0.1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ibg_port</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">4001</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># IB Gateway live trading port</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ibg_client_id</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    account_id</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 将使用环境变量 TWS_ACCOUNT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instrument_provider</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">instrument_provider_config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dockerized_gateway</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">dockerized_gateway_config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    connection_timeout</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">300</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    routing</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">RoutingConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">default</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="账户-idaccount-id配置">账户 ID（Account ID）配置<a href="#账户-idaccount-id配置" class="hash-link" aria-label="账户 ID（Account ID）配置的直接链接" title="账户 ID（Account ID）配置的直接链接" translate="no">​</a></h4>
<p><code>account_id</code> 参数非常重要，必须与 TWS/Gateway 中登录的账户一致：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 选项 1：在配置中直接指定</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exec_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> InteractiveBrokersExecClientConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    account_id</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;DU123456&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Paper trading 账户</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># ... 其它参数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 选项 2：使用环境变量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;TWS_ACCOUNT&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;DU123456&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exec_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> InteractiveBrokersExecClientConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    account_id</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 将使用 TWS_ACCOUNT 环境变量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># ... 其它参数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="订单标签与高级功能">订单标签与高级功能<a href="#订单标签与高级功能" class="hash-link" aria-label="订单标签与高级功能的直接链接" title="订单标签与高级功能的直接链接" translate="no">​</a></h4>
<p>适配器通过订单标签（order tags）支持 IB 特有的订单参数：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive_brokers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">common </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> IBOrderTags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 创建带有 IB 特定参数的标签</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">order_tags </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> IBOrderTags</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    allOrNone</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic"># 全部成交或撤销（AON）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ocaGroup</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;MyGroup1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># OCA 分组</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ocaType</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic"># Block 类型</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    activeStartTime</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;20240315 09:30:00 EST&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># GTC 激活时间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    activeStopTime</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;20240315 16:00:00 EST&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># GTC 停用时间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    goodAfterTime</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;20240315 09:35:00 EST&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Good after 时间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 将标签应用到订单</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">order </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> order_factory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">limit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instrument_id</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    order_side</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">OrderSide</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BUY</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    quantity</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">make_qty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    price</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">make_price</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">100.0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tags</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">order_tags</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="ocaone-cancels-all订单">OCA（one-cancels-all）订单<a href="#ocaone-cancels-all订单" class="hash-link" aria-label="OCA（one-cancels-all）订单的直接链接" title="OCA（one-cancels-all）订单的直接链接" translate="no">​</a></h4>
<p>适配器通过显式配置的 <code>IBOrderTags</code> 提供对 OCA 订单的完善支持：</p>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="基本-oca-配置">基本 OCA 配置<a href="#基本-oca-配置" class="hash-link" aria-label="基本 OCA 配置的直接链接" title="基本 OCA 配置的直接链接" translate="no">​</a></h3>
<p>所有 OCA 功能都必须通过 <code>IBOrderTags</code> 显式配置：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive_brokers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">common </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> IBOrderTags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 创建 OCA 配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">oca_tags </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> IBOrderTags</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ocaGroup</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;MY_OCA_GROUP&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ocaType</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 类型 1：Cancel All with Block（推荐）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 应用于挂单的止盈/止损</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bracket_order </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> order_factory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bracket</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instrument_id</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    order_side</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">OrderSide</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BUY</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    quantity</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">make_qty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tp_price</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">make_price</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">110.0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sl_trigger_price</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">make_price</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">90.0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tp_tags</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">oca_tags</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 必须显式添加 OCA 标签</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sl_tags</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">oca_tags</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 必须显式添加 OCA 标签</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="高级-oca-配置">高级 OCA 配置<a href="#高级-oca-配置" class="hash-link" aria-label="高级 OCA 配置的直接链接" title="高级 OCA 配置的直接链接" translate="no">​</a></h3>
<p>可以通过 <code>IBOrderTags</code> 指定不同的 OCA 类型与行为：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive_brokers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">common </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> IBOrderTags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 创建自定义 OCA 配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">custom_oca_tags </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> IBOrderTags</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ocaGroup</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;MY_CUSTOM_GROUP&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ocaType</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 使用类型 2：Reduce with Block</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 应用于单笔订单</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">order </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> order_factory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">limit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instrument_id</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    order_side</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">OrderSide</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BUY</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    quantity</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">make_qty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    price</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">make_price</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">100.0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tags</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">custom_oca_tags</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="oca-类型">OCA 类型<a href="#oca-类型" class="hash-link" aria-label="OCA 类型的直接链接" title="OCA 类型的直接链接" translate="no">​</a></h3>
<p>Interactive Brokers 支持三种 OCA 类型：</p>
<table><thead><tr><th>Type</th><th>Name</th><th>Behavior</th><th>Use Case</th></tr></thead><tbody><tr><td><strong>1</strong></td><td>Cancel All with Block</td><td>以 block 方式取消所有剩余订单</td><td><strong>默认</strong> - 最安全的选项，可防止过度成交</td></tr><tr><td><strong>2</strong></td><td>Reduce with Block</td><td>按比例减少剩余订单（带 block 保护）</td><td>部分成交时提供过度成交保护</td></tr><tr><td><strong>3</strong></td><td>Reduce without Block</td><td>按比例减少剩余订单（不带 block 保护）</td><td>执行速度最快，但存在较高的过度成交风险</td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="同一-oca-分组中的多笔订单">同一 OCA 分组中的多笔订单<a href="#同一-oca-分组中的多笔订单" class="hash-link" aria-label="同一 OCA 分组中的多笔订单的直接链接" title="同一 OCA 分组中的多笔订单的直接链接" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 使用相同 OCA 分组创建多笔订单</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">oca_tags </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> IBOrderTags</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ocaGroup</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;MULTI_ORDER_GROUP&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ocaType</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 使用类型 3：Reduce without Block</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">order1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> order_factory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">limit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instrument_id</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    order_side</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">OrderSide</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BUY</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    quantity</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">make_qty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">50</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    price</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">make_price</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">99.0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tags</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">oca_tags</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">order2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> order_factory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">limit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instrument_id</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    order_side</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">OrderSide</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BUY</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    quantity</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">make_qty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">50</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    price</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">make_price</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">101.0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tags</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">oca_tags</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="oca-配置要求">OCA 配置要求<a href="#oca-配置要求" class="hash-link" aria-label="OCA 配置要求的直接链接" title="OCA 配置要求的直接链接" translate="no">​</a></h3>
<p>OCA 功能<strong>仅</strong>通过显式配置可用：</p>
<ol>
<li><strong>需要 IBOrderTags</strong> - OCA 设置必须在订单标签中明确指定</li>
<li><strong>无自动检测</strong> - <code>ContingencyType.OCO</code> 和 <code>ContingencyType.OUO</code> 不会自动生成 OCA 分组</li>
<li><strong>手动配置</strong> - 所有 OCA 分组和类型均需手工指定</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="条件订单conditional-orders">条件订单（Conditional orders）<a href="#条件订单conditional-orders" class="hash-link" aria-label="条件订单（Conditional orders）的直接链接" title="条件订单（Conditional orders）的直接链接" translate="no">​</a></h3>
<p>适配器通过 <code>IBOrderTags</code> 的 <code>conditions</code> 参数支持 IB 的条件订单。条件订单允许在满足指定条件后再提交或取消订单。</p>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="支持的条件类型">支持的条件类型<a href="#支持的条件类型" class="hash-link" aria-label="支持的条件类型的直接链接" title="支持的条件类型的直接链接" translate="no">​</a></h4>
<ul>
<li><strong>价格条件（Price Conditions）</strong>：基于某合约价格触发</li>
<li><strong>时间条件（Time Conditions）</strong>：在指定日期时间触发</li>
<li><strong>成交量条件（Volume Conditions）</strong>：基于成交量阈值触发</li>
<li><strong>执行条件（Execution Conditions）</strong>：当指定合约发生成交时触发</li>
<li><strong>保证金条件（Margin Conditions）</strong>：基于账户保证金水平触发</li>
<li><strong>百分比变化条件（Percent Change Conditions）</strong>：基于价格百分比变动触发</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="基本条件单示例">基本条件单示例<a href="#基本条件单示例" class="hash-link" aria-label="基本条件单示例的直接链接" title="基本条件单示例的直接链接" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive_brokers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">common </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> IBOrderTags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 创建价格条件：当 SPY 超过 $250 时触发</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">price_condition </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;type&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;price&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;conId&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">265598</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># SPY 合约 ID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;exchange&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;SMART&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;isMore&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 当价格大于阈值时触发</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;price&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">250.00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;triggerMethod&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 默认触发方法</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;conjunction&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;and&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 创建带条件的订单标签</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">order_tags </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> IBOrderTags</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    conditions</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">price_condition</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    conditionsCancelOrder</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 条件满足时发送订单</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 应用于订单</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">order </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> order_factory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">limit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instrument_id</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    order_side</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">OrderSide</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BUY</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    quantity</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">make_qty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    price</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">make_price</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">251.00</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tags</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">order_tags</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="带逻辑的多条件示例">带逻辑的多条件示例<a href="#带逻辑的多条件示例" class="hash-link" aria-label="带逻辑的多条件示例的直接链接" title="带逻辑的多条件示例的直接链接" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 创建包含 AND/OR 逻辑的多个条件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">conditions </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;type&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;price&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;conId&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">265598</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;exchange&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;SMART&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;isMore&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;price&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">250.00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;triggerMethod&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;conjunction&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;and&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 与下一个条件为 AND</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;type&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;time&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;time&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;20250315-09:30:00&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;isMore&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;conjunction&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;or&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 与下一个条件为 OR</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;type&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;volume&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;conId&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">265598</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;exchange&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;SMART&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;isMore&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;volume&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10000000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;conjunction&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;and&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">order_tags </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> IBOrderTags</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    conditions</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">conditions</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    conditionsCancelOrder</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="条件参数说明">条件参数说明<a href="#条件参数说明" class="hash-link" aria-label="条件参数说明的直接链接" title="条件参数说明的直接链接" translate="no">​</a></h4>
<p><strong>价格条件（Price Condition）：</strong></p>
<ul>
<li><code>conId</code>：要监控的合约 ID</li>
<li><code>exchange</code>：要监控的交易所（例如：&quot;SMART&quot;, &quot;NASDAQ&quot;）</li>
<li><code>isMore</code>：True 表示 &gt;=，False 表示 &lt;=</li>
<li><code>price</code>：价格阈值</li>
<li><code>triggerMethod</code>：0=Default, 1=DoubleBidAsk, 2=Last, 3=DoubleLast, 4=BidAsk, 7=LastBidAsk, 8=MidPoint</li>
</ul>
<p><strong>时间条件（Time Condition）：</strong></p>
<ul>
<li><code>time</code>：UTC 格式的时间字符串 &quot;YYYYMMDD-HH:MM<!-- -->:SS<!-- -->&quot;（例如：&quot;20250315-09:30:00&quot;）</li>
<li><code>isMore</code>：True 表示在该时间之后触发，False 表示在该时间之前触发</li>
</ul>
<p><strong>成交量条件（Volume Condition）：</strong></p>
<ul>
<li><code>conId</code>：要监控的合约 ID</li>
<li><code>exchange</code>：要监控的交易所</li>
<li><code>isMore</code>：True 表示 &gt;=，False 表示 &lt;=</li>
<li><code>volume</code>：成交量阈值</li>
</ul>
<p><strong>执行条件（Execution Condition）：</strong></p>
<ul>
<li><code>symbol</code>：用于监控成交的标的符号</li>
<li><code>secType</code>：证券类型（例如：&quot;STK&quot;, &quot;OPT&quot;, &quot;FUT&quot;）</li>
<li><code>exchange</code>：要监控的交易所</li>
</ul>
<p><strong>保证金条件（Margin Condition）：</strong></p>
<ul>
<li><code>percent</code>：保证金余量百分比阈值</li>
<li><code>isMore</code>：True 表示 &gt;=，False 表示 &lt;=</li>
</ul>
<p><strong>百分比变化条件（Percent Change Condition）：</strong></p>
<ul>
<li><code>conId</code>：要监控的合约 ID</li>
<li><code>exchange</code>：要监控的交易所</li>
<li><code>isMore</code>：True 表示 &gt;=，False 表示 &lt;=</li>
<li><code>changePercent</code>：百分比变化阈值</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="完整示例包含所有条件类型">完整示例：包含所有条件类型<a href="#完整示例包含所有条件类型" class="hash-link" aria-label="完整示例：包含所有条件类型的直接链接" title="完整示例：包含所有条件类型的直接链接" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 演示所有 6 种支持的条件类型</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive_brokers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">common </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> IBOrderTags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 1. 价格条件 - 当 ES 期货 &gt; 6000 时触发</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">price_condition </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;type&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;price&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;conId&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">495512563</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># ES 期货合约 ID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;exchange&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CME&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;isMore&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;price&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6000.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;triggerMethod&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;conjunction&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;and&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 2. 时间条件 - 在指定时间触发</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">time_condition </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;type&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;time&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;time&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;20250315-09:30:00&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># UTC 格式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;isMore&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;conjunction&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;and&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 3. 成交量条件 - 成交量 &gt; 100,000 时触发</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">volume_condition </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;type&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;volume&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;conId&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">495512563</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;exchange&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CME&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;isMore&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;volume&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;conjunction&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;and&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 4. 执行条件 - 当 SPY 有成交时触发</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">execution_condition </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;type&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;execution&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;symbol&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;SPY&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;secType&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;STK&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;exchange&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;SMART&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;conjunction&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;and&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 5. 保证金条件 - 当保证金余量 &gt; 75% 时触发</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">margin_condition </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;type&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;margin&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;percent&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">75</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;isMore&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;conjunction&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;and&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 6. 百分比变化条件 - 当价格变化 &gt; 5% 时触发</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">percent_change_condition </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;type&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;percent_change&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;conId&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">495512563</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;exchange&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CME&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;changePercent&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;isMore&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;conjunction&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;and&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 可任意组合条件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">order_tags </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> IBOrderTags</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    conditions</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">price_condition</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> time_condition</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 多个条件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    conditionsCancelOrder</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 条件满足时发送订单</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="订单行为">订单行为<a href="#订单行为" class="hash-link" aria-label="订单行为的直接链接" title="订单行为的直接链接" translate="no">​</a></h4>
<p>设置 <code>conditionsCancelOrder</code> 来控制在条件满足时的行为：</p>
<ul>
<li><code>False</code>：当条件满足时发送（transmit）订单</li>
<li><code>True</code>：当条件满足时取消（cancel）订单</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="实现说明">实现说明<a href="#实现说明" class="hash-link" aria-label="实现说明的直接链接" title="实现说明的直接链接" translate="no">​</a></h4>
<ul>
<li><strong>全部 6 种条件类型均被完整支持</strong>，并已用 Interactive Brokers 的实盘订单进行了测试</li>
<li><strong>价格条件（Price conditions）</strong> 可以正常工作，尽管 ibapi 库中存在一个已知 bug：<code>PriceCondition.__str__</code> 被错误地作为 property 装饰</li>
<li><strong>时间条件（Time conditions）</strong> 使用带短横的 UTC 格式（<code>YYYYMMDD-HH:MM:SS</code>），以便可靠解析</li>
<li><strong>逻辑连接（conjunction logic）</strong> 支持使用 &quot;and&quot;/&quot;or&quot; 运算符组合复杂条件</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="完整交易节点配置">完整交易节点配置<a href="#完整交易节点配置" class="hash-link" aria-label="完整交易节点配置的直接链接" title="完整交易节点配置的直接链接" translate="no">​</a></h3>
<p>配置完整的交易环境需要创建一个包含所有必要组件的 <code>TradingNodeConfig</code>。下面给出不同场景的完整示例。</p>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="模拟纸面交易配置paper-trading">模拟/纸面交易配置（Paper trading）<a href="#模拟纸面交易配置paper-trading" class="hash-link" aria-label="模拟/纸面交易配置（Paper trading）的直接链接" title="模拟/纸面交易配置（Paper trading）的直接链接" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive_brokers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">common </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> IB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive_brokers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">common </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> IB_VENUE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive_brokers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> InteractiveBrokersDataClientConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive_brokers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> InteractiveBrokersExecClientConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive_brokers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> InteractiveBrokersInstrumentProviderConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive_brokers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> IBMarketDataTypeEnum</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive_brokers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> SymbologyMethod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive_brokers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">factories </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> InteractiveBrokersLiveDataClientFactory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive_brokers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">factories </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> InteractiveBrokersLiveExecClientFactory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> LiveDataEngineConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> LoggingConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> RoutingConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> TradingNodeConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">live</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">node </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> TradingNode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Instrument provider configuration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">instrument_provider_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> InteractiveBrokersInstrumentProviderConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    symbology_method</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">SymbologyMethod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IB_SIMPLIFIED</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    load_ids</span><span class="token operator" style="color:#393A34">=</span><span class="token builtin">frozenset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;EUR/USD.IDEALPRO&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;GBP/USD.IDEALPRO&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;SPY.ARCA&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;QQQ.NASDAQ&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;AAPL.NASDAQ&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;MSFT.NASDAQ&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Data client configuration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data_client_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> InteractiveBrokersDataClientConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ibg_host</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;127.0.0.1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ibg_port</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7497</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># TWS paper trading</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ibg_client_id</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    use_regular_trading_hours</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    market_data_type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">IBMarketDataTypeEnum</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DELAYED_FROZEN</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instrument_provider</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">instrument_provider_config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Execution client configuration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exec_client_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> InteractiveBrokersExecClientConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ibg_host</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;127.0.0.1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ibg_port</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7497</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># TWS paper trading</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ibg_client_id</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    account_id</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;DU123456&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Your paper trading account</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instrument_provider</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">instrument_provider_config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    routing</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">RoutingConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">default</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Trading node configuration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config_node </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> TradingNodeConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    trader_id</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;PAPER-TRADER-001&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logging</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">LoggingConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log_level</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;INFO&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data_clients</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">IB</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> data_client_config</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    exec_clients</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">IB</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> exec_client_config</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data_engine</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">LiveDataEngineConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        time_bars_timestamp_on_close</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># IB standard: use bar open time</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        validate_data_sequence</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic"># Discard out-of-sequence bars</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    timeout_connection</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">90.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    timeout_reconciliation</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">5.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    timeout_portfolio</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">5.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    timeout_disconnection</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">5.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    timeout_post_stop</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Create and configure the trading node</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> TradingNode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">config_node</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add_data_client_factory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">IB</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> InteractiveBrokersLiveDataClientFactory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add_exec_client_factory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">IB</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> InteractiveBrokersLiveExecClientFactory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">portfolio</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">set_specific_venue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">IB_VENUE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;__main__&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">try</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        node</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">finally</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        node</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dispose</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="使用-dockerized-gateway-的实盘交易">使用 Dockerized gateway 的实盘交易<a href="#使用-dockerized-gateway-的实盘交易" class="hash-link" aria-label="使用 Dockerized gateway 的实盘交易的直接链接" title="使用 Dockerized gateway 的实盘交易的直接链接" translate="no">​</a></h2>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive_brokers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> DockerizedIBGatewayConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Dockerized gateway configuration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dockerized_gateway_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> DockerizedIBGatewayConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    username</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;TWS_USERNAME&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    password</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;TWS_PASSWORD&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    trading_mode</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;live&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># &quot;paper&quot; or &quot;live&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    read_only_api</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Allow order execution</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    timeout</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">300</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Data client with dockerized gateway</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data_client_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> InteractiveBrokersDataClientConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ibg_client_id</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    use_regular_trading_hours</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Include extended hours</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    market_data_type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">IBMarketDataTypeEnum</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">REALTIME</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instrument_provider</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">instrument_provider_config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dockerized_gateway</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">dockerized_gateway_config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Execution client with dockerized gateway</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exec_client_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> InteractiveBrokersExecClientConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ibg_client_id</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    account_id</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;TWS_ACCOUNT&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Live account ID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instrument_provider</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">instrument_provider_config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dockerized_gateway</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">dockerized_gateway_config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    routing</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">RoutingConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">default</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Live trading node configuration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config_node </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> TradingNodeConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    trader_id</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;LIVE-TRADER-001&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logging</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">LoggingConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log_level</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;INFO&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data_clients</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">IB</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> data_client_config</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    exec_clients</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">IB</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> exec_client_config</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data_engine</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">LiveDataEngineConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        time_bars_timestamp_on_close</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        validate_data_sequence</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="多客户端配置multi-client-configuration">多客户端配置（Multi-client configuration）<a href="#多客户端配置multi-client-configuration" class="hash-link" aria-label="多客户端配置（Multi-client configuration）的直接链接" title="多客户端配置（Multi-client configuration）的直接链接" translate="no">​</a></h3>
<p>对于更高级的部署，可以为不同用途配置多个客户端：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Separate data and execution clients with different client IDs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data_client_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> InteractiveBrokersDataClientConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ibg_host</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;127.0.0.1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ibg_port</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7497</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ibg_client_id</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Data client uses ID 1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    market_data_type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">IBMarketDataTypeEnum</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">REALTIME</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instrument_provider</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">instrument_provider_config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exec_client_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> InteractiveBrokersExecClientConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ibg_host</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;127.0.0.1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ibg_port</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7497</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ibg_client_id</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Execution client uses ID 2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    account_id</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;DU123456&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instrument_provider</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">instrument_provider_config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    routing</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">RoutingConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">default</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="启动交易节点">启动交易节点<a href="#启动交易节点" class="hash-link" aria-label="启动交易节点的直接链接" title="启动交易节点的直接链接" translate="no">​</a></h3>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">run_trading_node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;以合适的错误处理方式运行交易节点。&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    node </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">try</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Create and build node</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        node </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> TradingNode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">config_node</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        node</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add_data_client_factory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">IB</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> InteractiveBrokersLiveDataClientFactory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        node</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add_exec_client_factory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">IB</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> InteractiveBrokersLiveExecClientFactory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        node</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Set venue for portfolio</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        node</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">portfolio</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">set_specific_venue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">IB_VENUE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Add your strategies here</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># node.trader.add_strategy(YourStrategy())</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Run the node</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        node</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">except</span><span class="token plain"> KeyboardInterrupt</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Shutting down...&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">except</span><span class="token plain"> Exception </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Error: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">e</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">finally</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> node</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            node</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dispose</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;__main__&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    run_trading_node</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="其他配置选项">其他配置选项<a href="#其他配置选项" class="hash-link" aria-label="其他配置选项的直接链接" title="其他配置选项的直接链接" translate="no">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="环境变量-1">环境变量<a href="#环境变量-1" class="hash-link" aria-label="环境变量的直接链接" title="环境变量的直接链接" translate="no">​</a></h4>
<p>为方便配置，可设置下列环境变量：</p>
<div class="language-bash codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-bash codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain"># 在 Windows PowerShell 中，使用 $env:TWS_USERNAME = &quot;your_ib_username&quot; 来设置临时环境变量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export TWS_USERNAME=&quot;your_ib_username&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export TWS_PASSWORD=&quot;your_ib_password&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export TWS_ACCOUNT=&quot;your_account_id&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export IB_MAX_CONNECTION_ATTEMPTS=&quot;5&quot;  # Optional: limit reconnection attempts</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="日志配置">日志配置<a href="#日志配置" class="hash-link" aria-label="日志配置的直接链接" title="日志配置的直接链接" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Enhanced logging configuration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">logging_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> LoggingConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log_level</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;INFO&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log_level_file</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;DEBUG&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log_file_format</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;json&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># JSON format for structured logging</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log_component_levels</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;InteractiveBrokersClient&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;DEBUG&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;InteractiveBrokersDataClient&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;INFO&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;InteractiveBrokersExecutionClient&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;INFO&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>你可以在这里找到更多示例: <a href="https://github.com/nautechsystems/nautilus_trader/tree/develop/examples/live/interactive_brokers" target="_blank" rel="noopener noreferrer">https://github.com/nautechsystems/nautilus_trader/tree/develop/examples/live/interactive_brokers</a></p>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="故障排查troubleshooting">故障排查（Troubleshooting）<a href="#故障排查troubleshooting" class="hash-link" aria-label="故障排查（Troubleshooting）的直接链接" title="故障排查（Troubleshooting）的直接链接" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="常见连接问题">常见连接问题<a href="#常见连接问题" class="hash-link" aria-label="常见连接问题的直接链接" title="常见连接问题的直接链接" translate="no">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="连接被拒绝connection-refused">连接被拒绝（Connection refused）<a href="#连接被拒绝connection-refused" class="hash-link" aria-label="连接被拒绝（Connection refused）的直接链接" title="连接被拒绝（Connection refused）的直接链接" translate="no">​</a></h4>
<ul>
<li><strong>原因</strong>：TWS/Gateway 未运行或端口错误</li>
<li><strong>解决办法</strong>：确认 TWS/Gateway 已启动并检查端口配置</li>
<li><strong>默认端口</strong>：TWS（7497/7496），IB Gateway（4002/4001）</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="认证错误authentication-errors">认证错误（Authentication errors）<a href="#认证错误authentication-errors" class="hash-link" aria-label="认证错误（Authentication errors）的直接链接" title="认证错误（Authentication errors）的直接链接" translate="no">​</a></h4>
<ul>
<li><strong>原因</strong>：凭证错误或账户未登录</li>
<li><strong>解决办法</strong>：确认用户名/密码并确保在 TWS/Gateway 中已登录该账户</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="客户端-id-冲突client-id-conflicts">客户端 ID 冲突（Client ID conflicts）<a href="#客户端-id-冲突client-id-conflicts" class="hash-link" aria-label="客户端 ID 冲突（Client ID conflicts）的直接链接" title="客户端 ID 冲突（Client ID conflicts）的直接链接" translate="no">​</a></h4>
<ul>
<li><strong>原因</strong>：多个客户端使用相同的 client ID</li>
<li><strong>解决办法</strong>：为每个连接使用唯一的 client ID</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="市场数据权限market-data-permissions">市场数据权限（Market data permissions）<a href="#市场数据权限market-data-permissions" class="hash-link" aria-label="市场数据权限（Market data permissions）的直接链接" title="市场数据权限（Market data permissions）的直接链接" translate="no">​</a></h4>
<ul>
<li><strong>原因</strong>：市场数据订阅不足</li>
<li><strong>解决办法</strong>：测试时可使用 <code>IBMarketDataTypeEnum.DELAYED_FROZEN</code>，或订阅所需的数据源</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="错误代码">错误代码<a href="#错误代码" class="hash-link" aria-label="错误代码的直接链接" title="错误代码的直接链接" translate="no">​</a></h3>
<p>Interactive Brokers 使用特定的错误代码。常见包括：</p>
<ul>
<li><strong>200</strong>：未找到证券定义（No security definition found）</li>
<li><strong>201</strong>：订单被拒绝 —— 原因随附（Order rejected - reason follows）</li>
<li><strong>202</strong>：订单已取消（Order cancelled）</li>
<li><strong>300</strong>：找不到带 ticker ID 的 EId（Can&#x27;t find EId with ticker ID）</li>
<li><strong>354</strong>：未订阅所请求的市场数据（Requested market data is not subscribed）</li>
<li><strong>2104</strong>：市场数据 farm 连接正常（Market data farm connection is OK）</li>
<li><strong>2106</strong>：HMDS 数据 farm 连接正常（HMDS data farm connection is OK）</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="性能优化">性能优化<a href="#性能优化" class="hash-link" aria-label="性能优化的直接链接" title="性能优化的直接链接" translate="no">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="降低数据量">降低数据量<a href="#降低数据量" class="hash-link" aria-label="降低数据量的直接链接" title="降低数据量的直接链接" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Reduce quote tick volume by ignoring size-only updates</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> InteractiveBrokersDataClientConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ignore_quote_tick_size_updates</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># ... other config</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="连接管理-1">连接管理<a href="#连接管理-1" class="hash-link" aria-label="连接管理的直接链接" title="连接管理的直接链接" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Set reasonable timeouts</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> InteractiveBrokersDataClientConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    connection_timeout</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">300</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 5 minutes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    request_timeout</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">60</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># 1 minute</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># ... other config</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="内存管理">内存管理<a href="#内存管理" class="hash-link" aria-label="内存管理的直接链接" title="内存管理的直接链接" translate="no">​</a></h4>
<ul>
<li>使用适合策略的 bar 大小</li>
<li>限制同时订阅的数量</li>
<li>对于回测，考虑使用历史数据代替实时数据</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="最佳实践">最佳实践<a href="#最佳实践" class="hash-link" aria-label="最佳实践的直接链接" title="最佳实践的直接链接" translate="no">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="安全">安全<a href="#安全" class="hash-link" aria-label="安全的直接链接" title="安全的直接链接" translate="no">​</a></h4>
<ul>
<li>切勿在源码中硬编码凭证</li>
<li>使用环境变量存放敏感信息</li>
<li>开发与测试优先使用 paper trading</li>
<li>对于仅获取数据的应用，设置 <code>read_only_api=True</code></li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="开发流程">开发流程<a href="#开发流程" class="hash-link" aria-label="开发流程的直接链接" title="开发流程的直接链接" translate="no">​</a></h4>
<ol>
<li><strong>从 Paper Trading 开始</strong>：先在纸面账户完成测试</li>
<li><strong>使用延迟数据（Delayed Data）</strong>：开发时使用 <code>DELAYED_FROZEN</code> 市场数据</li>
<li><strong>实现良好的错误处理</strong>：优雅处理连接中断与 API 错误</li>
<li><strong>监控日志</strong>：开启合适的日志级别以便调试</li>
<li><strong>测试重连</strong>：检验策略在断线重连时的表现</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="生产部署">生产部署<a href="#生产部署" class="hash-link" aria-label="生产部署的直接链接" title="生产部署的直接链接" translate="no">​</a></h4>
<ul>
<li>使用 dockerized gateway 进行自动化部署</li>
<li>实施完备的监控与告警</li>
<li>配置日志聚合与分析</li>
<li>仅在必要时使用实时数据订阅</li>
<li>实施熔断器与持仓限制</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="订单管理">订单管理<a href="#订单管理" class="hash-link" aria-label="订单管理的直接链接" title="订单管理的直接链接" translate="no">​</a></h4>
<ul>
<li>提交订单前务必进行校验</li>
<li>实现合理的仓位规模控制</li>
<li>根据策略选择合适的订单类型</li>
<li>监控订单状态并处理拒单情况</li>
<li>对订单操作实现超时处理</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="调试建议">调试建议<a href="#调试建议" class="hash-link" aria-label="调试建议的直接链接" title="调试建议的直接链接" translate="no">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="启用调试日志">启用调试日志<a href="#启用调试日志" class="hash-link" aria-label="启用调试日志的直接链接" title="启用调试日志的直接链接" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">logging_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> LoggingConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log_level</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;DEBUG&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log_component_levels</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;InteractiveBrokersClient&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;DEBUG&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="监控连接状态">监控连接状态<a href="#监控连接状态" class="hash-link" aria-label="监控连接状态的直接链接" title="监控连接状态的直接链接" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Check connection status in your strategy</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data_client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_connected</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">warning</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Data client disconnected&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="验证合约品种">验证合约/品种<a href="#验证合约品种" class="hash-link" aria-label="验证合约/品种的直接链接" title="验证合约/品种的直接链接" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Ensure instruments are loaded before trading</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">instruments </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">instruments</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> instruments</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;No instruments loaded&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="支持与资源">支持与资源<a href="#支持与资源" class="hash-link" aria-label="支持与资源的直接链接" title="支持与资源的直接链接" translate="no">​</a></h3>
<ul>
<li><strong>IB API Documentation</strong>: <a href="https://ibkrcampus.com/ibkr-api-page/trader-workstation-api/" target="_blank" rel="noopener noreferrer">TWS API Guide</a></li>
<li><strong>NautilusTrader Examples</strong>: <a href="https://github.com/nautechsystems/nautilus_trader/tree/develop/examples/live/interactive_brokers" target="_blank" rel="noopener noreferrer">GitHub Examples</a></li>
<li><strong>IB Contract Search</strong>: <a href="https://pennies.interactivebrokers.com/cstools/contract_info/" target="_blank" rel="noopener noreferrer">Contract Information Center</a></li>
<li><strong>Market Data Subscriptions</strong>: <a href="https://www.interactivebrokers.com/en/trading/market-data.php" target="_blank" rel="noopener noreferrer">IB Market Data</a></li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/Aloento/NautilusTraderDoc/tree/main/docs/integrations/ib.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_F7ru" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_GNoA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/integrations/hyperliquid"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">Hyperliquid</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/integrations/okx"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">OKX</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_pg_n thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#安装" class="table-of-contents__link toc-highlight">安装</a></li><li><a href="#示例" class="table-of-contents__link toc-highlight">示例</a></li><li><a href="#快速上手" class="table-of-contents__link toc-highlight">快速上手</a><ul><li><a href="#连接方式" class="table-of-contents__link toc-highlight">连接方式</a></li><li><a href="#默认端口" class="table-of-contents__link toc-highlight">默认端口</a></li><li><a href="#连接到已有的-gateway-或-tws" class="table-of-contents__link toc-highlight">连接到已有的 Gateway 或 TWS</a></li><li><a href="#使用-docker-化的-ib-gateway" class="table-of-contents__link toc-highlight">使用 Docker 化的 IB Gateway</a></li><li><a href="#环境变量" class="table-of-contents__link toc-highlight">环境变量</a></li><li><a href="#连接管理" class="table-of-contents__link toc-highlight">连接管理</a></li></ul></li><li><a href="#概览" class="table-of-contents__link toc-highlight">概览</a><ul><li><a href="#核心组件" class="table-of-contents__link toc-highlight">核心组件</a></li><li><a href="#支持组件" class="table-of-contents__link toc-highlight">支持组件</a></li><li><a href="#支持的资产类别" class="table-of-contents__link toc-highlight">支持的资产类别</a></li></ul></li><li><a href="#interactive-brokers-客户端" class="table-of-contents__link toc-highlight">Interactive Brokers 客户端</a><ul><li><a href="#客户端架构" class="table-of-contents__link toc-highlight">客户端架构</a></li><li><a href="#主要特性" class="table-of-contents__link toc-highlight">主要特性</a></li></ul></li><li><a href="#标识符symbology" class="table-of-contents__link toc-highlight">标识符（Symbology）</a><ul><li><a href="#标识符方法" class="table-of-contents__link toc-highlight">标识符方法</a></li><li><a href="#mic-交易所代码转换" class="table-of-contents__link toc-highlight">MIC 交易所代码转换</a></li><li><a href="#支持的合约格式" class="table-of-contents__link toc-highlight">支持的合约格式</a></li><li><a href="#如何选择合适的标识方法" class="table-of-contents__link toc-highlight">如何选择合适的标识方法</a></li></ul></li><li><a href="#合约instruments与-contract" class="table-of-contents__link toc-highlight">合约（Instruments）与 Contract</a><ul><li><a href="#合约类型" class="table-of-contents__link toc-highlight">合约类型</a></li><li><a href="#合约查询" class="table-of-contents__link toc-highlight">合约查询</a></li><li><a href="#加载合约" class="table-of-contents__link toc-highlight">加载合约</a></li><li><a href="#按资产类别的-ibcontract-示例" class="table-of-contents__link toc-highlight">按资产类别的 <code>IBContract</code> 示例</a></li><li><a href="#高级配置选项" class="table-of-contents__link toc-highlight">高级配置选项</a></li><li><a href="#连续期货continuous-futures" class="table-of-contents__link toc-highlight">连续期货（Continuous futures）</a></li></ul></li><li><a href="#期权价差option-spreads" class="table-of-contents__link toc-highlight">期权价差（Option spreads）</a><ul><li><a href="#创建期权价差的-instrumentid" class="table-of-contents__link toc-highlight">创建期权价差的 InstrumentId</a></li><li><a href="#动态加载价差" class="table-of-contents__link toc-highlight">动态加载价差</a></li><li><a href="#价差交易要求" class="table-of-contents__link toc-highlight">价差交易要求</a></li></ul></li><li><a href="#历史数据与回测" class="table-of-contents__link toc-highlight">历史数据与回测</a><ul><li><a href="#支持的数据类型" class="table-of-contents__link toc-highlight">支持的数据类型</a></li><li><a href="#历史数据客户端" class="table-of-contents__link toc-highlight">历史数据客户端</a></li><li><a href="#获取合约信息" class="table-of-contents__link toc-highlight">获取合约信息</a></li><li><a href="#请求历史-k-线" class="table-of-contents__link toc-highlight">请求历史 K 线</a></li><li><a href="#请求历史逐笔" class="table-of-contents__link toc-highlight">请求历史逐笔</a></li><li><a href="#k-线规格" class="table-of-contents__link toc-highlight">K 线规格</a></li><li><a href="#完整示例" class="table-of-contents__link toc-highlight">完整示例</a></li><li><a href="#数据限制" class="table-of-contents__link toc-highlight">数据限制</a></li><li><a href="#推荐最佳实践" class="table-of-contents__link toc-highlight">推荐最佳实践</a></li></ul></li><li><a href="#实盘交易" class="table-of-contents__link toc-highlight">实盘交易</a><ul><li><a href="#架构概览" class="table-of-contents__link toc-highlight">架构概览</a></li><li><a href="#instrumentprovider-配置" class="table-of-contents__link toc-highlight">InstrumentProvider 配置</a></li><li><a href="#与外部数据提供方集成" class="table-of-contents__link toc-highlight">与外部数据提供方集成</a></li><li><a href="#数据客户端配置" class="table-of-contents__link toc-highlight">数据客户端配置</a></li><li><a href="#数据客户端配置选项" class="table-of-contents__link toc-highlight">数据客户端配置选项</a></li><li><a href="#执行客户端execution-client配置选项" class="table-of-contents__link toc-highlight">执行客户端（Execution client）配置选项</a></li><li><a href="#执行客户端配置" class="table-of-contents__link toc-highlight">执行客户端配置</a></li><li><a href="#基本-oca-配置" class="table-of-contents__link toc-highlight">基本 OCA 配置</a></li><li><a href="#高级-oca-配置" class="table-of-contents__link toc-highlight">高级 OCA 配置</a></li><li><a href="#oca-类型" class="table-of-contents__link toc-highlight">OCA 类型</a></li><li><a href="#oca-配置要求" class="table-of-contents__link toc-highlight">OCA 配置要求</a></li><li><a href="#条件订单conditional-orders" class="table-of-contents__link toc-highlight">条件订单（Conditional orders）</a></li><li><a href="#完整交易节点配置" class="table-of-contents__link toc-highlight">完整交易节点配置</a></li></ul></li><li><a href="#使用-dockerized-gateway-的实盘交易" class="table-of-contents__link toc-highlight">使用 Dockerized gateway 的实盘交易</a><ul><li><a href="#多客户端配置multi-client-configuration" class="table-of-contents__link toc-highlight">多客户端配置（Multi-client configuration）</a></li><li><a href="#启动交易节点" class="table-of-contents__link toc-highlight">启动交易节点</a></li><li><a href="#其他配置选项" class="table-of-contents__link toc-highlight">其他配置选项</a></li></ul></li><li><a href="#故障排查troubleshooting" class="table-of-contents__link toc-highlight">故障排查（Troubleshooting）</a><ul><li><a href="#常见连接问题" class="table-of-contents__link toc-highlight">常见连接问题</a></li><li><a href="#错误代码" class="table-of-contents__link toc-highlight">错误代码</a></li><li><a href="#性能优化" class="table-of-contents__link toc-highlight">性能优化</a></li><li><a href="#最佳实践" class="table-of-contents__link toc-highlight">最佳实践</a></li><li><a href="#调试建议" class="table-of-contents__link toc-highlight">调试建议</a></li><li><a href="#支持与资源" class="table-of-contents__link toc-highlight">支持与资源</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 NautilusTrader Documentation.</div></div></div></footer></div>
</body>
</html>