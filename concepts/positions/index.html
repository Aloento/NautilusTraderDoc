<!doctype html>
<html lang="zh" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-concepts/positions" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.1">
<title data-rh="true">持仓 | NautilusTrader 文档</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://nautilus.aloen.to/concepts/positions"><meta data-rh="true" property="og:locale" content="zh"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="持仓 | NautilusTrader 文档"><meta data-rh="true" name="description" content="本文档介绍 NautilusTrader 中持仓的工作原理，包括持仓生命周期、从成交（fills）聚合、盈亏（PnL）计算，以及在 NETTING 类型 OMS 配置下用于保留历史状态的重要机制——持仓快照（position snapshotting）。"><meta data-rh="true" property="og:description" content="本文档介绍 NautilusTrader 中持仓的工作原理，包括持仓生命周期、从成交（fills）聚合、盈亏（PnL）计算，以及在 NETTING 类型 OMS 配置下用于保留历史状态的重要机制——持仓快照（position snapshotting）。"><link data-rh="true" rel="icon" href="/logo.png"><link data-rh="true" rel="canonical" href="https://nautilus.aloen.to/concepts/positions"><link data-rh="true" rel="alternate" href="https://nautilus.aloen.to/concepts/positions" hreflang="zh"><link data-rh="true" rel="alternate" href="https://nautilus.aloen.to/concepts/positions" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"概念","item":"https://nautilus.aloen.to/concepts/"},{"@type":"ListItem","position":2,"name":"持仓","item":"https://nautilus.aloen.to/concepts/positions"}]}</script><link rel="stylesheet" href="/assets/css/styles.33db920f.css">
<script src="/assets/js/runtime~main.d37f7723.js" defer="defer"></script>
<script src="/assets/js/main.3352860b.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/logo.png"><div role="region" aria-label="跳到主要内容"><a class="skipToContent__uWo" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/logo.png" alt="NautilusTrader Logo" class="themedComponent_WkLn themedComponent--light_cjoX"><img src="/logo.png" alt="NautilusTrader Logo" class="themedComponent_WkLn themedComponent--dark_jZId"></div><b class="navbar__title text--truncate">NautilusTrader</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/api_reference/">文档</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/Aloento/NautilusTraderDoc" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_KfBJ"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_RWFU colorModeToggle_sA1q"><button class="clean-btn toggleButton_qjfc toggleButtonDisabled_cpNp" type="button" disabled="" title="system mode" aria-label="切换浅色/暗黑模式（当前为system mode）"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_CetX lightToggleIcon_UYsV"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_CetX darkToggleIcon_i1s2"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_CetX systemToggleIcon_yIQx"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_PsjF"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_jk42"><div class="docsWrapper_KWBO"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_XpKL" type="button"></button><div class="docRoot_joIP"><aside class="theme-doc-sidebar-container docSidebarContainer_DOen"><div class="sidebarViewport_j7YP"><div class="sidebar_nPgc"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_MTDt"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_GgI9 menu__link menu__link--sublist" href="/api_reference/"><span title="Python API" class="categoryLinkLabel_XKxb">Python API</span></a><button aria-label="展开侧边栏分类 &#x27;Python API&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_GgI9 menu__link menu__link--sublist menu__link--active" href="/concepts/"><span title="概念" class="categoryLinkLabel_XKxb">概念</span></a><button aria-label="折叠侧边栏分类 &#x27;概念&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/actors"><span title="Actors" class="linkLabel_CNtA">Actors</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/adapters"><span title="适配器" class="linkLabel_CNtA">适配器</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/architecture"><span title="架构" class="linkLabel_CNtA">架构</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/backtesting"><span title="回测" class="linkLabel_CNtA">回测</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/cache"><span title="Cache" class="linkLabel_CNtA">Cache</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/data"><span title="数据" class="linkLabel_CNtA">数据</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/execution"><span title="执行" class="linkLabel_CNtA">执行</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/instruments"><span title="合约与交易品种" class="linkLabel_CNtA">合约与交易品种</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/live"><span title="Live 交易" class="linkLabel_CNtA">Live 交易</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/logging"><span title="日志" class="linkLabel_CNtA">日志</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/message_bus"><span title="消息总线" class="linkLabel_CNtA">消息总线</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/orders"><span title="订单" class="linkLabel_CNtA">订单</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/overview"><span title="概览" class="linkLabel_CNtA">概览</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/portfolio"><span title="投资组合" class="linkLabel_CNtA">投资组合</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/concepts/positions"><span title="持仓" class="linkLabel_CNtA">持仓</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/reports"><span title="报告" class="linkLabel_CNtA">报告</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/strategies"><span title="策略" class="linkLabel_CNtA">策略</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_GgI9 menu__link menu__link--sublist" href="/developer_guide/"><span title="开发者指南" class="categoryLinkLabel_XKxb">开发者指南</span></a><button aria-label="展开侧边栏分类 &#x27;开发者指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_GgI9 menu__link menu__link--sublist" href="/getting_started/"><span title="入门" class="categoryLinkLabel_XKxb">入门</span></a><button aria-label="展开侧边栏分类 &#x27;入门&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_GgI9 menu__link menu__link--sublist" href="/integrations/"><span title="集成" class="categoryLinkLabel_XKxb">集成</span></a><button aria-label="展开侧边栏分类 &#x27;集成&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_GgI9 menu__link menu__link--sublist" href="/tutorials/"><span title="教程" class="categoryLinkLabel_XKxb">教程</span></a><button aria-label="展开侧边栏分类 &#x27;教程&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_bw1l"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_PIhC"><div class="docItemContainer_pFw3"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_HRKZ" aria-label="页面路径"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_sX5c"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/concepts/"><span>概念</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">持仓</span></li></ul></nav><div class="tocCollapsible_DhUt theme-doc-toc-mobile tocMobile_Izjv"><button type="button" class="clean-btn tocCollapsibleButton_eYR5">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>持仓</h1></header>
<p>本文档介绍 NautilusTrader 中持仓的工作原理，包括持仓生命周期、从成交（fills）聚合、盈亏（PnL）计算，以及在 NETTING 类型 OMS 配置下用于保留历史状态的重要机制——持仓快照（position snapshotting）。</p>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="概述">概述<a href="#概述" class="hash-link" aria-label="概述的直接链接" title="概述的直接链接" translate="no">​</a></h2>
<p>持仓表示在某一交易工具（instrument）上的未平仓暴露。持仓用于汇总该工具的所有成交记录，并持续计算未实现盈亏、平均开仓价与当前敞口等关键指标，因此是追踪交易绩效与风险的核心对象。</p>
<p>系统在订单成交时自动创建持仓并跟踪其从打开到关闭的整个过程。平台通过 OMS（Order Management System）配置支持两种主要的持仓管理方式：NETTING（净额合并）和 HEDGING（对冲/独立持仓）。</p>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="持仓生命周期">持仓生命周期<a href="#持仓生命周期" class="hash-link" aria-label="持仓生命周期的直接链接" title="持仓生命周期的直接链接" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="创建">创建<a href="#创建" class="hash-link" aria-label="创建的直接链接" title="创建的直接链接" translate="no">​</a></h3>
<p>在首次成交时创建持仓：</p>
<ul>
<li><strong>NETTING OMS</strong>：对每个交易工具在首次成交时创建一个持仓（每个 instrument 一条持仓）。</li>
<li><strong>HEDGING OMS</strong>：在出现新的 <code>position_id</code> 时创建持仓（同一 instrument 可存在多条持仓）。</li>
</ul>
<p>持仓会记录：</p>
<ul>
<li>开仓的订单和成交详情。</li>
<li>持仓方向（<code>LONG</code> 或 <code>SHORT</code>）。</li>
<li>初始数量与平均价格。</li>
<li>初始化与开仓的时间戳。</li>
</ul>
<p>提示：在 actor/strategy 内可以通过缓存访问持仓，例如 <code>self.cache.position(position_id)</code> 或 <code>self.cache.positions(instrument_id=instrument_id)</code>。</p>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="更新">更新<a href="#更新" class="hash-link" aria-label="更新的直接链接" title="更新的直接链接" translate="no">​</a></h3>
<p>当后续发生更多成交时，持仓会：</p>
<ul>
<li>聚合买卖成交的数量。</li>
<li>重新计算开仓与平仓的平均价格。</li>
<li>更新峰值数量（历史上达到的最大敞口）。</li>
<li>跟踪所有相关的订单 ID 与成交（trade）ID。</li>
<li>按币种累计手续费（commissions）。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="关闭">关闭<a href="#关闭" class="hash-link" aria-label="关闭的直接链接" title="关闭的直接链接" translate="no">​</a></h3>
<p>当净持仓数量变为零（<code>FLAT</code>）时，持仓被视为已关闭。关闭时：</p>
<ul>
<li>记录关闭订单 ID。</li>
<li>计算从开仓到关闭的持续时间。</li>
<li>计算最终的已实现盈亏（realized PnL）。</li>
<li>在 <code>NETTING</code> OMS 下，执行引擎会通过快照保留已关闭持仓的状态以维护历史 PnL（见“持仓快照”一节）。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="成交聚合order-fill-aggregation">成交聚合（Order fill aggregation）<a href="#成交聚合order-fill-aggregation" class="hash-link" aria-label="成交聚合（Order fill aggregation）的直接链接" title="成交聚合（Order fill aggregation）的直接链接" translate="no">​</a></h2>
<p>持仓通过聚合成交记录来保持对市场敞口的准确视图。该聚合过程同时处理买卖双方的成交活动：</p>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="买入成交buy-fills">买入成交（Buy fills）<a href="#买入成交buy-fills" class="hash-link" aria-label="买入成交（Buy fills）的直接链接" title="买入成交（Buy fills）的直接链接" translate="no">​</a></h3>
<p>当发生 BUY 成交时：</p>
<ul>
<li>增加多头敞口或减少空头敞口。</li>
<li>对开仓部分更新平均开仓价（avg entry price）。</li>
<li>对平仓部分更新平均平仓价（avg exit price）。</li>
<li>计算任何被平仓部分的已实现盈亏。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="卖出成交sell-fills">卖出成交（Sell fills）<a href="#卖出成交sell-fills" class="hash-link" aria-label="卖出成交（Sell fills）的直接链接" title="卖出成交（Sell fills）的直接链接" translate="no">​</a></h3>
<p>当发生 SELL 成交时：</p>
<ul>
<li>增加空头敞口或减少多头敞口。</li>
<li>对开仓部分更新平均开仓价。</li>
<li>对平仓部分更新平均平仓价。</li>
<li>计算任何被平仓部分的已实现盈亏。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="净持仓计算">净持仓计算<a href="#净持仓计算" class="hash-link" aria-label="净持仓计算的直接链接" title="净持仓计算的直接链接" translate="no">​</a></h3>
<p>持仓维护一个 <code>signed_qty</code> 字段来表示净敞口：</p>
<ul>
<li>正值表示 <code>LONG</code>（多头）。</li>
<li>负值表示 <code>SHORT</code>（空头）。</li>
<li>零表示 <code>FLAT</code>（无持仓，已平仓）。</li>
</ul>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 示例：持仓聚合</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 首次 BUY 100 手，价格 $50</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">signed_qty </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">100</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 多头</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 后续 SELL 150 手，价格 $55</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">signed_qty </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">50</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># 现在变为空头</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 最后 BUY 50 手，价格 $52</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">signed_qty </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic"># 持仓平仓（FLAT）</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="oms-类型与持仓管理">OMS 类型与持仓管理<a href="#oms-类型与持仓管理" class="hash-link" aria-label="OMS 类型与持仓管理的直接链接" title="OMS 类型与持仓管理的直接链接" translate="no">​</a></h2>
<p>NautilusTrader 支持两种主要的 OMS 类型，它们显著影响持仓的跟踪与管理方式。另有 <code>OmsType.UNSPECIFIED</code> 选项，会采用组件上下文的默认设置。更多细节见 <a href="/concepts/execution#order-management-system-oms">Execution guide</a>。</p>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="netting"><code>NETTING</code><a href="#netting" class="hash-link" aria-label="netting的直接链接" title="netting的直接链接" translate="no">​</a></h3>
<p>在 <code>NETTING</code> 模式下，同一交易工具的所有成交都会聚合到一个持仓：</p>
<ul>
<li>每个 instrument ID 仅有一条持仓。</li>
<li>所有成交都会计入同一持仓。</li>
<li>随着净数量变化，持仓可能在 <code>LONG</code> 与 <code>SHORT</code> 之间反向。</li>
<li>已关闭的持仓状态通过历史快照得到保留。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="hedging"><code>HEDGING</code><a href="#hedging" class="hash-link" aria-label="hedging的直接链接" title="hedging的直接链接" translate="no">​</a></h3>
<p>在 <code>HEDGING</code> 模式下，同一交易工具可以存在多条持仓：</p>
<ul>
<li>可以同时存在多条 <code>LONG</code> 与 <code>SHORT</code> 持仓。</li>
<li>每条持仓都有唯一的 position ID。</li>
<li>各持仓独立跟踪。</li>
<li>不会自动在持仓间进行净额合并（netting）。</li>
</ul>
<p>警告：使用 <code>HEDGING</code> 模式时需注意保证金要求会增加，因为每条持仓独立占用保证金。部分交易场所可能并不支持真正的 hedging，会在场内自动进行 netting。</p>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="策略层-vs-场所venue-oms">策略层 vs 场所（venue） OMS<a href="#策略层-vs-场所venue-oms" class="hash-link" aria-label="策略层 vs 场所（venue） OMS的直接链接" title="策略层 vs 场所（venue） OMS的直接链接" translate="no">​</a></h3>
<p>平台允许策略与场所使用不同的 OMS 配置：</p>
<table><thead><tr><th>Strategy OMS</th><th>Venue OMS</th><th>行为说明</th></tr></thead><tbody><tr><td><code>NETTING</code></td><td><code>NETTING</code></td><td>策略和场所层面在每个 instrument 上均为单一持仓</td></tr><tr><td><code>HEDGING</code></td><td><code>HEDGING</code></td><td>两层均支持多条持仓</td></tr><tr><td><code>NETTING</code></td><td><code>HEDGING</code></td><td>场所层面维护多条持仓，Nautilus 在策略层维持单一虚拟持仓</td></tr><tr><td><code>HEDGING</code></td><td><code>NETTING</code></td><td>场所层面为单一持仓，Nautilus 在策略层维护虚拟多持仓</td></tr></tbody></table>
<p>提示：对于大多数交易场景，策略层与场所层保持 OMS 类型一致会简化持仓管理。只有在做自营交易台（prop desk）或与遗留系统对接时才常见需要覆盖配置。详情见 <a href="/concepts/live">Live guide</a>。</p>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="持仓快照position-snapshotting">持仓快照（Position snapshotting）<a href="#持仓快照position-snapshotting" class="hash-link" aria-label="持仓快照（Position snapshotting）的直接链接" title="持仓快照（Position snapshotting）的直接链接" translate="no">​</a></h2>
<p>持仓快照是 <code>NETTING</code> OMS 配置下的重要机制，用于在持仓关闭后保留其历史状态，从而确保 PnL 汇总与报告的准确性。</p>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="为什么需要快照">为什么需要快照<a href="#为什么需要快照" class="hash-link" aria-label="为什么需要快照的直接链接" title="为什么需要快照的直接链接" translate="no">​</a></h3>
<p>在 <code>NETTING</code> 系统中，当持仓关闭（变为 <code>FLAT</code>）后如果再次对同一工具开仓，原有的持仓对象会被重置以跟踪新的敞口。若不保存快照，之前周期的已实现 PnL 将丢失。</p>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="工作原理">工作原理<a href="#工作原理" class="hash-link" aria-label="工作原理的直接链接" title="工作原理的直接链接" translate="no">​</a></h3>
<p>当 <code>NETTING</code> 持仓关闭并随后对同一 instrument 有新的成交时，执行引擎会在重置持仓前对已关闭的持仓状态进行快照，保留：</p>
<ul>
<li>最终的数量与价格信息。</li>
<li>已实现的 PnL。</li>
<li>所有的成交事件（fill events）。</li>
<li>手续费总额。</li>
</ul>
<p>这些快照会按 position ID 存入缓存（cache）。随后持仓对象会重置用于记录新一轮周期，但历史快照仍然可访问。Portfolio 会将所有快照的 PnL 汇总，确保总计正确。</p>
<p>注意：此处的历史快照机制不同于可选的周期性持仓状态快照（<code>snapshot_positions</code>），后者用于遥测（telemetry）定期记录当前持仓状态。有关 <code>snapshot_positions</code> 与 <code>snapshot_positions_interval_secs</code> 的设置请参见 <a href="/concepts/live">Live guide</a>。</p>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="示例场景">示例场景<a href="#示例场景" class="hash-link" aria-label="示例场景的直接链接" title="示例场景的直接链接" translate="no">​</a></h3>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># NETTING OMS 示例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 第 1 周期：开多头</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BUY </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"> units at $</span><span class="token number" style="color:#36acaa">50</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># 持仓打开</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SELL </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"> units at $</span><span class="token number" style="color:#36acaa">55</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 持仓关闭，PnL = $500</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 引擎对该周期做快照，保留 $500 的已实现 PnL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 第 2 周期：开空头</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SELL </span><span class="token number" style="color:#36acaa">50</span><span class="token plain"> units at $</span><span class="token number" style="color:#36acaa">54</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># 持仓重新打开（空头）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BUY </span><span class="token number" style="color:#36acaa">50</span><span class="token plain"> units at $</span><span class="token number" style="color:#36acaa">52</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 持仓关闭，PnL = $100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 引擎对该周期做快照，保留 $100 的已实现 PnL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 总已实现 PnL = $500 + $100 = $600（来自所有快照）</span><br></span></code></pre></div></div>
<p>若无快照机制，只有最近一轮周期的 PnL 可用，从而导致错误的汇报与分析。</p>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="盈亏pnl计算">盈亏（PnL）计算<a href="#盈亏pnl计算" class="hash-link" aria-label="盈亏（PnL）计算的直接链接" title="盈亏（PnL）计算的直接链接" translate="no">​</a></h2>
<p>NautilusTrader 提供全面的 PnL 计算，兼顾不同合约类型和市场惯例。</p>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="已实现盈亏realized-pnl">已实现盈亏（Realized PnL）<a href="#已实现盈亏realized-pnl" class="hash-link" aria-label="已实现盈亏（Realized PnL）的直接链接" title="已实现盈亏（Realized PnL）的直接链接" translate="no">​</a></h3>
<p>在持仓部分或全部被平仓时计算已实现盈亏：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 对于常规合约</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">realized_pnl </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exit_price </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> entry_price</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> closed_quantity </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> multiplier</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 对于反向合约（inverse instruments，需考虑方向）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 多头（LONG）： realized_pnl = closed_quantity * multiplier * (1/entry_price - 1/exit_price)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 空头（SHORT）： realized_pnl = closed_quantity * multiplier * (1/exit_price - 1/entry_price)</span><br></span></code></pre></div></div>
<p>引擎会根据持仓方向自动应用恰当的计算公式。</p>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="未实现盈亏unrealized-pnl">未实现盈亏（Unrealized PnL）<a href="#未实现盈亏unrealized-pnl" class="hash-link" aria-label="未实现盈亏（Unrealized PnL）的直接链接" title="未实现盈亏（Unrealized PnL）的直接链接" translate="no">​</a></h3>
<p>使用当前市场价格计算未实现盈亏。<code>price</code> 参数可以是任意参考价（bid、ask、mid、last 或 mark）：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">position</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">unrealized_pnl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">last_price</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 使用最后成交价</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">position</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">unrealized_pnl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bid_price</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># 对多头更保守的估值</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">position</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">unrealized_pnl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ask_price</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># 对空头更保守的估值</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="总盈亏total-pnl">总盈亏（Total PnL）<a href="#总盈亏total-pnl" class="hash-link" aria-label="总盈亏（Total PnL）的直接链接" title="总盈亏（Total PnL）的直接链接" translate="no">​</a></h3>
<p>总盈亏由已实现和未实现部分相加得到：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">total_pnl </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> position</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">total_pnl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current_price</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 返回 realized_pnl + unrealized_pnl</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="货币相关注意事项">货币相关注意事项<a href="#货币相关注意事项" class="hash-link" aria-label="货币相关注意事项的直接链接" title="货币相关注意事项的直接链接" translate="no">​</a></h3>
<ul>
<li>PnL 以合约的结算货币（settlement currency）计算。</li>
<li>对于外汇（Forex），通常为报价货币（quote currency）。</li>
<li>对于反向合约，PnL 可能以基础货币（base currency）计价。</li>
<li>Portfolio 会按结算货币对各合约的已实现 PnL 进行汇总。</li>
<li>多货币的总计需要在 Position 类外部进行货币转换。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="手续费与成本commissions-and-costs">手续费与成本（Commissions and costs）<a href="#手续费与成本commissions-and-costs" class="hash-link" aria-label="手续费与成本（Commissions and costs）的直接链接" title="手续费与成本（Commissions and costs）的直接链接" translate="no">​</a></h2>
<p>持仓会跟踪所有交易成本：</p>
<ul>
<li>手续费按币种累计。</li>
<li>每笔成交的手续费会加入运行总额。</li>
<li>支持多种手续费币种。</li>
<li>仅当手续费以结算货币计价时才会计入已实现 PnL。</li>
<li>其它币种的手续费会单独记录，可能需要转换后合并。</li>
</ul>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">commissions </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> position</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">commissions</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 返回一个 list[Money]，按币种汇总的手续费</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">notional </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> position</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">notional_value</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current_price</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 返回以报价货币（standard）或基础货币（inverse）计价的 Money</span><br></span></code></pre></div></div>
<p>限制：</p>
<ul>
<li>如果反向合约没有设置 <code>base_currency</code> 将导致 panic（运行时错误）。</li>
<li>不支持 quanto 合约（对于 quanto，函数会返回报价货币而非结算货币）。</li>
<li>对于 quanto 合约，建议使用 <code>instrument.calculate_notional_value()</code>。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="持仓属性与状态">持仓属性与状态<a href="#持仓属性与状态" class="hash-link" aria-label="持仓属性与状态的直接链接" title="持仓属性与状态的直接链接" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="标识符">标识符<a href="#标识符" class="hash-link" aria-label="标识符的直接链接" title="标识符的直接链接" translate="no">​</a></h3>
<ul>
<li><code>id</code>：持仓唯一标识符。</li>
<li><code>instrument_id</code>：交易工具标识。</li>
<li><code>account_id</code>：持仓所属账户。</li>
<li><code>trader_id</code>：持仓所属交易员。</li>
<li><code>strategy_id</code>：管理该持仓的策略。</li>
<li><code>opening_order_id</code>：开仓时的客户端订单 ID。</li>
<li><code>closing_order_id</code>：平仓时的客户端订单 ID。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="持仓状态">持仓状态<a href="#持仓状态" class="hash-link" aria-label="持仓状态的直接链接" title="持仓状态的直接链接" translate="no">​</a></h3>
<ul>
<li><code>side</code>：当前持仓方向（<code>LONG</code>、<code>SHORT</code> 或 <code>FLAT</code>）。</li>
<li><code>entry</code>：当前开仓方向（<code>Buy</code> 对应 <code>LONG</code>，<code>Sell</code> 对应 <code>SHORT</code>）。在持仓反向时会更新。</li>
<li><code>quantity</code>：当前绝对持仓数量。</li>
<li><code>signed_qty</code>：带符号的持仓数量（多头为正、空头为负）。</li>
<li><code>peak_qty</code>：持仓生命周期内达到的最大数量。</li>
<li><code>is_open</code>：是否处于打开状态。</li>
<li><code>is_closed</code>：是否已关闭（<code>FLAT</code>）。</li>
<li><code>is_long</code>：是否为多头。</li>
<li><code>is_short</code>：是否为空头。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="估值与定价">估值与定价<a href="#估值与定价" class="hash-link" aria-label="估值与定价的直接链接" title="估值与定价的直接链接" translate="no">​</a></h3>
<ul>
<li><code>avg_px_open</code>：平均开仓价。</li>
<li><code>avg_px_close</code>：持仓关闭时的平均平仓价。</li>
<li><code>realized_pnl</code>：已实现盈亏。</li>
<li><code>realized_return</code>：已实现收益率（小数，例如 0.05 表示 5%）。</li>
<li><code>quote_currency</code>：报价货币。</li>
<li><code>base_currency</code>：基础货币（如适用）。</li>
<li><code>settlement_currency</code>：用于 PnL 结算的货币。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="合约规格">合约规格<a href="#合约规格" class="hash-link" aria-label="合约规格的直接链接" title="合约规格的直接链接" translate="no">​</a></h3>
<ul>
<li><code>multiplier</code>：合约乘数。</li>
<li><code>price_precision</code>：价格的小数位精度。</li>
<li><code>size_precision</code>：数量的小数位精度。</li>
<li><code>is_inverse</code>：是否为反向合约。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="时间戳">时间戳<a href="#时间戳" class="hash-link" aria-label="时间戳的直接链接" title="时间戳的直接链接" translate="no">​</a></h3>
<ul>
<li><code>ts_init</code>：持仓初始化时间。</li>
<li><code>ts_opened</code>：持仓开仓时间。</li>
<li><code>ts_last</code>：最后一次更新的时间戳。</li>
<li><code>ts_closed</code>：持仓关闭时间。</li>
<li><code>duration_ns</code>：从开仓到关闭的持续时间（纳秒）。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="关联数据">关联数据<a href="#关联数据" class="hash-link" aria-label="关联数据的直接链接" title="关联数据的直接链接" translate="no">​</a></h3>
<ul>
<li><code>symbol</code>：交易工具的代码（ticker）。</li>
<li><code>venue</code>：交易场所（venue）。</li>
<li><code>client_order_ids</code>：与持仓相关的所有客户端订单 ID。</li>
<li><code>venue_order_ids</code>：与持仓相关的所有场所订单 ID。</li>
<li><code>trade_ids</code>：来自场所的所有成交/交易 ID。</li>
<li><code>events</code>：应用到持仓的所有成交事件。</li>
<li><code>event_count</code>：已应用成交事件的总数。</li>
<li><code>last_event</code>：最近一次成交事件。</li>
<li><code>last_trade_id</code>：最近一次成交的 trade ID。</li>
</ul>
<p>信息：有关完整的类型信息与属性文档，请参见 Position 的<a href="/api_reference/model/position#class-position">API 参考</a>。</p>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="事件与追踪">事件与追踪<a href="#事件与追踪" class="hash-link" aria-label="事件与追踪的直接链接" title="事件与追踪的直接链接" translate="no">​</a></h2>
<p>持仓保留完整的事件历史：</p>
<ul>
<li>所有订单成交事件按时间顺序存储。</li>
<li>跟踪关联的客户端订单 ID。</li>
<li>保存来自场所的成交 ID。</li>
<li><code>event_count</code> 表示已应用的成交总数。</li>
</ul>
<p>这些历史数据支持：</p>
<ul>
<li>详细的持仓分析。</li>
<li>交易对账（reconciliation）。</li>
<li>绩效归因（performance attribution）。</li>
<li>审计追踪。</li>
</ul>
<p>提示：使用 <code>position.events</code> 可以访问完整的成交历史以便对账；<code>position.trade_ids</code> 有助于与券商流水进行匹配。更多对账最佳实践见 <a href="/concepts/execution">Execution guide</a>。</p>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="数值精度">数值精度<a href="#数值精度" class="hash-link" aria-label="数值精度的直接链接" title="数值精度的直接链接" translate="no">​</a></h2>
<p>持仓计算在 PnL 与平均价格计算中使用 64 位浮点（<code>f64</code>）。尽管 <code>Price</code>、<code>Quantity</code>、<code>Money</code> 等定点（fixed-point）类型在配置的小数位下能保证精度，但内部计算为提高性能与避免溢出会转换为 <code>f64</code>。</p>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="设计理由">设计理由<a href="#设计理由" class="hash-link" aria-label="设计理由的直接链接" title="设计理由的直接链接" translate="no">​</a></h3>
<p>平台在持仓计算中采用 <code>f64</code> 平衡性能与精度：</p>
<ul>
<li>浮点运算比任意精度算术（arbitrary-precision）更快。</li>
<li>即便是 128 位整数，相乘仍有溢出风险。</li>
<li>每次计算都从精确的定点值开始，以避免累计误差。</li>
<li>IEEE-754 双精度提供大约 15 位十进制有效数字。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="已验证的精度特性">已验证的精度特性<a href="#已验证的精度特性" class="hash-link" aria-label="已验证的精度特性的直接链接" title="已验证的精度特性的直接链接" translate="no">​</a></h3>
<p>测试表明 <code>f64</code> 在典型交易场景中能保持足够的精度：</p>
<ul>
<li>标准金额：对于 ≥ 0.01 的常规货币金额无精度损失。</li>
<li>高精度工具：9 位小数的加密货币价格在 1e-6 范围内保持精度。</li>
<li>连续成交：100 次成交无累计漂移（手续费精度保持到 1e-10）。</li>
<li>极端价格：可处理从 0.00001 到 99,999.99999 的范围而不发生溢出。</li>
<li>来回成交：以相同价格开平仓产生的 PnL 精确（仅手续费造成差异）。</li>
</ul>
<p>有关实现细节，请参见 <code>crates/model/src/position.rs</code> 中的 <code>test_position_pnl_precision_*</code> 测试。</p>
<p>注意：若需满足监管合规或审计要求并要求精确十进制运算，可考虑在外部使用 <code>Decimal</code> 等库类型。极小金额（低于 <code>f64</code> 的机器精度 ~1e-15）可能被舍入为零，但对于现实的交易场景影响甚微。</p>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="与其它组件的集成">与其它组件的集成<a href="#与其它组件的集成" class="hash-link" aria-label="与其它组件的集成的直接链接" title="与其它组件的集成的直接链接" translate="no">​</a></h2>
<p>持仓与下列关键组件交互：</p>
<ul>
<li><strong>Portfolio</strong>：汇总来自不同工具与策略的持仓。</li>
<li><strong>ExecutionEngine</strong>：由成交事件创建并更新持仓。</li>
<li><strong>Cache</strong>：存储持仓状态与快照。</li>
<li><strong>RiskEngine</strong>：监控持仓限额与敞口。</li>
</ul>
<p>注意：对价差（spread）类合约通常不创建持仓。尽管或有联动订单（contingent orders）仍可触发，但这些在逻辑上不与普通持仓关联。引擎会对价差合约采用与常规合约不同的处理方式。</p>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接" translate="no">​</a></h2>
<p>持仓是 NautilusTrader 追踪交易活动与绩效的核心。理解持仓如何聚合成交、计算盈亏并应对不同 OMS 配置，对于构建稳健的交易策略至关重要。NETTING 模式下的持仓快照机制确保了历史盈亏的准确保留，而详尽的事件历史则支持深入分析与对账。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/Aloento/NautilusTraderDoc/tree/main/docs/concepts/positions.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_F7ru" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_GNoA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/concepts/portfolio"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">投资组合</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/concepts/reports"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">报告</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_pg_n thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#概述" class="table-of-contents__link toc-highlight">概述</a></li><li><a href="#持仓生命周期" class="table-of-contents__link toc-highlight">持仓生命周期</a><ul><li><a href="#创建" class="table-of-contents__link toc-highlight">创建</a></li><li><a href="#更新" class="table-of-contents__link toc-highlight">更新</a></li><li><a href="#关闭" class="table-of-contents__link toc-highlight">关闭</a></li></ul></li><li><a href="#成交聚合order-fill-aggregation" class="table-of-contents__link toc-highlight">成交聚合（Order fill aggregation）</a><ul><li><a href="#买入成交buy-fills" class="table-of-contents__link toc-highlight">买入成交（Buy fills）</a></li><li><a href="#卖出成交sell-fills" class="table-of-contents__link toc-highlight">卖出成交（Sell fills）</a></li><li><a href="#净持仓计算" class="table-of-contents__link toc-highlight">净持仓计算</a></li></ul></li><li><a href="#oms-类型与持仓管理" class="table-of-contents__link toc-highlight">OMS 类型与持仓管理</a><ul><li><a href="#netting" class="table-of-contents__link toc-highlight"><code>NETTING</code></a></li><li><a href="#hedging" class="table-of-contents__link toc-highlight"><code>HEDGING</code></a></li><li><a href="#策略层-vs-场所venue-oms" class="table-of-contents__link toc-highlight">策略层 vs 场所（venue） OMS</a></li></ul></li><li><a href="#持仓快照position-snapshotting" class="table-of-contents__link toc-highlight">持仓快照（Position snapshotting）</a><ul><li><a href="#为什么需要快照" class="table-of-contents__link toc-highlight">为什么需要快照</a></li><li><a href="#工作原理" class="table-of-contents__link toc-highlight">工作原理</a></li><li><a href="#示例场景" class="table-of-contents__link toc-highlight">示例场景</a></li></ul></li><li><a href="#盈亏pnl计算" class="table-of-contents__link toc-highlight">盈亏（PnL）计算</a><ul><li><a href="#已实现盈亏realized-pnl" class="table-of-contents__link toc-highlight">已实现盈亏（Realized PnL）</a></li><li><a href="#未实现盈亏unrealized-pnl" class="table-of-contents__link toc-highlight">未实现盈亏（Unrealized PnL）</a></li><li><a href="#总盈亏total-pnl" class="table-of-contents__link toc-highlight">总盈亏（Total PnL）</a></li><li><a href="#货币相关注意事项" class="table-of-contents__link toc-highlight">货币相关注意事项</a></li></ul></li><li><a href="#手续费与成本commissions-and-costs" class="table-of-contents__link toc-highlight">手续费与成本（Commissions and costs）</a></li><li><a href="#持仓属性与状态" class="table-of-contents__link toc-highlight">持仓属性与状态</a><ul><li><a href="#标识符" class="table-of-contents__link toc-highlight">标识符</a></li><li><a href="#持仓状态" class="table-of-contents__link toc-highlight">持仓状态</a></li><li><a href="#估值与定价" class="table-of-contents__link toc-highlight">估值与定价</a></li><li><a href="#合约规格" class="table-of-contents__link toc-highlight">合约规格</a></li><li><a href="#时间戳" class="table-of-contents__link toc-highlight">时间戳</a></li><li><a href="#关联数据" class="table-of-contents__link toc-highlight">关联数据</a></li></ul></li><li><a href="#事件与追踪" class="table-of-contents__link toc-highlight">事件与追踪</a></li><li><a href="#数值精度" class="table-of-contents__link toc-highlight">数值精度</a><ul><li><a href="#设计理由" class="table-of-contents__link toc-highlight">设计理由</a></li><li><a href="#已验证的精度特性" class="table-of-contents__link toc-highlight">已验证的精度特性</a></li></ul></li><li><a href="#与其它组件的集成" class="table-of-contents__link toc-highlight">与其它组件的集成</a></li><li><a href="#总结" class="table-of-contents__link toc-highlight">总结</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 NautilusTrader Documentation.</div></div></div></footer></div>
</body>
</html>