<!doctype html>
<html lang="zh" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-concepts/backtesting" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.1">
<title data-rh="true">回测 | NautilusTrader 文档</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://nautilus.aloen.to/concepts/backtesting"><meta data-rh="true" property="og:locale" content="zh"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="回测 | NautilusTrader 文档"><meta data-rh="true" name="description" content="使用 NautilusTrader 进行回测是一种有步骤的模拟流程，它通过特定系统实现来重现交易活动。该系统由多个组件组成，"><meta data-rh="true" property="og:description" content="使用 NautilusTrader 进行回测是一种有步骤的模拟流程，它通过特定系统实现来重现交易活动。该系统由多个组件组成，"><link data-rh="true" rel="icon" href="/logo.png"><link data-rh="true" rel="canonical" href="https://nautilus.aloen.to/concepts/backtesting"><link data-rh="true" rel="alternate" href="https://nautilus.aloen.to/concepts/backtesting" hreflang="zh"><link data-rh="true" rel="alternate" href="https://nautilus.aloen.to/concepts/backtesting" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"概念","item":"https://nautilus.aloen.to/concepts/"},{"@type":"ListItem","position":2,"name":"回测","item":"https://nautilus.aloen.to/concepts/backtesting"}]}</script><link rel="stylesheet" href="/assets/css/styles.33db920f.css">
<script src="/assets/js/runtime~main.d37f7723.js" defer="defer"></script>
<script src="/assets/js/main.991b6fd5.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/logo.png"><div role="region" aria-label="跳到主要内容"><a class="skipToContent__uWo" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/logo.png" alt="NautilusTrader Logo" class="themedComponent_WkLn themedComponent--light_cjoX"><img src="/logo.png" alt="NautilusTrader Logo" class="themedComponent_WkLn themedComponent--dark_jZId"></div><b class="navbar__title text--truncate">NautilusTrader</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/api_reference/">文档</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/Aloento/NautilusTraderDoc" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_KfBJ"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_RWFU colorModeToggle_sA1q"><button class="clean-btn toggleButton_qjfc toggleButtonDisabled_cpNp" type="button" disabled="" title="system mode" aria-label="切换浅色/暗黑模式（当前为system mode）"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_CetX lightToggleIcon_UYsV"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_CetX darkToggleIcon_i1s2"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_CetX systemToggleIcon_yIQx"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_PsjF"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_jk42"><div class="docsWrapper_KWBO"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_XpKL" type="button"></button><div class="docRoot_joIP"><aside class="theme-doc-sidebar-container docSidebarContainer_DOen"><div class="sidebarViewport_j7YP"><div class="sidebar_nPgc"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_MTDt"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_GgI9 menu__link menu__link--sublist" href="/api_reference/"><span title="Python API" class="categoryLinkLabel_XKxb">Python API</span></a><button aria-label="展开侧边栏分类 &#x27;Python API&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_GgI9 menu__link menu__link--sublist menu__link--active" href="/concepts/"><span title="概念" class="categoryLinkLabel_XKxb">概念</span></a><button aria-label="折叠侧边栏分类 &#x27;概念&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/actors"><span title="Actors" class="linkLabel_CNtA">Actors</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/adapters"><span title="适配器" class="linkLabel_CNtA">适配器</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/architecture"><span title="架构" class="linkLabel_CNtA">架构</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/concepts/backtesting"><span title="回测" class="linkLabel_CNtA">回测</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/cache"><span title="Cache" class="linkLabel_CNtA">Cache</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/data"><span title="数据" class="linkLabel_CNtA">数据</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/execution"><span title="执行" class="linkLabel_CNtA">执行</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/instruments"><span title="合约与交易品种" class="linkLabel_CNtA">合约与交易品种</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/live"><span title="Live 交易" class="linkLabel_CNtA">Live 交易</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/logging"><span title="日志" class="linkLabel_CNtA">日志</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/message_bus"><span title="消息总线" class="linkLabel_CNtA">消息总线</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/orders"><span title="订单" class="linkLabel_CNtA">订单</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/overview"><span title="概览" class="linkLabel_CNtA">概览</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/portfolio"><span title="投资组合" class="linkLabel_CNtA">投资组合</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/positions"><span title="持仓" class="linkLabel_CNtA">持仓</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/reports"><span title="报告" class="linkLabel_CNtA">报告</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/strategies"><span title="策略" class="linkLabel_CNtA">策略</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_GgI9 menu__link menu__link--sublist" href="/developer_guide/"><span title="开发者指南" class="categoryLinkLabel_XKxb">开发者指南</span></a><button aria-label="展开侧边栏分类 &#x27;开发者指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_GgI9 menu__link menu__link--sublist" href="/getting_started/"><span title="入门" class="categoryLinkLabel_XKxb">入门</span></a><button aria-label="展开侧边栏分类 &#x27;入门&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_GgI9 menu__link menu__link--sublist" href="/integrations/"><span title="集成" class="categoryLinkLabel_XKxb">集成</span></a><button aria-label="展开侧边栏分类 &#x27;集成&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_GgI9 menu__link menu__link--sublist" href="/tutorials/"><span title="教程" class="categoryLinkLabel_XKxb">教程</span></a><button aria-label="展开侧边栏分类 &#x27;教程&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_bw1l"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_PIhC"><div class="docItemContainer_pFw3"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_HRKZ" aria-label="页面路径"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_sX5c"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/concepts/"><span>概念</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">回测</span></li></ul></nav><div class="tocCollapsible_DhUt theme-doc-toc-mobile tocMobile_Izjv"><button type="button" class="clean-btn tocCollapsibleButton_eYR5">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>回测</h1></header>
<p>使用 NautilusTrader 进行回测是一种有步骤的模拟流程，它通过特定系统实现来重现交易活动。该系统由多个组件组成，
包括内置引擎、<code>Cache</code>、<a href="/concepts/message_bus">MessageBus</a>、<code>Portfolio</code>、<a href="/concepts/actors">Actors</a>、<a href="/concepts/strategies">Strategies</a>、<a href="/concepts/execution">Execution Algorithms</a>
以及其他用户自定义模块。整个交易模拟以由 <code>BacktestEngine</code> 处理的一条历史数据流为基础。当数据流耗尽时，引擎结束运行并产出
详尽的结果与绩效指标，供进一步分析使用。</p>
<p>NautilusTrader 提供两种不同层次的 API 用于配置和运行回测：</p>
<ul>
<li><strong>High-level API（高层 API）</strong>：使用 <code>BacktestNode</code> 和配置对象（内部会创建 <code>BacktestEngine</code>）。</li>
<li><strong>Low-level API（底层 API）</strong>：直接使用 <code>BacktestEngine</code>，需要更多手工配置。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="选择哪个-api-层级">选择哪个 API 层级<a href="#选择哪个-api-层级" class="hash-link" aria-label="选择哪个 API 层级的直接链接" title="选择哪个 API 层级的直接链接" translate="no">​</a></h2>
<p>在以下情况下考虑使用 <strong>Low-level API</strong>：</p>
<ul>
<li>整个数据流能在可用机器资源内处理（例如内存足够）。</li>
<li>你不想把数据存为 Nautilus 特定的 Parquet 格式。</li>
<li>希望保留原始数据的原始格式（例如 CSV、二进制等）。</li>
<li>需要对 <code>BacktestEngine</code> 进行精细控制，例如在相同数据集上重复回测但替换组件（actor、strategy）或调整参数。</li>
</ul>
<p>在以下情况下考虑使用 <strong>High-level API</strong>：</p>
<ul>
<li>数据流超出可用内存，需要分批流式处理数据。</li>
<li>想利用 <code>ParquetDataCatalog</code> 在 Nautilus 特定的 Parquet 格式下带来的性能与便利。</li>
<li>希望通过配置对象在多个引擎上并行或批量管理多个回测运行。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="底层-apilow-level-api">底层 API（Low-level API）<a href="#底层-apilow-level-api" class="hash-link" aria-label="底层 API（Low-level API）的直接链接" title="底层 API（Low-level API）的直接链接" translate="no">​</a></h2>
<p>底层 API 以 <code>BacktestEngine</code> 为中心，输入通过 Python 脚本手动初始化并添加。一个实例化的 <code>BacktestEngine</code> 可以接收：</p>
<ul>
<li><code>Data</code> 对象的列表（会基于 <code>ts_init</code> 自动按单调顺序排序）。</li>
<li>多个手动初始化的 venue。</li>
<li>多个手动初始化并添加的 actor。</li>
<li>多个手动初始化并添加的 execution algorithm。</li>
</ul>
<p>这种方式适合需要对回测过程进行逐项精细控制的场景。</p>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="高层-apihigh-level-api">高层 API（High-level API）<a href="#高层-apihigh-level-api" class="hash-link" aria-label="高层 API（High-level API）的直接链接" title="高层 API（High-level API）的直接链接" translate="no">​</a></h2>
<p>高层 API 以 <code>BacktestNode</code> 为核心，负责协调多个 <code>BacktestEngine</code> 实例的管理，
每个实例由一个 <code>BacktestRunConfig</code> 定义。多个配置可以打包成列表，由节点在一次运行中处理。</p>
<p>每个 <code>BacktestRunConfig</code> 通常包含：</p>
<ul>
<li>一组 <code>BacktestDataConfig</code>。</li>
<li>一组 <code>BacktestVenueConfig</code>。</li>
<li>一组 <code>ImportableActorConfig</code>。</li>
<li>一组 <code>ImportableStrategyConfig</code>。</li>
<li>一组 <code>ImportableExecAlgorithmConfig</code>。</li>
<li>一个可选的 <code>ImportableControllerConfig</code>。</li>
<li>一个可选的 <code>BacktestEngineConfig</code>（如果未指定则使用默认配置）。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="数据data">数据（Data）<a href="#数据data" class="hash-link" aria-label="数据（Data）的直接链接" title="数据（Data）的直接链接" translate="no">​</a></h2>
<p>用于回测的数据驱动了执行流程。由于可用的数据类型多样，务必确保你的 venue 配置与提供的数据相匹配，
否则配置与数据不一致会导致执行时出现意外行为。</p>
<p>NautilusTrader 主要针对订单簿数据（order book）进行设计与优化，因为它能完整表示市场的每个价格档或订单，
最接近真实交易场所的行为，能够提供最高精度的执行模拟。但若高精度的订单簿数据不可用或不是必须，平台也能按下列由精细到粗糙的顺序处理市况数据：</p>
<ol>
<li><strong>Order Book Data/Deltas（L3 market-by-order）</strong>：提供最完整的市场深度和逐笔订单流，可见所有单个订单。</li>
<li><strong>Order Book Data/Deltas（L2 market-by-price）</strong>：按价格档聚合订单，保留多档市场深度。</li>
<li><strong>Quote Ticks（L1 market-by-price）</strong>：仅包含最优买卖价及对应量，表示“top of the book”。</li>
<li><strong>Trade Ticks</strong>：反映实际成交，提供交易发生的精确信息。</li>
<li><strong>Bars</strong>：按固定时间区间（如 1 分钟、1 小时或 1 天）聚合的 OHLC 数据。</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="数据选择成本与准确度的权衡">数据选择：成本与准确度的权衡<a href="#数据选择成本与准确度的权衡" class="hash-link" aria-label="数据选择：成本与准确度的权衡的直接链接" title="数据选择：成本与准确度的权衡的直接链接" translate="no">​</a></h3>
<p>对于许多策略来说，Bar 数据（例如 1 分钟 K 线）已足够用于回测与策略开发。Bar 数据通常比逐笔或订单簿数据更易获取且成本更低。</p>
<p>考虑到这一现实，Nautilus 支持基于 bar 的回测，并提供若干增强特性以在较低粒度数据下尽可能提升模拟精度。</p>
<p>提示：</p>
<blockquote>
<p>对于部分策略，使用 bar 数据作为初期验证快速且经济。若策略对执行时点非常敏感（例如需要在 OHLC 范围内的精确价格完成成交，或止盈/止损区间非常紧），建议升级到更高粒度的数据以做更精确的验证。</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="交易场所venues">交易场所（Venues）<a href="#交易场所venues" class="hash-link" aria-label="交易场所（Venues）的直接链接" title="交易场所（Venues）的直接链接" translate="no">​</a></h2>
<p>为回测初始化 venue 时，必须指定其内部订单 <code>book_type</code>，以决定执行处理使用哪种订单簿模型：</p>
<ul>
<li><code>L1_MBP</code>：Level 1 market-by-price（默认）。仅维护顶级档位。</li>
<li><code>L2_MBP</code>：Level 2 market-by-price。维护多档深度，每个价格档汇总为单个聚合订单。</li>
<li><code>L3_MBO</code>：Level 3 market-by-order。按订单逐笔维护深度，保留数据提供的每一张订单记录。</li>
</ul>
<p>注意：</p>
<blockquote>
<p>数据的粒度必须与指定的 <code>book_type</code> 一致。Nautilus 无法从低粒度数据（如 quotes、trades、bars）合成出更高粒度的 L2 或 L3 数据。</p>
</blockquote>
<p>警告：</p>
<blockquote>
<p>如果将 venue 的 <code>book_type</code> 设置为 <code>L2_MBP</code> 或 <code>L3_MBO</code>，所有非订单簿的数据（如 quotes、trades、bars）在执行处理时将被忽略，
这可能导致订单看似永远无法被成交。我们正在改进验证逻辑以减少这种配置与数据不匹配的问题。</p>
</blockquote>
<p>警告：</p>
<blockquote>
<p>提供 L2 或更高粒度的订单簿数据时，请确保同步更新 <code>book_type</code> 来反映数据的真实粒度；否则会发生聚合或降级：L2 数据会被降为每档单个订单，L1 则只能反映顶级档位。</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="执行execution">执行（Execution）<a href="#执行execution" class="hash-link" aria-label="执行（Execution）的直接链接" title="执行（Execution）的直接链接" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="数据与消息的时序">数据与消息的时序<a href="#数据与消息的时序" class="hash-link" aria-label="数据与消息的时序的直接链接" title="数据与消息的时序的直接链接" translate="no">​</a></h3>
<p>在主回测循环中，新到的市场数据会先用于已存在订单的执行逻辑，然后再由数据引擎传递给策略处理。这保证了在同一时间戳下先处理执行相关事件，随后触发策略逻辑。</p>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="基于-bar-的执行">基于 Bar 的执行<a href="#基于-bar-的执行" class="hash-link" aria-label="基于 Bar 的执行的直接链接" title="基于 Bar 的执行的直接链接" translate="no">​</a></h3>
<p>Bar 数据为每个时间段提供四个关键价格（假设 bar 基于成交汇总）：</p>
<ul>
<li><strong>Open</strong>：开盘价（第一笔成交）</li>
<li><strong>High</strong>：最高成交价</li>
<li><strong>Low</strong>：最低成交价</li>
<li><strong>Close</strong>：收盘价（最后一笔成交）</li>
</ul>
<p>虽然 Bar 给出价格走势的概览，但相对于更细粒度的数据我们会丢失一些重要信息：</p>
<ul>
<li>无法得知最高价与最低价在时间上的先后顺序；</li>
<li>无法精确看到区间内具体的价格变化时刻；</li>
<li>无法还原真实成交的时间序列。</li>
</ul>
<p>因此，Nautilus 在处理 bar 数据时采用一套尽量真实且偏保守的市场行为模拟机制。即便输入的是 quotes、trades 或 bars（较低粒度），平台内部仍然维护订单簿模拟——不过此时订单簿通常仅有顶级档位。</p>
<p>警告：</p>
<blockquote>
<p>使用 bar 进行执行模拟（在 venue 配置中默认为 <code>bar_execution=True</code>）时，Nautilus 严格要求每个 bar 的时间戳（<code>ts_init</code>）表示该 bar 的<strong>收盘时间</strong>，以保证时间顺序正确并避免前瞻性偏差（look-ahead bias）。</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="bar-的时间戳约定">Bar 的时间戳约定<a href="#bar-的时间戳约定" class="hash-link" aria-label="Bar 的时间戳约定的直接链接" title="Bar 的时间戳约定的直接链接" translate="no">​</a></h4>
<p>如果你的数据源将 bar 的时间戳记录为<strong>开盘时间</strong>（某些供应商常见），则在导入到 Nautilus 之前必须将其转换为收盘时间。未做转换可能导致错误的订单成交、事件顺序错乱或不真实的回测结果。</p>
<ul>
<li>对于支持的适配器，可使用类似 <code>bars_timestamp_on_close=True</code> 的配置（如 Bybit 或 Databento 适配器）在数据引入时自动处理。</li>
<li>对于自定义数据，需要手动将时间戳向后平移一个 bar 周期（例如对 1 分钟 bar 加 1 分钟）。</li>
<li>在导入前用小样本验证时间戳约定，避免模拟偏差。</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="处理-bar-数据的流程">处理 Bar 数据的流程<a href="#处理-bar-数据的流程" class="hash-link" aria-label="处理 Bar 数据的流程的直接链接" title="处理 Bar 数据的流程的直接链接" translate="no">​</a></h4>
<p>即便输入的是 bar 数据，Nautilus 也会为每个合约维护一个内部订单簿，与真实交易场所一致：</p>
<ol>
<li>
<p>时间处理：</p>
<ul>
<li>Nautilus 对用于执行的 bar 时间有特定处理要求；<code>ts_event</code> 应表示 bar 的收盘时间，这是最合乎逻辑的时间点，因为此时 bar 聚合完成。</li>
<li>可通过 <code>BarDataWrangler</code> 的 <code>ts_init_delta</code> 参数控制 <code>ts_init</code> 的偏移，通常设置为 bar 的步长（以纳秒为单位）。</li>
<li>平台会基于这些时间戳确保事件按正确顺序发生，防止前瞻性偏差。</li>
</ul>
</li>
<li>
<p>价格处理：</p>
<ul>
<li>平台将每根 bar 的 OHLC 价格转换为一系列市场更新事件。</li>
<li>更新顺序默认为：Open → High → Low → Close。</li>
<li>若同时提供多个时间框架（如 1 分钟与 5 分钟），将优先使用更高粒度的数据以提高准确性。</li>
</ul>
</li>
<li>
<p>成交（Executions）：</p>
<ul>
<li>下单后，订单与模拟订单簿进行交互，行为类似真实场所。</li>
<li>对于 MARKET 订单，按当前模拟市场价执行并考虑配置的延迟。</li>
<li>对于在市的 LIMIT 订单，只要任一 bar 的价格触及或穿越限价即会触发执行（下文有更详细描述）。</li>
<li>匹配引擎会随着 OHLC 价格的移动持续处理订单，而不是等到整根 bar 结束再统一处理。</li>
</ul>
</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="ohlc-价格的模拟">OHLC 价格的模拟<a href="#ohlc-价格的模拟" class="hash-link" aria-label="OHLC 价格的模拟的直接链接" title="OHLC 价格的模拟的直接链接" translate="no">​</a></h4>
<p>在回测执行过程中，每根 bar 会被拆分为四个价格点按序处理：</p>
<ol>
<li>开盘价（Opening price）</li>
<li>最高价（High price）<em>(High/Low 的先后顺序可配置，见下文 <code>bar_adaptive_high_low_ordering</code>)</em></li>
<li>最低价（Low price）</li>
<li>收盘价（Closing price）</li>
</ol>
<p>该 bar 的成交量在四个价格点间<strong>平均分配</strong>（每点 25%）。在极端情况下，若原始 bar 的量除以 4 小于该合约的最小 <code>size_increment</code>，仍会以最小 <code>size_increment</code> 作为每个价格点的成交量，以确保市场活动有效（例如 CME 交易所的合约单位为 1）。</p>
<p>价格点的具体顺序可通过 venue 配置的 <code>bar_adaptive_high_low_ordering</code> 参数控制。</p>
<p>Nautilus 支持两种 bar 处理模式：</p>
<ol>
<li>
<p>固定顺序（Fixed ordering，<code>bar_adaptive_high_low_ordering=False</code>，默认）</p>
<ul>
<li>按固定顺序处理每根 bar：<code>Open → High → Low → Close</code>。</li>
<li>简单且确定性强。</li>
</ul>
</li>
<li>
<p>自适应顺序（Adaptive ordering，<code>bar_adaptive_high_low_ordering=True</code>）</p>
<ul>
<li>基于 bar 的结构估算更可能的价格路径：</li>
<li>若 Open 更接近 High，则按 <code>Open → High → Low → Close</code> 处理；</li>
<li>若 Open 更接近 Low，则按 <code>Open → Low → High → Close</code> 处理；</li>
<li>研究显示（见链接）该方法在预测 High/Low 顺序上能达到约 75–85% 的准确率，远高于固定顺序的约 50%。</li>
<li>当止盈与止损都发生在同一根 bar 内时，此顺序对于先成交哪个单具有决定性影响。</li>
</ul>
</li>
</ol>
<p>下面示例展示如何为 venue 配置自适应 bar 顺序并设置账户：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backtest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">engine </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> BacktestEngine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">enums </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> OmsType</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> AccountType</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Money</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Currency</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Initialize the backtest engine</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">engine </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BacktestEngine</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Add a venue with adaptive bar ordering and required account settings</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">engine</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add_venue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  venue</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">venue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Your Venue identifier, e.g., Venue(&quot;BINANCE&quot;)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  oms_type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">OmsType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NETTING</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  account_type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">AccountType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CASH</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  starting_balances</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Money</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">10_000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Currency</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;USDT&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  bar_adaptive_high_low_ordering</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Enable adaptive ordering of High/Low bar prices</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="滑点slippage与点差spread处理">滑点（Slippage）与点差（Spread）处理<a href="#滑点slippage与点差spread处理" class="hash-link" aria-label="滑点（Slippage）与点差（Spread）处理的直接链接" title="滑点（Slippage）与点差（Spread）处理的直接链接" translate="no">​</a></h3>
<p>在使用不同数据类型回测时，Nautilus 会针对滑点与点差采取不同的模拟策略：</p>
<p>对于 L2（market-by-price）或 L3（market-by-order）数据，滑点可通过订单簿真实深度高精度模拟：</p>
<ul>
<li>按真实订单簿档位逐档成交；</li>
<li>按每档可用量依次匹配；</li>
<li>保留真实的订单簿深度对每次成交的影响。</li>
</ul>
<p>对于 L1 数据类型（如 L1 订单簿、trades、quotes、bars），滑点通过参数化机制处理：</p>
<p>初始成交滑点（<code>prob_slippage</code>）：</p>
<ul>
<li>由 <code>FillModel</code> 的 <code>prob_slippage</code> 参数控制；</li>
<li>决定初始成交是否会发生 1 tick 的价差；</li>
<li>例如 <code>prob_slippage=0.5</code> 表示买入市价单有 50% 概率以高 1 tick 的价格成交。</li>
</ul>
<p>提示：</p>
<blockquote>
<p>使用 bar 数据回测时，价格粒度较低会影响滑点模拟。若需尽可能真实的回测结果，应优先考虑 L2 或 L3 级别的订单簿数据。</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="fill-模型fill-model">Fill 模型（Fill model）<a href="#fill-模型fill-model" class="hash-link" aria-label="Fill 模型（Fill model）的直接链接" title="Fill 模型（Fill model）的直接链接" translate="no">​</a></h3>
<p><code>FillModel</code> 用于在回测中以概率方式模拟订单队列位置与执行，解决一个根本性的问题：即便拥有完备的历史市场数据，也无法精确重现订单在实时市场中与其他参与者交互的所有细节。</p>
<p><code>FillModel</code> 模拟交易中的两个关键方面：</p>
<ol>
<li>
<p>限价单的队列位置（Queue position）：</p>
<ul>
<li>当多个交易者在相同价格档下单时，队列中的先后顺序决定了是否以及何时被成交。</li>
</ul>
</li>
<li>
<p>市场影响与竞争（Market impact and competition）：</p>
<ul>
<li>使用市价单吃入流动性时，你会与其他交易者竞争可用的流动性，进而影响最终成交价。</li>
</ul>
</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="配置与参数">配置与参数<a href="#配置与参数" class="hash-link" aria-label="配置与参数的直接链接" title="配置与参数的直接链接" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backtest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">models </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> FillModel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backtest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> BacktestEngineConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backtest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">engine </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> BacktestEngine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Create a custom fill model with your desired probabilities</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fill_model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> FillModel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  prob_fill_on_limit</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Chance a limit order fills when price matches (applied to bars/trades/quotes + L1/L2/L3 order book)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  prob_fill_on_stop</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.95</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># [DEPRECATED] Will be removed in a future version, use `prob_slippage` instead</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  prob_slippage</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic"># Chance of 1-tick slippage (applied to bars/trades/quotes + L1 order book only)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  random_seed</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># Optional: Set for reproducible results</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Add the fill model to your engine configuration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">engine </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BacktestEngine</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">BacktestEngineConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    trader_id</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;TESTER-001&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fill_model</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">fill_model</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Inject your custom fill model here</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><code>prob_fill_on_limit</code>（默认：<code>1.0</code>）</p>
<ul>
<li>目的：模拟当价格触及限价位时，限价单被成交的概率。</li>
<li>细节：<!-- -->
<ul>
<li>模拟订单在该价格档的队列位置。</li>
<li>适用于所有数据类型（L1/L2/L3 订单簿、quotes、trades、bars）。</li>
<li>每当市场价格触及但未穿越你的委托价时，会进行一次新的随机概率检验。</li>
<li>若检验通过，则填充剩余全部委托量。</li>
</ul>
</li>
</ul>
<p>示例：</p>
<ul>
<li><code>prob_fill_on_limit=0.0</code>：限价买单在最佳卖价到达限价时从不成交；限价卖单在最佳买价到达限价时从不成交（模拟排在队尾）。</li>
<li><code>prob_fill_on_limit=0.5</code>：在价格触及时有 50% 概率成交（模拟处于队列中间）。</li>
<li><code>prob_fill_on_limit=1.0</code>（默认）：在价格触及时必然成交（模拟处于队列最前端）。</li>
</ul>
<p><code>prob_slippage</code>（默认：<code>0.0</code>）</p>
<ul>
<li>目的：模拟市价单执行时发生价格滑点的概率。</li>
<li>细节：<!-- -->
<ul>
<li>仅适用于 L1 数据类型（quotes、trades、bars）。</li>
<li>触发时，会将成交价按一个 tick 向不利方向移动。</li>
<li>影响所有市价类订单（例如 <code>MARKET</code>、<code>MARKET_TO_LIMIT</code>、<code>MARKET_IF_TOUCHED</code>、<code>STOP_MARKET</code>）。</li>
<li>在 L2/L3 数据下不启用，因为订单簿深度可用于自然决定滑点。</li>
</ul>
</li>
</ul>
<p>示例：</p>
<ul>
<li><code>prob_slippage=0.0</code>（默认）：不施加额外滑点，理想化地以当前市场价成交。</li>
<li><code>prob_slippage=0.5</code>：买入市价单有 50% 概率以高 1 tick 的价格成交；卖出市价单有 50% 概率以低 1 tick 的价格成交。</li>
<li><code>prob_slippage=1.0</code>：买单始终以高 1 tick 成交，卖单始终以低 1 tick 成交（始终存在不利价格移动的情形）。</li>
</ul>
<p><code>prob_fill_on_stop</code>（默认：<code>1.0</code>）</p>
<ul>
<li>Stop 单本质上是 stop-market，当市价触及 stop 价时转为市价单。</li>
<li>因此 stop 单的成交机制等同于市价单，由 <code>prob_slippage</code> 控制。</li>
</ul>
<p>警告：</p>
<blockquote>
<p><code>prob_fill_on_stop</code> 参数已弃用，将在未来版本移除，请使用 <code>prob_slippage</code>。</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="不同数据类型下模拟行为的差异">不同数据类型下模拟行为的差异<a href="#不同数据类型下模拟行为的差异" class="hash-link" aria-label="不同数据类型下模拟行为的差异的直接链接" title="不同数据类型下模拟行为的差异的直接链接" translate="no">​</a></h4>
<p><code>FillModel</code> 的行为会根据使用的订单簿类型而调整：</p>
<p><strong>L2 / L3 订单簿数据</strong></p>
<p>在存在完整订单簿深度的情况下，<code>FillModel</code> 主要通过 <code>prob_fill_on_limit</code> 模拟限价单的队列位置；滑点由订单簿深度自然决定。</p>
<ul>
<li><code>prob_fill_on_limit</code> 生效；</li>
<li><code>prob_slippage</code> 不生效（订单簿深度决定价格冲击）。</li>
</ul>
<p><strong>L1 订单簿数据</strong></p>
<p>只有最佳买卖价时，<code>FillModel</code> 会提供额外模拟：</p>
<ul>
<li><code>prob_fill_on_limit</code> 生效；</li>
<li><code>prob_slippage</code> 生效，用以补偿缺失的深度信息。</li>
</ul>
<p><strong>Bar / Quote / Trade 数据</strong></p>
<p>与 L1 类似：</p>
<ul>
<li><code>prob_fill_on_limit</code> 生效；</li>
<li><code>prob_slippage</code> 生效。</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="重要注意事项">重要注意事项<a href="#重要注意事项" class="hash-link" aria-label="重要注意事项的直接链接" title="重要注意事项的直接链接" translate="no">​</a></h4>
<ul>
<li><strong>支持部分成交（Partial fills）</strong>：在 L2/L3 数据下，当订单簿中可用量不足时，可能产生部分成交，剩余挂单将保留，直到后续有可用流动性或被取消。</li>
<li>在 L1 数据下，滑点被限制为固定的 1 tick，且会以该价位填充整个订单量。</li>
</ul>
<p>注意：</p>
<blockquote>
<p>随着 <code>FillModel</code> 的持续演进，未来版本可能会引入更复杂的执行动力学模拟，例如基于订单规模的可变滑点、更加精细的部分成交模拟以及更复杂的队列位置建模。</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="账户类型account-types">账户类型（Account types）<a href="#账户类型account-types" class="hash-link" aria-label="账户类型（Account types）的直接链接" title="账户类型（Account types）的直接链接" translate="no">​</a></h2>
<p>当你将 venue 添加到引擎——无论用于实盘还是回测——都必须通过 <code>account_type</code> 参数选择三种会计模式之一：</p>
<table><thead><tr><th>Account type</th><th>Typical use-case</th><th>What the engine locks</th></tr></thead><tbody><tr><td>Cash</td><td>Spot trading (e.g. BTC/USDT, stocks)</td><td>Notional value for every position a pending order would open.</td></tr><tr><td>Margin</td><td>Derivatives or any product that allows leverage</td><td>Initial margin for each order plus maintenance margin for open positions.</td></tr><tr><td>Betting</td><td>Sports betting, book‑making</td><td>Stake required by the venue; no leverage.</td></tr></tbody></table>
<p>向回测 venue 添加 <code>CASH</code> 账户的示例：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">binance </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> BINANCE_VENUE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backtest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">engine </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> BacktestEngine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">currencies </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> USDT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">enums </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> OmsType</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> AccountType</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Money</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Currency</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Initialize the backtest engine</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">engine </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BacktestEngine</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Add a CASH account for the venue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">engine</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add_venue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  venue</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">BINANCE_VENUE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Create or reference a Venue identifier</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  oms_type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">OmsType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NETTING</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  account_type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">AccountType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CASH</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  starting_balances</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Money</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">10_000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> USDT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="现金账户cash-accounts">现金账户（Cash accounts）<a href="#现金账户cash-accounts" class="hash-link" aria-label="现金账户（Cash accounts）的直接链接" title="现金账户（Cash accounts）的直接链接" translate="no">​</a></h3>
<p>现金账户以全额结算交易；不存在杠杆概念，因此也没有保证金的概念。</p>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="保证金账户margin-accounts">保证金账户（Margin accounts）<a href="#保证金账户margin-accounts" class="hash-link" aria-label="保证金账户（Margin accounts）的直接链接" title="保证金账户（Margin accounts）的直接链接" translate="no">​</a></h3>
<p>保证金账户用于交易需要保证金的品种，如期货或带杠杆的产品。它追踪账户余额、计算所需保证金并管理杠杆，确保持仓与委托拥有足够的抵押品。</p>
<p>关键概念：</p>
<ul>
<li><strong>Leverage（杠杆）</strong>：放大相对于账户权益的交易敞口，杠杆越高，潜在收益与风险越大。</li>
<li><strong>Initial Margin（初始保证金）</strong>：开仓时提交订单所需的抵押。</li>
<li><strong>Maintenance Margin（维持保证金）</strong>：维持持仓所需的最小抵押。</li>
<li><strong>Locked Balance（冻结余额）</strong>：作为抵押被保留、不可用于新订单或提款的资金。</li>
</ul>
<p>注意：</p>
<blockquote>
<p>Reduce-only 订单在现金账户中不会增加 <code>balance_locked</code>，在保证金账户中也不会增加初始保证金，因为它们只能减少已有敞口。</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="投注账户betting-accounts">投注账户（Betting accounts）<a href="#投注账户betting-accounts" class="hash-link" aria-label="投注账户（Betting accounts）的直接链接" title="投注账户（Betting accounts）的直接链接" translate="no">​</a></h3>
<p>投注账户用于需要押注金额以换取可能固定赔率回报的场景（例如某些预测市场或体育博彩）。引擎仅冻结场所要求的押注金额；杠杆与保证金概念不适用。</p>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="保证金模型margin-models">保证金模型（Margin models）<a href="#保证金模型margin-models" class="hash-link" aria-label="保证金模型（Margin models）的直接链接" title="保证金模型（Margin models）的直接链接" translate="no">​</a></h2>
<p>NautilusTrader 提供灵活的保证金计算模型，以适应不同场所与交易场景的需求。</p>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="概览">概览<a href="#概览" class="hash-link" aria-label="概览的直接链接" title="概览的直接链接" translate="no">​</a></h3>
<p>不同交易场所与经纪商在保证金计算上存在差异：</p>
<ul>
<li><strong>传统经纪商</strong>（如 Interactive Brokers、TD Ameritrade）：通常使用固定百分比，不随杠杆变化。</li>
<li><strong>加密货币交易所</strong>（如 Binance 等）：杠杆可能会降低保证金要求。</li>
<li><strong>期货交易所</strong>（如 CME、ICE）：按合约固定保证金金额。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="可用模型">可用模型<a href="#可用模型" class="hash-link" aria-label="可用模型的直接链接" title="可用模型的直接链接" translate="no">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="standardmarginmodel">StandardMarginModel<a href="#standardmarginmodel" class="hash-link" aria-label="StandardMarginModel的直接链接" title="StandardMarginModel的直接链接" translate="no">​</a></h4>
<p>使用固定百分比（不随杠杆除法），符合传统经纪商的做法。</p>
<p>公式：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Fixed percentages - leverage ignored</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">margin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> notional </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> instrument</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">margin_init</span><br></span></code></pre></div></div>
<ul>
<li>
<p>初始保证金 = <code>notional_value * instrument.margin_init</code></p>
</li>
<li>
<p>维持保证金 = <code>notional_value * instrument.margin_maint</code></p>
</li>
<li>
<p>适用场景：传统经纪商、期货交易所，以及使用固定保证金要求的外汇经纪商。</p>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="leveragedmarginmodel">LeveragedMarginModel<a href="#leveragedmarginmodel" class="hash-link" aria-label="LeveragedMarginModel的直接链接" title="LeveragedMarginModel的直接链接" translate="no">​</a></h4>
<p>通过杠杆对保证金要求进行除法处理。</p>
<p>公式：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Leverage reduces margin requirements</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">adjusted_notional </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> notional </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> leverage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">margin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> adjusted_notional </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> instrument</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">margin_init</span><br></span></code></pre></div></div>
<ul>
<li>
<p>初始保证金 = <code>(notional_value / leverage) * instrument.margin_init</code></p>
</li>
<li>
<p>维持保证金 = <code>(notional_value / leverage) * instrument.margin_maint</code></p>
</li>
<li>
<p>适用场景：加密交易所或杠杆会影响保证金要求的场所。</p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="使用方法">使用方法<a href="#使用方法" class="hash-link" aria-label="使用方法的直接链接" title="使用方法的直接链接" translate="no">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="编程配置">编程配置<a href="#编程配置" class="hash-link" aria-label="编程配置的直接链接" title="编程配置的直接链接" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backtest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">models </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> LeveragedMarginModel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backtest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">models </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> StandardMarginModel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">test_kit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stubs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">execution </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> TestExecStubs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Create account</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">account </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> TestExecStubs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">margin_account</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Set standard model for traditional brokers</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">standard_model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> StandardMarginModel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">set_margin_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">standard_model</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Or use leveraged model for crypto exchanges</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">leveraged_model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> LeveragedMarginModel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">set_margin_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">leveraged_model</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="回测配置">回测配置<a href="#回测配置" class="hash-link" aria-label="回测配置的直接链接" title="回测配置的直接链接" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backtest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> BacktestVenueConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backtest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> MarginModelConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">venue_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BacktestVenueConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;SIM&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  oms_type</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;NETTING&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  account_type</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;MARGIN&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  starting_balances</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;1_000_000 USD&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  margin_model</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">MarginModelConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model_type</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;standard&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Options: &#x27;standard&#x27;, &#x27;leveraged&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="可用模型类型">可用模型类型<a href="#可用模型类型" class="hash-link" aria-label="可用模型类型的直接链接" title="可用模型类型的直接链接" translate="no">​</a></h4>
<ul>
<li><code>&quot;leveraged&quot;</code>：按杠杆降低保证金（默认）。</li>
<li><code>&quot;standard&quot;</code>：固定百分比（传统经纪商）。</li>
<li>自定义类路径：<code>&quot;my_package.my_module.MyMarginModel&quot;</code>。</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="默认行为">默认行为<a href="#默认行为" class="hash-link" aria-label="默认行为的直接链接" title="默认行为的直接链接" translate="no">​</a></h4>
<p>默认情况下，<code>MarginAccount</code> 使用 <code>LeveragedMarginModel</code>。</p>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="现实场景示例">现实场景示例<a href="#现实场景示例" class="hash-link" aria-label="现实场景示例的直接链接" title="现实场景示例的直接链接" translate="no">​</a></h4>
<p><strong>EUR/USD 交易示例：</strong></p>
<ul>
<li><strong>合约</strong>：EUR/USD</li>
<li><strong>数量</strong>：100,000 EUR</li>
<li><strong>价格</strong>：1.10000</li>
<li><strong>名义价值</strong>：$110,000</li>
<li><strong>杠杆</strong>：50x</li>
<li><strong>合约初始保证金比率</strong>：3%</li>
</ul>
<p>保证金计算：</p>
<table><thead><tr><th>Model</th><th>Calculation</th><th>Result</th><th>Percentage</th></tr></thead><tbody><tr><td>Standard</td><td>$110,000 × 0.03</td><td>$3,300</td><td>3.00%</td></tr><tr><td>Leveraged</td><td>($110,000 ÷ 50) × 0.03</td><td>$66</td><td>0.06%</td></tr></tbody></table>
<p>账户余额影响：</p>
<ul>
<li><strong>账户余额</strong>：$10,000</li>
<li><strong>Standard Model</strong>：无法下单 (需 $3,300)</li>
<li><strong>Leveraged Model</strong>：可下单 (仅需 $66)</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="真实场景示例">真实场景示例<a href="#真实场景示例" class="hash-link" aria-label="真实场景示例的直接链接" title="真实场景示例的直接链接" translate="no">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="interactive-brokers-的-eurusd-期货">Interactive Brokers 的 EUR/USD 期货<a href="#interactive-brokers-的-eurusd-期货" class="hash-link" aria-label="Interactive Brokers 的 EUR/USD 期货的直接链接" title="Interactive Brokers 的 EUR/USD 期货的直接链接" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># IB requires fixed margin regardless of leverage</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">set_margin_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">StandardMarginModel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">margin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">calculate_margin_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> quantity</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Result: Fixed percentage of notional value</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="binance-加密交易">Binance 加密交易<a href="#binance-加密交易" class="hash-link" aria-label="Binance 加密交易的直接链接" title="Binance 加密交易的直接链接" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Binance may reduce margin with leverage</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">set_margin_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">LeveragedMarginModel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">margin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">calculate_margin_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> quantity</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Result: Margin reduced by leverage factor</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="模型选择">模型选择<a href="#模型选择" class="hash-link" aria-label="模型选择的直接链接" title="模型选择的直接链接" translate="no">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="使用默认模型">使用默认模型<a href="#使用默认模型" class="hash-link" aria-label="使用默认模型的直接链接" title="使用默认模型的直接链接" translate="no">​</a></h4>
<p>默认的 <code>LeveragedMarginModel</code> 可直接使用：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">account </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> TestExecStubs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">margin_account</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">margin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">calculate_margin_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> quantity</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="使用标准模型">使用标准模型<a href="#使用标准模型" class="hash-link" aria-label="使用标准模型的直接链接" title="使用标准模型的直接链接" translate="no">​</a></h4>
<p>若需模拟传统经纪商行为：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">set_margin_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">StandardMarginModel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">margin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">calculate_margin_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> quantity</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="自定义模型">自定义模型<a href="#自定义模型" class="hash-link" aria-label="自定义模型的直接链接" title="自定义模型的直接链接" translate="no">​</a></h3>
<p>你可以通过继承 <code>MarginModel</code> 来创建自定义保证金模型。自定义模型通过 <code>MarginModelConfig</code> 接收配置：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backtest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">models </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> MarginModel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backtest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> MarginModelConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">RiskAdjustedMarginModel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">MarginModel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> MarginModelConfig</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;Initialize with configuration parameters.&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">risk_multiplier </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Decimal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;risk_multiplier&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">use_leverage </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;use_leverage&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">calculate_margin_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> instrument</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> quantity</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> leverage</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> use_quote_for_inverse</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    notional </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> instrument</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">notional_value</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">quantity</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> use_quote_for_inverse</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">use_leverage</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      adjusted_notional </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> notional</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">as_decimal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> leverage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      adjusted_notional </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> notional</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">as_decimal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    margin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> adjusted_notional </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> instrument</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">margin_init </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">risk_multiplier</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Money</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">margin</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> instrument</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">quote_currency</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">calculate_margin_maint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> instrument</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> side</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> quantity</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> leverage</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> use_quote_for_inverse</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">calculate_margin_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> quantity</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> leverage</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> use_quote_for_inverse</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="使用自定义模型">使用自定义模型<a href="#使用自定义模型" class="hash-link" aria-label="使用自定义模型的直接链接" title="使用自定义模型的直接链接" translate="no">​</a></h4>
<p><strong>编程方式：</strong></p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backtest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> MarginModelConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backtest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> MarginModelFactory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> MarginModelConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  model_type</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;my_package.my_module:RiskAdjustedMarginModel&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  config</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;risk_multiplier&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;use_leverage&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">custom_model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> MarginModelFactory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">set_margin_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">custom_model</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="高层回测-api-配置">高层回测 API 配置<a href="#高层回测-api-配置" class="hash-link" aria-label="高层回测 API 配置的直接链接" title="高层回测 API 配置的直接链接" translate="no">​</a></h3>
<p>在使用高层回测 API 时，你可以在 venue 配置中通过 <code>MarginModelConfig</code> 指定保证金模型：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backtest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> MarginModelConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backtest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> BacktestVenueConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> BacktestRunConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Configure venue with specific margin model</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">venue_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BacktestVenueConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;SIM&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  oms_type</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;NETTING&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  account_type</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;MARGIN&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  starting_balances</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;1_000_000 USD&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  margin_model</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">MarginModelConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    model_type</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;standard&quot;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Use standard model for traditional broker simulation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Use in backtest configuration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BacktestRunConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  venues</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">venue_config</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># ... other config</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="配置示例">配置示例<a href="#配置示例" class="hash-link" aria-label="配置示例的直接链接" title="配置示例的直接链接" translate="no">​</a></h4>
<p><strong>Standard 模型（传统经纪商）：</strong></p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">margin_model</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">MarginModelConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model_type</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;standard&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>Leveraged 模型（默认）：</strong></p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">margin_model</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">MarginModelConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model_type</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;leveraged&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Default</span><br></span></code></pre></div></div>
<p><strong>带配置的自定义模型：</strong></p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">margin_model</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">MarginModelConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  model_type</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;my_package.my_module:CustomMarginModel&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  config</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;risk_multiplier&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;use_leverage&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;volatility_threshold&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.02</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>回测执行时，系统会自动将所选保证金模型应用到模拟的交易所中。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/Aloento/NautilusTraderDoc/tree/main/docs/concepts/backtesting.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_F7ru" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_GNoA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/concepts/architecture"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">架构</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/concepts/cache"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">Cache</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_pg_n thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#选择哪个-api-层级" class="table-of-contents__link toc-highlight">选择哪个 API 层级</a></li><li><a href="#底层-apilow-level-api" class="table-of-contents__link toc-highlight">底层 API（Low-level API）</a></li><li><a href="#高层-apihigh-level-api" class="table-of-contents__link toc-highlight">高层 API（High-level API）</a></li><li><a href="#数据data" class="table-of-contents__link toc-highlight">数据（Data）</a><ul><li><a href="#数据选择成本与准确度的权衡" class="table-of-contents__link toc-highlight">数据选择：成本与准确度的权衡</a></li></ul></li><li><a href="#交易场所venues" class="table-of-contents__link toc-highlight">交易场所（Venues）</a></li><li><a href="#执行execution" class="table-of-contents__link toc-highlight">执行（Execution）</a><ul><li><a href="#数据与消息的时序" class="table-of-contents__link toc-highlight">数据与消息的时序</a></li><li><a href="#基于-bar-的执行" class="table-of-contents__link toc-highlight">基于 Bar 的执行</a></li><li><a href="#滑点slippage与点差spread处理" class="table-of-contents__link toc-highlight">滑点（Slippage）与点差（Spread）处理</a></li><li><a href="#fill-模型fill-model" class="table-of-contents__link toc-highlight">Fill 模型（Fill model）</a></li></ul></li><li><a href="#账户类型account-types" class="table-of-contents__link toc-highlight">账户类型（Account types）</a><ul><li><a href="#现金账户cash-accounts" class="table-of-contents__link toc-highlight">现金账户（Cash accounts）</a></li><li><a href="#保证金账户margin-accounts" class="table-of-contents__link toc-highlight">保证金账户（Margin accounts）</a></li><li><a href="#投注账户betting-accounts" class="table-of-contents__link toc-highlight">投注账户（Betting accounts）</a></li></ul></li><li><a href="#保证金模型margin-models" class="table-of-contents__link toc-highlight">保证金模型（Margin models）</a><ul><li><a href="#概览" class="table-of-contents__link toc-highlight">概览</a></li><li><a href="#可用模型" class="table-of-contents__link toc-highlight">可用模型</a></li><li><a href="#使用方法" class="table-of-contents__link toc-highlight">使用方法</a></li><li><a href="#真实场景示例" class="table-of-contents__link toc-highlight">真实场景示例</a></li><li><a href="#模型选择" class="table-of-contents__link toc-highlight">模型选择</a></li><li><a href="#自定义模型" class="table-of-contents__link toc-highlight">自定义模型</a></li><li><a href="#高层回测-api-配置" class="table-of-contents__link toc-highlight">高层回测 API 配置</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title"></div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/nautechsystems/nautilus_trader" target="_blank" rel="noopener noreferrer" class="footer__link-item">Official GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_KfBJ"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://nautilustrader.io/docs" target="_blank" rel="noopener noreferrer" class="footer__link-item">Official Documentation<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_KfBJ"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">© 2025 Nautech Systems Pty Ltd. All rights reserved.</div></div></div></footer></div>
</body>
</html>