<!doctype html>
<html lang="zh" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-concepts/backtesting" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.1">
<title data-rh="true">Backtesting | NautilusTrader 文档</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://nautilus.aloen.to/concepts/backtesting"><meta data-rh="true" property="og:locale" content="zh"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Backtesting | NautilusTrader 文档"><meta data-rh="true" name="description" content="Backtesting with NautilusTrader is a methodical simulation process that replicates trading"><meta data-rh="true" property="og:description" content="Backtesting with NautilusTrader is a methodical simulation process that replicates trading"><link data-rh="true" rel="icon" href="/logo.png"><link data-rh="true" rel="canonical" href="https://nautilus.aloen.to/concepts/backtesting"><link data-rh="true" rel="alternate" href="https://nautilus.aloen.to/concepts/backtesting" hreflang="zh"><link data-rh="true" rel="alternate" href="https://nautilus.aloen.to/concepts/backtesting" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Concepts","item":"https://nautilus.aloen.to/concepts/"},{"@type":"ListItem","position":2,"name":"Backtesting","item":"https://nautilus.aloen.to/concepts/backtesting"}]}</script><link rel="stylesheet" href="/assets/css/styles.33db920f.css">
<script src="/assets/js/runtime~main.4ed1c191.js" defer="defer"></script>
<script src="/assets/js/main.3352860b.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/logo.png"><div role="region" aria-label="跳到主要内容"><a class="skipToContent__uWo" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/logo.png" alt="NautilusTrader Logo" class="themedComponent_WkLn themedComponent--light_cjoX"><img src="/logo.png" alt="NautilusTrader Logo" class="themedComponent_WkLn themedComponent--dark_jZId"></div><b class="navbar__title text--truncate">NautilusTrader</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/api_reference/">文档</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/Aloento/NautilusTraderDoc" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_KfBJ"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_RWFU colorModeToggle_sA1q"><button class="clean-btn toggleButton_qjfc toggleButtonDisabled_cpNp" type="button" disabled="" title="system mode" aria-label="切换浅色/暗黑模式（当前为system mode）"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_CetX lightToggleIcon_UYsV"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_CetX darkToggleIcon_i1s2"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_CetX systemToggleIcon_yIQx"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_PsjF"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_jk42"><div class="docsWrapper_KWBO"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_XpKL" type="button"></button><div class="docRoot_joIP"><aside class="theme-doc-sidebar-container docSidebarContainer_DOen"><div class="sidebarViewport_j7YP"><div class="sidebar_nPgc"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_MTDt"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_GgI9 menu__link menu__link--sublist" href="/api_reference/"><span title="Python API" class="categoryLinkLabel_XKxb">Python API</span></a><button aria-label="展开侧边栏分类 &#x27;Python API&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_GgI9 menu__link menu__link--sublist menu__link--active" href="/concepts/"><span title="Concepts" class="categoryLinkLabel_XKxb">Concepts</span></a><button aria-label="折叠侧边栏分类 &#x27;Concepts&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/actors"><span title="Actors" class="linkLabel_CNtA">Actors</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/adapters"><span title="Adapters" class="linkLabel_CNtA">Adapters</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/architecture"><span title="Architecture" class="linkLabel_CNtA">Architecture</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/concepts/backtesting"><span title="Backtesting" class="linkLabel_CNtA">Backtesting</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/cache"><span title="Cache" class="linkLabel_CNtA">Cache</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/data"><span title="Data" class="linkLabel_CNtA">Data</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/execution"><span title="Execution" class="linkLabel_CNtA">Execution</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/instruments"><span title="Instruments" class="linkLabel_CNtA">Instruments</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/live"><span title="Live Trading" class="linkLabel_CNtA">Live Trading</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/logging"><span title="Logging" class="linkLabel_CNtA">Logging</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/message_bus"><span title="Message Bus" class="linkLabel_CNtA">Message Bus</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/orders"><span title="Orders" class="linkLabel_CNtA">Orders</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/overview"><span title="Overview" class="linkLabel_CNtA">Overview</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/portfolio"><span title="Portfolio" class="linkLabel_CNtA">Portfolio</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/positions"><span title="Positions" class="linkLabel_CNtA">Positions</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/reports"><span title="Reports" class="linkLabel_CNtA">Reports</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/strategies"><span title="Strategies" class="linkLabel_CNtA">Strategies</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_GgI9 menu__link menu__link--sublist" href="/developer_guide/"><span title="Developer Guide" class="categoryLinkLabel_XKxb">Developer Guide</span></a><button aria-label="展开侧边栏分类 &#x27;Developer Guide&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_GgI9 menu__link menu__link--sublist" href="/getting_started/"><span title="入门" class="categoryLinkLabel_XKxb">入门</span></a><button aria-label="展开侧边栏分类 &#x27;入门&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_GgI9 menu__link menu__link--sublist" href="/integrations/"><span title="Integrations" class="categoryLinkLabel_XKxb">Integrations</span></a><button aria-label="展开侧边栏分类 &#x27;Integrations&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_GgI9 menu__link menu__link--sublist" href="/tutorials/"><span title="Tutorials" class="categoryLinkLabel_XKxb">Tutorials</span></a><button aria-label="展开侧边栏分类 &#x27;Tutorials&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_bw1l"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_PIhC"><div class="docItemContainer_pFw3"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_HRKZ" aria-label="页面路径"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_sX5c"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/concepts/"><span>Concepts</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Backtesting</span></li></ul></nav><div class="tocCollapsible_DhUt theme-doc-toc-mobile tocMobile_Izjv"><button type="button" class="clean-btn tocCollapsibleButton_eYR5">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>Backtesting</h1></header>
<p>Backtesting with NautilusTrader is a methodical simulation process that replicates trading
activities using a specific system implementation. This system is composed of various components
including the built-in engines, <code>Cache</code>, <a href="/concepts/message_bus">MessageBus</a>, <code>Portfolio</code>, <a href="/concepts/actors">Actors</a>, <a href="/concepts/strategies">Strategies</a>, <a href="/concepts/execution">Execution Algorithms</a>,
and other user-defined modules. The entire trading simulation is predicated on a stream of historical data processed by a
<code>BacktestEngine</code>. Once this data stream is exhausted, the engine concludes its operation, producing
detailed results and performance metrics for in-depth analysis.</p>
<p>It&#x27;s important to recognize that NautilusTrader offers two distinct API levels for setting up and conducting backtests:</p>
<ul>
<li><strong>High-level API</strong>: Uses a <code>BacktestNode</code> and configuration objects (<code>BacktestEngine</code>s are used internally).</li>
<li><strong>Low-level API</strong>: Uses a <code>BacktestEngine</code> directly with more &quot;manual&quot; setup.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="choosing-an-api-level">Choosing an API level<a href="#choosing-an-api-level" class="hash-link" aria-label="Choosing an API level的直接链接" title="Choosing an API level的直接链接" translate="no">​</a></h2>
<p>Consider using the <strong>low-level</strong> API when:</p>
<ul>
<li>Your entire data stream can be processed within the available machine resources (e.g., RAM).</li>
<li>You prefer not to store data in the Nautilus-specific Parquet format.</li>
<li>You have a specific need or preference to retain raw data in its original format (e.g., CSV, binary, etc.).</li>
<li>You require fine-grained control over the <code>BacktestEngine</code>, such as the ability to re-run backtests on identical datasets while swapping out components (e.g., actors or strategies) or adjusting parameter configurations.</li>
</ul>
<p>Consider using the <strong>high-level</strong> API when:</p>
<ul>
<li>Your data stream exceeds available memory, requiring streaming data in batches.</li>
<li>You want to leverage the performance and convenience of the <code>ParquetDataCatalog</code> for storing data in the Nautilus-specific Parquet format.</li>
<li>You value the flexibility and functionality of passing configuration objects to define and manage multiple backtest runs across various engines simultaneously.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="low-level-api">Low-level API<a href="#low-level-api" class="hash-link" aria-label="Low-level API的直接链接" title="Low-level API的直接链接" translate="no">​</a></h2>
<p>The low-level API centers around a <code>BacktestEngine</code>, where inputs are initialized and added manually via a Python script.
An instantiated <code>BacktestEngine</code> can accept the following:</p>
<ul>
<li>Lists of <code>Data</code> objects, which are automatically sorted into monotonic order based on <code>ts_init</code>.</li>
<li>Multiple venues, manually initialized.</li>
<li>Multiple actors, manually initialized and added.</li>
<li>Multiple execution algorithms, manually initialized and added.</li>
</ul>
<p>This approach offers detailed control over the backtesting process, allowing you to manually configure each component.</p>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="high-level-api">High-level API<a href="#high-level-api" class="hash-link" aria-label="High-level API的直接链接" title="High-level API的直接链接" translate="no">​</a></h2>
<p>The high-level API centers around a <code>BacktestNode</code>, which orchestrates the management of multiple <code>BacktestEngine</code> instances,
each defined by a <code>BacktestRunConfig</code>. Multiple configurations can be bundled into a list and processed by the node in one run.</p>
<p>Each <code>BacktestRunConfig</code> object consists of the following:</p>
<ul>
<li>A list of <code>BacktestDataConfig</code> objects.</li>
<li>A list of <code>BacktestVenueConfig</code> objects.</li>
<li>A list of <code>ImportableActorConfig</code> objects.</li>
<li>A list of <code>ImportableStrategyConfig</code> objects.</li>
<li>A list of <code>ImportableExecAlgorithmConfig</code> objects.</li>
<li>An optional <code>ImportableControllerConfig</code> object.</li>
<li>An optional <code>BacktestEngineConfig</code> object, with a default configuration if not specified.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="data">Data<a href="#data" class="hash-link" aria-label="Data的直接链接" title="Data的直接链接" translate="no">​</a></h2>
<p>Data provided for backtesting drives the execution flow. Since a variety of data types can be used,
it&#x27;s crucial that your venue configurations align with the data being provided for backtesting.
Mismatches between data and configuration can lead to unexpected behavior during execution.</p>
<p>NautilusTrader is primarily designed and optimized for order book data, which provides
a complete representation of every price level or order in the market, reflecting the real-time behavior of a trading venue.
This ensures the highest level of execution granularity and realism. However, if granular order book data is either not
available or necessary, then the platform has the capability of processing market data in the following descending order of detail:</p>
<ol>
<li>
<p><strong>Order Book Data/Deltas (L3 market-by-order)</strong>:</p>
<ul>
<li>Providing comprehensive market depth and detailed order flow, with visibility of all individual orders.</li>
</ul>
</li>
<li>
<p><strong>Order Book Data/Deltas (L2 market-by-price)</strong>:</p>
<ul>
<li>Providing market depth visibility across all price levels.</li>
</ul>
</li>
<li>
<p><strong>Quote Ticks (L1 market-by-price)</strong>:</p>
<ul>
<li>Representing the &quot;top of the book&quot; by capturing only the best bid and ask prices and sizes.</li>
</ul>
</li>
<li>
<p><strong>Trade Ticks</strong>:</p>
<ul>
<li>Reflecting actual executed trades, offering a precise view of transaction activity.</li>
</ul>
</li>
<li>
<p><strong>Bars</strong>:</p>
<ul>
<li>Aggregating trading activity - typically over fixed time intervals, such as 1-minute, 1-hour, or 1-day.</li>
</ul>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="choosing-data-cost-vs-accuracy">Choosing data: cost vs. accuracy<a href="#choosing-data-cost-vs-accuracy" class="hash-link" aria-label="Choosing data: cost vs. accuracy的直接链接" title="Choosing data: cost vs. accuracy的直接链接" translate="no">​</a></h3>
<p>For many trading strategies, bar data (e.g., 1-minute) can be sufficient for backtesting and strategy development. This is
particularly important because bar data is typically much more accessible and cost-effective compared to tick or order book data.</p>
<p>Given this practical reality, Nautilus is designed to support bar-based backtesting with advanced features
that maximize simulation accuracy, even when working with lower granularity data.</p>
<div class="theme-admonition theme-admonition-tip admonition_lEzE alert alert--success"><div class="admonitionHeading_aAf0"><span class="admonitionIcon_xtBN"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>提示</div><div class="admonitionContent_Vfkp"><p>For some trading strategies, it can be practical to start development with bar data to validate core trading ideas.
If the strategy looks promising, but is more sensitive to precise execution timing (e.g., requires fills at specific prices
between OHLC levels, or uses tight take-profit/stop-loss levels), you can then invest in higher granularity data
for more accurate validation.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="venues">Venues<a href="#venues" class="hash-link" aria-label="Venues的直接链接" title="Venues的直接链接" translate="no">​</a></h2>
<p>When initializing a venue for backtesting, you must specify its internal order <code>book_type</code> for execution processing from the following options:</p>
<ul>
<li><code>L1_MBP</code>: Level 1 market-by-price (default). Only the top level of the order book is maintained.</li>
<li><code>L2_MBP</code>: Level 2 market-by-price. Order book depth is maintained, with a single order aggregated per price level.</li>
<li><code>L3_MBO</code>: Level 3 market-by-order. Order book depth is maintained, with all individual orders tracked as provided by the data.</li>
</ul>
<div class="theme-admonition theme-admonition-note admonition_lEzE alert alert--secondary"><div class="admonitionHeading_aAf0"><span class="admonitionIcon_xtBN"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_Vfkp"><p>The granularity of the data must match the specified order <code>book_type</code>. Nautilus cannot generate higher granularity data (L2 or L3) from lower-level data such as quotes, trades, or bars.</p></div></div>
<div class="theme-admonition theme-admonition-warning admonition_lEzE alert alert--warning"><div class="admonitionHeading_aAf0"><span class="admonitionIcon_xtBN"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_Vfkp"><p>If you specify <code>L2_MBP</code> or <code>L3_MBO</code> as the venue’s <code>book_type</code>, all non-order book data (such as quotes, trades, and bars) will be ignored for execution processing.
This may cause orders to appear as though they are never filled. We are actively working on improved validation logic to prevent configuration and data mismatches.</p></div></div>
<div class="theme-admonition theme-admonition-warning admonition_lEzE alert alert--warning"><div class="admonitionHeading_aAf0"><span class="admonitionIcon_xtBN"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_Vfkp"><p>When providing L2 or higher order book data, ensure that the <code>book_type</code> is updated to reflect the data&#x27;s granularity.
Failing to do so will result in data aggregation: L2 data will be reduced to a single order per level, and L1 data will reflect only top-of-book levels.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="execution">Execution<a href="#execution" class="hash-link" aria-label="Execution的直接链接" title="Execution的直接链接" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="data-and-message-sequencing">Data and message sequencing<a href="#data-and-message-sequencing" class="hash-link" aria-label="Data and message sequencing的直接链接" title="Data and message sequencing的直接链接" translate="no">​</a></h3>
<p>In the main backtesting loop, new market data is first processed for the execution of existing orders before being processed
by the data engine that will then send data to strategies.</p>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="bar-based-execution">Bar based execution<a href="#bar-based-execution" class="hash-link" aria-label="Bar based execution的直接链接" title="Bar based execution的直接链接" translate="no">​</a></h3>
<p>Bar data provides a summary of market activity with four key prices for each time period (assuming bars are aggregated by trades):</p>
<ul>
<li><strong>Open</strong>: opening price (first trade)</li>
<li><strong>High</strong>: highest price traded</li>
<li><strong>Low</strong>: lowest price traded</li>
<li><strong>Close</strong>: closing price (last trade)</li>
</ul>
<p>While this gives us an overview of price movement, we lose some important information that we&#x27;d have with more granular data:</p>
<ul>
<li>We don&#x27;t know in what order the market hit the high and low prices.</li>
<li>We can&#x27;t see exactly when prices changed within the time period.</li>
<li>We don&#x27;t know the actual sequence of trades that occurred.</li>
</ul>
<p>This is why Nautilus processes bar data through a system that attempts to maintain
the most realistic yet conservative market behavior possible, despite these limitations.
At its core, the platform always maintains an order book simulation - even when you provide less
granular data such as quotes, trades, or bars (although the simulation will only have a top level book).</p>
<div class="theme-admonition theme-admonition-warning admonition_lEzE alert alert--warning"><div class="admonitionHeading_aAf0"><span class="admonitionIcon_xtBN"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_Vfkp"><p>When using bars for execution simulation (enabled by default with <code>bar_execution=True</code> in venue configurations),
Nautilus strictly expects the timestamp (<code>ts_init</code>) of each bar to represent its <strong>closing time</strong>.
This ensures accurate chronological processing, prevents look-ahead bias, and aligns market updates (Open → High → Low → Close) with the moment the bar is complete.</p></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="bar-timestamp-convention">Bar timestamp convention<a href="#bar-timestamp-convention" class="hash-link" aria-label="Bar timestamp convention的直接链接" title="Bar timestamp convention的直接链接" translate="no">​</a></h4>
<p>If your data source provides bars timestamped at the <strong>opening time</strong> (common in some providers), you must adjust them to the closing time before loading into Nautilus.
Failure to do so can lead to incorrect order fills, event sequencing errors, or unrealistic backtest results.</p>
<ul>
<li>Use adapter-specific configurations like <code>bars_timestamp_on_close=True</code> (e.g., for Bybit or Databento adapters) to handle this automatically during data ingestion.</li>
<li>For custom data, manually shift timestamps by the bar duration (e.g., add 1 minute for <code>1-MINUTE</code> bars).</li>
<li>Always verify your data&#x27;s timestamp convention with a small sample to avoid simulation inaccuracies.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="processing-bar-data">Processing bar data<a href="#processing-bar-data" class="hash-link" aria-label="Processing bar data的直接链接" title="Processing bar data的直接链接" translate="no">​</a></h4>
<p>Even when you provide bar data, Nautilus maintains an internal order book for each instrument - just like a real venue would.</p>
<ol>
<li>
<p><strong>Time processing</strong>:</p>
<ul>
<li>Nautilus has a specific way of handling the timing of bar data <em>for execution</em> that&#x27;s crucial for accurate simulation.</li>
<li>Bar timestamps (<code>ts_event</code>) are expected to represent the close time of the bar. This approach is most logical because it represents the moment when the bar is fully formed and its aggregation is complete.</li>
<li>The initialization time (<code>ts_init</code>) can be controlled using the <code>ts_init_delta</code> parameter in <code>BarDataWrangler</code>, which should typically be set to the bar&#x27;s step size (timeframe) in nanoseconds.</li>
<li>The platform ensures all events happen in the correct sequence based on these timestamps, preventing any possibility of look-ahead bias in your backtests.</li>
</ul>
</li>
<li>
<p><strong>Price processing</strong>:</p>
<ul>
<li>The platform converts each bar&#x27;s OHLC prices into a sequence of market updates.</li>
<li>These updates always follow the same order: Open → High → Low → Close.</li>
<li>If you provide multiple timeframes (like both 1-minute and 5-minute bars), the platform uses the more granular data for highest accuracy.</li>
</ul>
</li>
<li>
<p><strong>Executions</strong>:</p>
<ul>
<li>When you place orders, they interact with the simulated order book just like they would on a real venue.</li>
<li>For MARKET orders, execution happens at the current simulated market price plus any configured latency.</li>
<li>For LIMIT orders working in the market, they&#x27;ll execute if any of the bar&#x27;s prices reach or cross your limit price (see below).</li>
<li>The matching engine continuously processes orders as OHLC prices move, rather than waiting for complete bars.</li>
</ul>
</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="ohlc-prices-simulation">OHLC prices simulation<a href="#ohlc-prices-simulation" class="hash-link" aria-label="OHLC prices simulation的直接链接" title="OHLC prices simulation的直接链接" translate="no">​</a></h4>
<p>During backtest execution, each bar is converted into a sequence of four price points:</p>
<ol>
<li>Opening price</li>
<li>High price <em>(Order between High/Low is configurable. See <code>bar_adaptive_high_low_ordering</code> below.)</em></li>
<li>Low price</li>
<li>Closing price</li>
</ol>
<p>The trading volume for that bar is <strong>split evenly</strong> among these four points (25% each). In marginal cases,
if the original bar&#x27;s volume divided by 4 is less than the instrument&#x27;s minimum <code>size_increment</code>,
we still use the minimum <code>size_increment</code> per price point to ensure valid market activity (e.g., 1 contract
for CME group exchanges).</p>
<p>How these price points are sequenced can be controlled via the <code>bar_adaptive_high_low_ordering</code> parameter when configuring a venue.</p>
<p>Nautilus supports two modes of bar processing:</p>
<ol>
<li>
<p><strong>Fixed ordering</strong> (<code>bar_adaptive_high_low_ordering=False</code>, default)</p>
<ul>
<li>Processes every bar in a fixed sequence: <code>Open → High → Low → Close</code>.</li>
<li>Simple and deterministic approach.</li>
</ul>
</li>
<li>
<p><strong>Adaptive ordering</strong> (<code>bar_adaptive_high_low_ordering=True</code>)</p>
<ul>
<li>Uses bar structure to estimate likely price path:<!-- -->
<ul>
<li>If Open is closer to High: processes as <code>Open → High → Low → Close</code>.</li>
<li>If Open is closer to Low: processes as <code>Open → Low → High → Close</code>.</li>
</ul>
</li>
<li><a href="https://gist.github.com/stefansimik/d387e1d9ff784a8973feca0cde51e363" target="_blank" rel="noopener noreferrer">Research</a> shows this approach achieves ~75-85% accuracy in predicting correct High/Low sequence (compared to statistical ~50% accuracy with fixed ordering).</li>
<li>This is particularly important when both take-profit and stop-loss levels occur within the same bar - as the sequence determines which order fills first.</li>
</ul>
</li>
</ol>
<p>Here&#x27;s how to configure adaptive bar ordering for a venue, including account setup:</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backtest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">engine </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> BacktestEngine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">enums </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> OmsType</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> AccountType</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Money</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Currency</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Initialize the backtest engine</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">engine </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BacktestEngine</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Add a venue with adaptive bar ordering and required account settings</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">engine</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add_venue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    venue</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">venue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Your Venue identifier, e.g., Venue(&quot;BINANCE&quot;)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    oms_type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">OmsType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NETTING</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    account_type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">AccountType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CASH</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    starting_balances</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Money</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">10_000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Currency</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;USDT&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bar_adaptive_high_low_ordering</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Enable adaptive ordering of High/Low bar prices</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="slippage-and-spread-handling">Slippage and spread handling<a href="#slippage-and-spread-handling" class="hash-link" aria-label="Slippage and spread handling的直接链接" title="Slippage and spread handling的直接链接" translate="no">​</a></h3>
<p>When backtesting with different types of data, Nautilus implements specific handling for slippage and spread simulation:</p>
<p>For L2 (market-by-price) or L3 (market-by-order) data, slippage is simulated with high accuracy by:</p>
<ul>
<li>Filling orders against actual order book levels.</li>
<li>Matching available size at each price level sequentially.</li>
<li>Maintaining realistic order book depth impact (per order fill).</li>
</ul>
<p>For L1 data types (e.g., L1 order book, trades, quotes, bars), slippage is handled through:</p>
<p><strong>Initial fill slippage</strong> (<code>prob_slippage</code>):</p>
<ul>
<li>Controlled by the <code>prob_slippage</code> parameter of the <code>FillModel</code>.</li>
<li>Determines if the initial fill will occur one tick away from current market price.</li>
<li>Example: With <code>prob_slippage=0.5</code>, a market BUY has 50% chance of filling one tick above the best ask price.</li>
</ul>
<div class="theme-admonition theme-admonition-note admonition_lEzE alert alert--secondary"><div class="admonitionHeading_aAf0"><span class="admonitionIcon_xtBN"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_Vfkp"><p>When backtesting with bar data, be aware that the reduced granularity of price information affects the slippage mechanism.
For the most realistic backtesting results, consider using higher granularity data sources such as L2 or L3 order book data when available.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="fill-model">Fill model<a href="#fill-model" class="hash-link" aria-label="Fill model的直接链接" title="Fill model的直接链接" translate="no">​</a></h3>
<p>The <code>FillModel</code> helps simulate order queue position and execution in a simple probabilistic way during backtesting.
It addresses a fundamental challenge: <em>even with perfect historical market data, we can&#x27;t fully simulate how orders may have interacted with other
market participants in real-time</em>.</p>
<p>The <code>FillModel</code> simulates two key aspects of trading that exist in real markets regardless of data quality:</p>
<ol>
<li>
<p><strong>Queue position for limit orders</strong>:</p>
<ul>
<li>When multiple traders place orders at the same price level, the order&#x27;s position in the queue affects if and when it gets filled.</li>
</ul>
</li>
<li>
<p><strong>Market impact and competition</strong>:</p>
<ul>
<li>When taking liquidity with market orders, you compete with other traders for available liquidity, which can affect your fill price.</li>
</ul>
</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="configuration-and-parameters">Configuration and parameters<a href="#configuration-and-parameters" class="hash-link" aria-label="Configuration and parameters的直接链接" title="Configuration and parameters的直接链接" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backtest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">models </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> FillModel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backtest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> BacktestEngineConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backtest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">engine </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> BacktestEngine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Create a custom fill model with your desired probabilities</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fill_model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> FillModel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    prob_fill_on_limit</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Chance a limit order fills when price matches (applied to bars/trades/quotes + L1/L2/L3 order book)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    prob_fill_on_stop</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.95</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># [DEPRECATED] Will be removed in a future version, use `prob_slippage` instead</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    prob_slippage</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic"># Chance of 1-tick slippage (applied to bars/trades/quotes + L1 order book only)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    random_seed</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># Optional: Set for reproducible results</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Add the fill model to your engine configuration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">engine </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BacktestEngine</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">BacktestEngineConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        trader_id</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;TESTER-001&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fill_model</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">fill_model</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Inject your custom fill model here</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>prob_fill_on_limit</strong> (default: <code>1.0</code>)</p>
<ul>
<li>Purpose:<!-- -->
<ul>
<li>Simulates the probability of a limit order getting filled when its price level is reached in the market.</li>
</ul>
</li>
<li>Details:<!-- -->
<ul>
<li>Simulates your position in the order queue at a given price level.</li>
<li>Applies to all data types (e.g., L1/L2/L3 order book, quotes, trades, bars).</li>
<li>New random probability check occurs each time market price touches your order price (but does not move through it).</li>
<li>On successful probability check, fills entire remaining order quantity.</li>
</ul>
</li>
</ul>
<p><strong>Examples</strong>:</p>
<ul>
<li>With <code>prob_fill_on_limit=0.0</code>:<!-- -->
<ul>
<li>Limit BUY orders never fill when best ask reaches the limit price.</li>
<li>Limit SELL orders never fill when best bid reaches the limit price.</li>
<li>This simulates being at the very back of the queue and never reaching the front.</li>
</ul>
</li>
<li>With <code>prob_fill_on_limit=0.5</code>:<!-- -->
<ul>
<li>Limit BUY orders have 50% chance of filling when best ask reaches the limit price.</li>
<li>Limit SELL orders have 50% chance of filling when best bid reaches the limit price.</li>
<li>This simulates being in the middle of the queue.</li>
</ul>
</li>
<li>With <code>prob_fill_on_limit=1.0</code> (default):<!-- -->
<ul>
<li>Limit BUY orders always fill when best ask reaches the limit price.</li>
<li>Limit SELL orders always fill when best bid reaches the limit price.</li>
<li>This simulates being at the front of the queue with guaranteed fills.</li>
</ul>
</li>
</ul>
<p><strong>prob_slippage</strong> (default: <code>0.0</code>)</p>
<ul>
<li>Purpose:<!-- -->
<ul>
<li>Simulates the probability of experiencing price slippage when executing market orders.</li>
</ul>
</li>
<li>Details:<!-- -->
<ul>
<li>Only applies to L1 data types (e.g., quotes, trades, bars).</li>
<li>When triggered, moves fill price one tick against your order direction.</li>
<li>Affects all market-type orders (<code>MARKET</code>, <code>MARKET_TO_LIMIT</code>, <code>MARKET_IF_TOUCHED</code>, <code>STOP_MARKET</code>).</li>
<li>Not utilized with L2/L3 data where order book depth can determine slippage.</li>
</ul>
</li>
</ul>
<p><strong>Examples</strong>:</p>
<ul>
<li>With <code>prob_slippage=0.0</code> (default):<!-- -->
<ul>
<li>No artificial slippage is applied, representing an idealized scenario where you always get filled at the current market price.</li>
</ul>
</li>
<li>With <code>prob_slippage=0.5</code>:<!-- -->
<ul>
<li>Market BUY orders have 50% chance of filling one tick above the best ask price, and 50% chance at the best ask price.</li>
<li>Market SELL orders have 50% chance of filling one tick below the best bid price, and 50% chance at the best bid price.</li>
</ul>
</li>
<li>With <code>prob_slippage=1.0</code>:<!-- -->
<ul>
<li>Market BUY orders always fill one tick above the best ask price.</li>
<li>Market SELL orders always fill one tick below the best bid price.</li>
<li>This simulates consistent adverse price movement against your orders.</li>
</ul>
</li>
</ul>
<p><strong>prob_fill_on_stop</strong> (default: <code>1.0</code>)</p>
<ul>
<li>Stop order is just shorter name for stop-market order, that convert to market orders when market-price touches the stop-price.</li>
<li>That means, stop order order-fill mechanics is simply market-order mechanics, that is controlled by the <code>prob_slippage</code> parameter.</li>
</ul>
<div class="theme-admonition theme-admonition-warning admonition_lEzE alert alert--warning"><div class="admonitionHeading_aAf0"><span class="admonitionIcon_xtBN"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_Vfkp"><p>The <code>prob_fill_on_stop</code> parameter is deprecated and will be removed in a future version (use <code>prob_slippage</code> instead).</p></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="how-simulation-varies-by-data-type">How simulation varies by data type<a href="#how-simulation-varies-by-data-type" class="hash-link" aria-label="How simulation varies by data type的直接链接" title="How simulation varies by data type的直接链接" translate="no">​</a></h4>
<p>The behavior of the <code>FillModel</code> adapts based on the order book type being used:</p>
<p><strong>L2/L3 order book data</strong></p>
<p>With full order book depth, the <code>FillModel</code> focuses purely on simulating queue position for limit orders through <code>prob_fill_on_limit</code>.
The order book itself handles slippage naturally based on available liquidity at each price level.</p>
<ul>
<li><code>prob_fill_on_limit</code> is active - simulates queue position.</li>
<li><code>prob_slippage</code> is not used - real order book depth determines price impact.</li>
</ul>
<p><strong>L1 order book data</strong></p>
<p>With only best bid/ask prices available, the <code>FillModel</code> provides additional simulation:</p>
<ul>
<li><code>prob_fill_on_limit</code> is active - simulates queue position.</li>
<li><code>prob_slippage</code> is active - simulates basic price impact since we lack real depth information.</li>
</ul>
<p><strong>Bar/Quote/Trade data</strong></p>
<p>When using less granular data, the same behaviors apply as L1:</p>
<ul>
<li><code>prob_fill_on_limit</code> is active - simulates queue position.</li>
<li><code>prob_slippage</code> is active - simulates basic price impact.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="important-considerations">Important considerations<a href="#important-considerations" class="hash-link" aria-label="Important considerations的直接链接" title="Important considerations的直接链接" translate="no">​</a></h4>
<p>The <code>FillModel</code> has certain limitations to keep in mind:</p>
<ul>
<li><strong>Partial fills are supported</strong> with L2/L3 order book data - when there is no longer any size available in the order book, no more fills will be generated and the order will remain in a partially filled state. This accurately simulates real market conditions where not enough liquidity is available at the desired price levels.</li>
<li>With L1 data, slippage limits to a fixed 1-tick, at which the system fills the entire order&#x27;s quantity.</li>
</ul>
<div class="theme-admonition theme-admonition-note admonition_lEzE alert alert--secondary"><div class="admonitionHeading_aAf0"><span class="admonitionIcon_xtBN"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_Vfkp"><p>As the <code>FillModel</code> continues to evolve, future versions may introduce more sophisticated simulation of order execution dynamics, including:</p><ul>
<li>Partial fill simulation.</li>
<li>Variable slippage based on order size.</li>
<li>More complex queue position modeling.</li>
</ul></div></div>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="account-types">Account types<a href="#account-types" class="hash-link" aria-label="Account types的直接链接" title="Account types的直接链接" translate="no">​</a></h2>
<p>When you attach a venue to the engine—either for live trading or a back‑test—you must pick one of three accounting modes by passing the <code>account_type</code> parameter:</p>
<table><thead><tr><th>Account type</th><th>Typical use-case</th><th>What the engine locks</th></tr></thead><tbody><tr><td>Cash</td><td>Spot trading (e.g. BTC/USDT, stocks)</td><td>Notional value for every position a pending order would open.</td></tr><tr><td>Margin</td><td>Derivatives or any product that allows leverage</td><td>Initial margin for each order plus maintenance margin for open positions.</td></tr><tr><td>Betting</td><td>Sports betting, book‑making</td><td>Stake required by the venue; no leverage.</td></tr></tbody></table>
<p>Example of adding a <code>CASH</code> account for a backtest venue:</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">binance </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> BINANCE_VENUE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backtest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">engine </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> BacktestEngine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">currencies </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> USDT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">enums </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> OmsType</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> AccountType</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Money</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Currency</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Initialize the backtest engine</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">engine </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BacktestEngine</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Add a CASH account for the venue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">engine</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add_venue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    venue</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">BINANCE_VENUE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Create or reference a Venue identifier</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    oms_type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">OmsType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NETTING</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    account_type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">AccountType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CASH</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    starting_balances</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Money</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">10_000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> USDT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="cash-accounts">Cash accounts<a href="#cash-accounts" class="hash-link" aria-label="Cash accounts的直接链接" title="Cash accounts的直接链接" translate="no">​</a></h3>
<p>Cash accounts settle trades in full; there is no leverage and therefore no concept of margin.</p>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="margin-accounts">Margin accounts<a href="#margin-accounts" class="hash-link" aria-label="Margin accounts的直接链接" title="Margin accounts的直接链接" translate="no">​</a></h3>
<p>A <em>margin account</em> facilitates trading of instruments requiring margin, such as futures or leveraged products.
It tracks account balances, calculates required margins, and manages leverage to ensure sufficient collateral for positions and orders.</p>
<p><strong>Key concepts</strong>:</p>
<ul>
<li><strong>Leverage</strong>: Amplifies trading exposure relative to account equity. Higher leverage increases potential returns and risks.</li>
<li><strong>Initial Margin</strong>: Collateral required to submit an order to open a position.</li>
<li><strong>Maintenance Margin</strong>: Minimum collateral required to maintain an open position.</li>
<li><strong>Locked Balance</strong>: Funds reserved as collateral, unavailable for new orders or withdrawals.</li>
</ul>
<div class="theme-admonition theme-admonition-note admonition_lEzE alert alert--secondary"><div class="admonitionHeading_aAf0"><span class="admonitionIcon_xtBN"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_Vfkp"><p>Reduce-only orders <strong>do not</strong> contribute to <code>balance_locked</code> in cash accounts,
nor do they add to initial margin in margin accounts—as they can only reduce existing exposure.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="betting-accounts">Betting accounts<a href="#betting-accounts" class="hash-link" aria-label="Betting accounts的直接链接" title="Betting accounts的直接链接" translate="no">​</a></h3>
<p>Betting accounts are specialised for venues where you stake an amount to win or lose a fixed payout (some prediction markets, sports books, etc.).
The engine locks only the stake required by the venue; leverage and margin are not applicable.</p>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="margin-models">Margin models<a href="#margin-models" class="hash-link" aria-label="Margin models的直接链接" title="Margin models的直接链接" translate="no">​</a></h2>
<p>NautilusTrader provides flexible margin calculation models to accommodate different venue types and trading scenarios.</p>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Overview的直接链接" title="Overview的直接链接" translate="no">​</a></h3>
<p>Different venues and brokers have varying approaches to calculating margin requirements:</p>
<ul>
<li><strong>Traditional Brokers</strong> (Interactive Brokers, TD Ameritrade): Fixed margin percentages regardless of leverage.</li>
<li><strong>Crypto Exchanges</strong> (Binance, some others): Leverage may reduce margin requirements.</li>
<li><strong>Futures Exchanges</strong> (CME, ICE): Fixed margin amounts per contract.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="available-models">Available models<a href="#available-models" class="hash-link" aria-label="Available models的直接链接" title="Available models的直接链接" translate="no">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="standardmarginmodel">StandardMarginModel<a href="#standardmarginmodel" class="hash-link" aria-label="StandardMarginModel的直接链接" title="StandardMarginModel的直接链接" translate="no">​</a></h4>
<p>Uses fixed percentages without leverage division, matching traditional broker behavior.</p>
<p><strong>Formula:</strong></p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Fixed percentages - leverage ignored</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">margin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> notional </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> instrument</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">margin_init</span><br></span></code></pre></div></div>
<ul>
<li>Initial Margin = <code>notional_value * instrument.margin_init</code></li>
<li>Maintenance Margin = <code>notional_value * instrument.margin_maint</code></li>
</ul>
<p><strong>Use cases:</strong></p>
<ul>
<li>Traditional brokers (Interactive Brokers, TD Ameritrade).</li>
<li>Futures exchanges (CME, ICE).</li>
<li>Forex brokers with fixed margin requirements.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="leveragedmarginmodel">LeveragedMarginModel<a href="#leveragedmarginmodel" class="hash-link" aria-label="LeveragedMarginModel的直接链接" title="LeveragedMarginModel的直接链接" translate="no">​</a></h4>
<p>Divides margin requirements by leverage.</p>
<p><strong>Formula:</strong></p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Leverage reduces margin requirements</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">adjusted_notional </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> notional </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> leverage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">margin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> adjusted_notional </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> instrument</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">margin_init</span><br></span></code></pre></div></div>
<ul>
<li>Initial Margin = <code>(notional_value / leverage) * instrument.margin_init</code></li>
<li>Maintenance Margin = <code>(notional_value / leverage) * instrument.margin_maint</code></li>
</ul>
<p><strong>Use cases:</strong></p>
<ul>
<li>Crypto exchanges that reduce margin with leverage.</li>
<li>Venues where leverage affects margin requirements.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="usage">Usage<a href="#usage" class="hash-link" aria-label="Usage的直接链接" title="Usage的直接链接" translate="no">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="programmatic-configuration">Programmatic configuration<a href="#programmatic-configuration" class="hash-link" aria-label="Programmatic configuration的直接链接" title="Programmatic configuration的直接链接" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backtest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">models </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> LeveragedMarginModel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backtest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">models </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> StandardMarginModel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">test_kit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stubs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">execution </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> TestExecStubs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Create account</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">account </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> TestExecStubs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">margin_account</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Set standard model for traditional brokers</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">standard_model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> StandardMarginModel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">set_margin_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">standard_model</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Or use leveraged model for crypto exchanges</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">leveraged_model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> LeveragedMarginModel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">set_margin_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">leveraged_model</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="backtest-configuration">Backtest configuration<a href="#backtest-configuration" class="hash-link" aria-label="Backtest configuration的直接链接" title="Backtest configuration的直接链接" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backtest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> BacktestVenueConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backtest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> MarginModelConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">venue_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BacktestVenueConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;SIM&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    oms_type</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;NETTING&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    account_type</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;MARGIN&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    starting_balances</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;1_000_000 USD&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    margin_model</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">MarginModelConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model_type</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;standard&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Options: &#x27;standard&#x27;, &#x27;leveraged&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="available-model-types">Available model types<a href="#available-model-types" class="hash-link" aria-label="Available model types的直接链接" title="Available model types的直接链接" translate="no">​</a></h4>
<ul>
<li><code>&quot;leveraged&quot;</code>: Margin reduced by leverage (default).</li>
<li><code>&quot;standard&quot;</code>: Fixed percentages (traditional brokers).</li>
<li>Custom class path: <code>&quot;my_package.my_module.MyMarginModel&quot;</code>.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="default-behavior">Default behavior<a href="#default-behavior" class="hash-link" aria-label="Default behavior的直接链接" title="Default behavior的直接链接" translate="no">​</a></h4>
<p>By default, <code>MarginAccount</code> uses <code>LeveragedMarginModel</code>.</p>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="real-world-example">Real-world example<a href="#real-world-example" class="hash-link" aria-label="Real-world example的直接链接" title="Real-world example的直接链接" translate="no">​</a></h4>
<p><strong>EUR/USD Trading Scenario:</strong></p>
<ul>
<li><strong>Instrument</strong>: EUR/USD</li>
<li><strong>Quantity</strong>: 100,000 EUR</li>
<li><strong>Price</strong>: 1.10000</li>
<li><strong>Notional Value</strong>: $110,000</li>
<li><strong>Leverage</strong>: 50x</li>
<li><strong>Instrument Margin Init</strong>: 3%</li>
</ul>
<p><strong>Margin calculations:</strong></p>
<table><thead><tr><th>Model</th><th>Calculation</th><th>Result</th><th>Percentage</th></tr></thead><tbody><tr><td>Standard</td><td>$110,000 × 0.03</td><td>$3,300</td><td>3.00%</td></tr><tr><td>Leveraged</td><td>($110,000 ÷ 50) × 0.03</td><td>$66</td><td>0.06%</td></tr></tbody></table>
<p><strong>Account balance impact:</strong></p>
<ul>
<li><strong>Account Balance</strong>: $10,000</li>
<li><strong>Standard Model</strong>: Cannot trade (requires $3,300 margin)</li>
<li><strong>Leveraged Model</strong>: Can trade (requires only $66 margin)</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="real-world-scenarios">Real-world scenarios<a href="#real-world-scenarios" class="hash-link" aria-label="Real-world scenarios的直接链接" title="Real-world scenarios的直接链接" translate="no">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="interactive-brokers-eurusd-futures">Interactive Brokers EUR/USD futures<a href="#interactive-brokers-eurusd-futures" class="hash-link" aria-label="Interactive Brokers EUR/USD futures的直接链接" title="Interactive Brokers EUR/USD futures的直接链接" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># IB requires fixed margin regardless of leverage</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">set_margin_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">StandardMarginModel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">margin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">calculate_margin_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> quantity</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Result: Fixed percentage of notional value</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="binance-crypto-trading">Binance crypto trading<a href="#binance-crypto-trading" class="hash-link" aria-label="Binance crypto trading的直接链接" title="Binance crypto trading的直接链接" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Binance may reduce margin with leverage</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">set_margin_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">LeveragedMarginModel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">margin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">calculate_margin_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> quantity</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Result: Margin reduced by leverage factor</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="model-selection">Model selection<a href="#model-selection" class="hash-link" aria-label="Model selection的直接链接" title="Model selection的直接链接" translate="no">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="using-the-default-model">Using the default model<a href="#using-the-default-model" class="hash-link" aria-label="Using the default model的直接链接" title="Using the default model的直接链接" translate="no">​</a></h4>
<p>The default <code>LeveragedMarginModel</code> works out of the box:</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">account </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> TestExecStubs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">margin_account</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">margin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">calculate_margin_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> quantity</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="using-the-standard-model">Using the standard model<a href="#using-the-standard-model" class="hash-link" aria-label="Using the standard model的直接链接" title="Using the standard model的直接链接" translate="no">​</a></h4>
<p>For traditional broker behavior:</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">set_margin_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">StandardMarginModel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">margin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">calculate_margin_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> quantity</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="custom-models">Custom models<a href="#custom-models" class="hash-link" aria-label="Custom models的直接链接" title="Custom models的直接链接" translate="no">​</a></h3>
<p>You can create custom margin models by inheriting from <code>MarginModel</code>. Custom models receive configuration through the <code>MarginModelConfig</code>:</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backtest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">models </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> MarginModel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backtest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> MarginModelConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">RiskAdjustedMarginModel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">MarginModel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> MarginModelConfig</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;Initialize with configuration parameters.&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">risk_multiplier </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Decimal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;risk_multiplier&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">use_leverage </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;use_leverage&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">calculate_margin_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> instrument</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> quantity</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> leverage</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> use_quote_for_inverse</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        notional </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> instrument</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">notional_value</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">quantity</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> use_quote_for_inverse</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">use_leverage</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            adjusted_notional </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> notional</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">as_decimal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> leverage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            adjusted_notional </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> notional</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">as_decimal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        margin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> adjusted_notional </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> instrument</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">margin_init </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">risk_multiplier</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> Money</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">margin</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> instrument</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">quote_currency</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">calculate_margin_maint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> instrument</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> side</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> quantity</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> leverage</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> use_quote_for_inverse</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">calculate_margin_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> quantity</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> leverage</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> use_quote_for_inverse</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="using-custom-models">Using custom models<a href="#using-custom-models" class="hash-link" aria-label="Using custom models的直接链接" title="Using custom models的直接链接" translate="no">​</a></h4>
<p><strong>Programmatic:</strong></p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backtest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> MarginModelConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backtest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> MarginModelFactory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> MarginModelConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    model_type</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;my_package.my_module:RiskAdjustedMarginModel&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;risk_multiplier&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;use_leverage&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">custom_model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> MarginModelFactory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">set_margin_model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">custom_model</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="high-level-backtest-api-configuration">High-level backtest API configuration<a href="#high-level-backtest-api-configuration" class="hash-link" aria-label="High-level backtest API configuration的直接链接" title="High-level backtest API configuration的直接链接" translate="no">​</a></h3>
<p>When using the high-level backtest API, you can specify margin models in your venue configuration using <code>MarginModelConfig</code>:</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backtest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> MarginModelConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backtest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> BacktestVenueConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> BacktestRunConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Configure venue with specific margin model</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">venue_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BacktestVenueConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;SIM&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    oms_type</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;NETTING&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    account_type</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;MARGIN&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    starting_balances</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;1_000_000 USD&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    margin_model</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">MarginModelConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        model_type</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;standard&quot;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Use standard model for traditional broker simulation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Use in backtest configuration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BacktestRunConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    venues</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">venue_config</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># ... other config</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="configuration-examples">Configuration examples<a href="#configuration-examples" class="hash-link" aria-label="Configuration examples的直接链接" title="Configuration examples的直接链接" translate="no">​</a></h4>
<p><strong>Standard model (traditional brokers):</strong></p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">margin_model</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">MarginModelConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model_type</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;standard&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>Leveraged model (default):</strong></p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">margin_model</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">MarginModelConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model_type</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;leveraged&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Default</span><br></span></code></pre></div></div>
<p><strong>Custom model with configuration:</strong></p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">margin_model</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">MarginModelConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    model_type</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;my_package.my_module:CustomMarginModel&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;risk_multiplier&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;use_leverage&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;volatility_threshold&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.02</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>The margin model will be automatically applied to the simulated exchange during backtest execution.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/Aloento/NautilusTraderDoc/tree/main/docs/concepts/backtesting.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_F7ru" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_GNoA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/concepts/architecture"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">Architecture</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/concepts/cache"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">Cache</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_pg_n thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#choosing-an-api-level" class="table-of-contents__link toc-highlight">Choosing an API level</a></li><li><a href="#low-level-api" class="table-of-contents__link toc-highlight">Low-level API</a></li><li><a href="#high-level-api" class="table-of-contents__link toc-highlight">High-level API</a></li><li><a href="#data" class="table-of-contents__link toc-highlight">Data</a><ul><li><a href="#choosing-data-cost-vs-accuracy" class="table-of-contents__link toc-highlight">Choosing data: cost vs. accuracy</a></li></ul></li><li><a href="#venues" class="table-of-contents__link toc-highlight">Venues</a></li><li><a href="#execution" class="table-of-contents__link toc-highlight">Execution</a><ul><li><a href="#data-and-message-sequencing" class="table-of-contents__link toc-highlight">Data and message sequencing</a></li><li><a href="#bar-based-execution" class="table-of-contents__link toc-highlight">Bar based execution</a></li><li><a href="#slippage-and-spread-handling" class="table-of-contents__link toc-highlight">Slippage and spread handling</a></li><li><a href="#fill-model" class="table-of-contents__link toc-highlight">Fill model</a></li></ul></li><li><a href="#account-types" class="table-of-contents__link toc-highlight">Account types</a><ul><li><a href="#cash-accounts" class="table-of-contents__link toc-highlight">Cash accounts</a></li><li><a href="#margin-accounts" class="table-of-contents__link toc-highlight">Margin accounts</a></li><li><a href="#betting-accounts" class="table-of-contents__link toc-highlight">Betting accounts</a></li></ul></li><li><a href="#margin-models" class="table-of-contents__link toc-highlight">Margin models</a><ul><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#available-models" class="table-of-contents__link toc-highlight">Available models</a></li><li><a href="#usage" class="table-of-contents__link toc-highlight">Usage</a></li><li><a href="#real-world-scenarios" class="table-of-contents__link toc-highlight">Real-world scenarios</a></li><li><a href="#model-selection" class="table-of-contents__link toc-highlight">Model selection</a></li><li><a href="#custom-models" class="table-of-contents__link toc-highlight">Custom models</a></li><li><a href="#high-level-backtest-api-configuration" class="table-of-contents__link toc-highlight">High-level backtest API configuration</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 NautilusTrader Documentation.</div></div></div></footer></div>
</body>
</html>