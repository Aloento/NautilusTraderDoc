<!doctype html>
<html lang="zh" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-concepts/data" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.1">
<title data-rh="true">数据 | NautilusTrader 文档</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://nautilus.aloen.to/concepts/data"><meta data-rh="true" property="og:locale" content="zh"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="数据 | NautilusTrader 文档"><meta data-rh="true" name="description" content="NautilusTrader 提供了一组内置的数据类型，用于表示交易领域中的常见数据结构。"><meta data-rh="true" property="og:description" content="NautilusTrader 提供了一组内置的数据类型，用于表示交易领域中的常见数据结构。"><link data-rh="true" rel="icon" href="/logo.png"><link data-rh="true" rel="canonical" href="https://nautilus.aloen.to/concepts/data"><link data-rh="true" rel="alternate" href="https://nautilus.aloen.to/concepts/data" hreflang="zh"><link data-rh="true" rel="alternate" href="https://nautilus.aloen.to/concepts/data" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"概念","item":"https://nautilus.aloen.to/concepts/"},{"@type":"ListItem","position":2,"name":"数据","item":"https://nautilus.aloen.to/concepts/data"}]}</script><link rel="stylesheet" href="/assets/css/styles.33db920f.css">
<script src="/assets/js/runtime~main.d37f7723.js" defer="defer"></script>
<script src="/assets/js/main.3352860b.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/logo.png"><div role="region" aria-label="跳到主要内容"><a class="skipToContent__uWo" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/logo.png" alt="NautilusTrader Logo" class="themedComponent_WkLn themedComponent--light_cjoX"><img src="/logo.png" alt="NautilusTrader Logo" class="themedComponent_WkLn themedComponent--dark_jZId"></div><b class="navbar__title text--truncate">NautilusTrader</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/api_reference/">文档</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/Aloento/NautilusTraderDoc" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_KfBJ"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_RWFU colorModeToggle_sA1q"><button class="clean-btn toggleButton_qjfc toggleButtonDisabled_cpNp" type="button" disabled="" title="system mode" aria-label="切换浅色/暗黑模式（当前为system mode）"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_CetX lightToggleIcon_UYsV"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_CetX darkToggleIcon_i1s2"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_CetX systemToggleIcon_yIQx"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_PsjF"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_jk42"><div class="docsWrapper_KWBO"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_XpKL" type="button"></button><div class="docRoot_joIP"><aside class="theme-doc-sidebar-container docSidebarContainer_DOen"><div class="sidebarViewport_j7YP"><div class="sidebar_nPgc"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_MTDt"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_GgI9 menu__link menu__link--sublist" href="/api_reference/"><span title="Python API" class="categoryLinkLabel_XKxb">Python API</span></a><button aria-label="展开侧边栏分类 &#x27;Python API&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_GgI9 menu__link menu__link--sublist menu__link--active" href="/concepts/"><span title="概念" class="categoryLinkLabel_XKxb">概念</span></a><button aria-label="折叠侧边栏分类 &#x27;概念&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/actors"><span title="Actors" class="linkLabel_CNtA">Actors</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/adapters"><span title="适配器" class="linkLabel_CNtA">适配器</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/architecture"><span title="架构" class="linkLabel_CNtA">架构</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/backtesting"><span title="回测" class="linkLabel_CNtA">回测</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/cache"><span title="Cache" class="linkLabel_CNtA">Cache</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/concepts/data"><span title="数据" class="linkLabel_CNtA">数据</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/execution"><span title="执行" class="linkLabel_CNtA">执行</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/instruments"><span title="合约与交易品种" class="linkLabel_CNtA">合约与交易品种</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/live"><span title="Live 交易" class="linkLabel_CNtA">Live 交易</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/logging"><span title="日志" class="linkLabel_CNtA">日志</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/message_bus"><span title="消息总线" class="linkLabel_CNtA">消息总线</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/orders"><span title="订单" class="linkLabel_CNtA">订单</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/overview"><span title="概览" class="linkLabel_CNtA">概览</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/portfolio"><span title="投资组合" class="linkLabel_CNtA">投资组合</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/positions"><span title="持仓" class="linkLabel_CNtA">持仓</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/reports"><span title="报告" class="linkLabel_CNtA">报告</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/concepts/strategies"><span title="策略" class="linkLabel_CNtA">策略</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_GgI9 menu__link menu__link--sublist" href="/developer_guide/"><span title="开发者指南" class="categoryLinkLabel_XKxb">开发者指南</span></a><button aria-label="展开侧边栏分类 &#x27;开发者指南&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_GgI9 menu__link menu__link--sublist" href="/getting_started/"><span title="入门" class="categoryLinkLabel_XKxb">入门</span></a><button aria-label="展开侧边栏分类 &#x27;入门&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_GgI9 menu__link menu__link--sublist" href="/integrations/"><span title="集成" class="categoryLinkLabel_XKxb">集成</span></a><button aria-label="展开侧边栏分类 &#x27;集成&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_GgI9 menu__link menu__link--sublist" href="/tutorials/"><span title="教程" class="categoryLinkLabel_XKxb">教程</span></a><button aria-label="展开侧边栏分类 &#x27;教程&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_bw1l"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_PIhC"><div class="docItemContainer_pFw3"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_HRKZ" aria-label="页面路径"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_sX5c"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/concepts/"><span>概念</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">数据</span></li></ul></nav><div class="tocCollapsible_DhUt theme-doc-toc-mobile tocMobile_Izjv"><button type="button" class="clean-btn tocCollapsibleButton_eYR5">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>数据</h1></header>
<p>NautilusTrader 提供了一组内置的数据类型，用于表示交易领域中的常见数据结构。
这些数据类型包括：</p>
<ul>
<li><code>OrderBookDelta</code>（L1/L2/L3）：表示最细粒度的订单簿更新。</li>
<li><code>OrderBookDeltas</code>（L1/L2/L3）：将多个 <code>OrderBookDelta</code> 批量打包以提高处理效率。</li>
<li><code>OrderBookDepth10</code>：聚合的订单簿快照（每侧最多 10 个档位）。</li>
<li><code>QuoteTick</code>：顶级盘口（top-of-book）的最优买卖价及其量。</li>
<li><code>TradeTick</code>：一次成交/匹配事件。</li>
<li><code>Bar</code>：OHLCV（开、高、低、收、量）K 线，按指定的聚合方法（aggregation method）生成。</li>
<li><code>MarkPriceUpdate</code>：合约的标记价格（通常用于衍生品交易）。</li>
<li><code>IndexPriceUpdate</code>：用于计算标记价的指数价格（underlying index price）。</li>
<li><code>FundingRateUpdate</code>：永续合约的资金费率（多空之间的周期性支付）。</li>
<li><code>InstrumentStatus</code>：品种级别的状态事件。</li>
<li><code>InstrumentClose</code>：品种的收盘价。</li>
</ul>
<p>NautilusTrader 的设计以处理细粒度订单簿数据为主，这能在回测中提供最接近实盘的执行仿真。
当然，根据仿真的需求，也可以使用任何受支持的市场数据类型进行回测，灵活选择模拟精度。</p>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="订单簿order-books">订单簿（Order books）<a href="#订单簿order-books" class="hash-link" aria-label="订单簿（Order books）的直接链接" title="订单簿（Order books）的直接链接" translate="no">​</a></h2>
<p>系统内置了一个用 Rust 实现的高性能订单簿，用来根据输入数据维护订单簿状态。</p>
<p><code>OrderBook</code> 实例按合约维护，既可用于回测也可用于实盘，支持以下类型的订单簿：</p>
<ul>
<li><code>L3_MBO</code>：Market by order（MBO，L3），使用每一笔按订单 ID 编址的事件，保留每个价格级别的所有订单。</li>
<li><code>L2_MBP</code>：Market by price（MBP，L2），按价格级别聚合订单簿事件。</li>
<li><code>L1_MBP</code>：Market by price（MBP，L1），也称为 BBO（best bid and offer），只捕获顶层更新。</li>
</ul>
<div class="theme-admonition theme-admonition-note admonition_lEzE alert alert--secondary"><div class="admonitionHeading_aAf0"><span class="admonitionIcon_xtBN"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_Vfkp"><p>顶层数据（如 <code>QuoteTick</code>、<code>TradeTick</code> 和 <code>Bar</code>）也可用于回测，对于以 <code>L1_MBP</code> 为书籍类型的市场尤其常见。</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="合约品种instruments">合约/品种（Instruments）<a href="#合约品种instruments" class="hash-link" aria-label="合约/品种（Instruments）的直接链接" title="合约/品种（Instruments）的直接链接" translate="no">​</a></h2>
<p>支持的合约类型包括：</p>
<ul>
<li><code>Betting</code>：博彩市场中的合约。</li>
<li><code>BinaryOption</code>：二元期权合约。</li>
<li><code>Cfd</code>：差价合约（CFD）。</li>
<li><code>Commodity</code>：现货/现金市场的商品合约。</li>
<li><code>CryptoFuture</code>：可交割的加密货币期货合约（以加密资产为标的并以其结算）。</li>
<li><code>CryptoPerpetual</code>：加密永续合约（perpetual swap）。</li>
<li><code>CurrencyPair</code>：现货/现金市场的货币对合约。</li>
<li><code>Equity</code>：股票类合约。</li>
<li><code>FuturesContract</code>：可交割期货合约。</li>
<li><code>FuturesSpread</code>：期货价差合约。</li>
<li><code>Index</code>：指数类合约。</li>
<li><code>OptionContract</code>：期权合约。</li>
<li><code>OptionSpread</code>：期权价差合约。</li>
<li><code>Synthetic</code>：由若干组件合约按公式合成的合成品种（synthetic）。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="k-线与聚合bars-and-aggregation">K 线与聚合（Bars and aggregation）<a href="#k-线与聚合bars-and-aggregation" class="hash-link" aria-label="K 线与聚合（Bars and aggregation）的直接链接" title="K 线与聚合（Bars and aggregation）的直接链接" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="k-线简介">K 线简介<a href="#k-线简介" class="hash-link" aria-label="K 线简介的直接链接" title="K 线简介的直接链接" translate="no">​</a></h3>
<p><em>Bar</em>（有时称为 candle、candlestick 或 kline）是一种表示在特定时间段内价格和成交量信息的数据结构，通常包含：</p>
<ul>
<li>开盘价</li>
<li>最高价</li>
<li>最低价</li>
<li>收盘价</li>
<li>成交量（或用 ticks 计数作为成交量的近似）</li>
</ul>
<p>系统通过指定的聚合方法（aggregation method）将底层市场数据分组并生成 K 线。</p>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="聚合的目的">聚合的目的<a href="#聚合的目的" class="hash-link" aria-label="聚合的目的的直接链接" title="聚合的目的的直接链接" translate="no">​</a></h3>
<p>在 NautilusTrader 中进行数据聚合的原因包括：</p>
<ul>
<li>为技术指标和策略开发提供数据。</li>
<li>许多策略对时间聚合数据（如分钟线）已足够，无需使用高频 L1/L2/L3 数据。</li>
<li>相比高频原始数据，聚合可以降低存储与处理成本。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="聚合方法">聚合方法<a href="#聚合方法" class="hash-link" aria-label="聚合方法的直接链接" title="聚合方法的直接链接" translate="no">​</a></h3>
<p>平台实现了多种聚合方法：</p>
<table><thead><tr><th style="text-align:left">名称</th><th style="text-align:left">描述</th><th style="text-align:left">类别</th></tr></thead><tbody><tr><td style="text-align:left"><code>TICK</code></td><td style="text-align:left">按一定数量的 ticks 进行聚合。</td><td style="text-align:left">Threshold</td></tr><tr><td style="text-align:left"><code>TICK_IMBALANCE</code></td><td style="text-align:left">按 ticks 的买/卖不平衡进行聚合。</td><td style="text-align:left">Threshold</td></tr><tr><td style="text-align:left"><code>TICK_RUNS</code></td><td style="text-align:left">按连续的买/卖序列（runs）聚合 ticks。</td><td style="text-align:left">Information</td></tr><tr><td style="text-align:left"><code>VOLUME</code></td><td style="text-align:left">按交易量聚合。</td><td style="text-align:left">Threshold</td></tr><tr><td style="text-align:left"><code>VOLUME_IMBALANCE</code></td><td style="text-align:left">按成交量的买/卖不平衡聚合。</td><td style="text-align:left">Threshold</td></tr><tr><td style="text-align:left"><code>VOLUME_RUNS</code></td><td style="text-align:left">按成交量的连续买/卖序列聚合。</td><td style="text-align:left">Information</td></tr><tr><td style="text-align:left"><code>VALUE</code></td><td style="text-align:left">按成交面值（notional value，也称为“Dollar bars”）聚合。</td><td style="text-align:left">Threshold</td></tr><tr><td style="text-align:left"><code>VALUE_IMBALANCE</code></td><td style="text-align:left">按按面值计算的买/卖不平衡聚合。</td><td style="text-align:left">Information</td></tr><tr><td style="text-align:left"><code>VALUE_RUNS</code></td><td style="text-align:left">按按面值计算的连续买/卖序列聚合。</td><td style="text-align:left">Threshold</td></tr><tr><td style="text-align:left"><code>RENKO</code></td><td style="text-align:left">基于固定价格变动（以 ticks 为砖块大小）的聚合。</td><td style="text-align:left">Threshold</td></tr><tr><td style="text-align:left"><code>MILLISECOND</code></td><td style="text-align:left">以毫秒为粒度的时间窗口聚合。</td><td style="text-align:left">Time</td></tr><tr><td style="text-align:left"><code>SECOND</code></td><td style="text-align:left">以秒为粒度的时间窗口聚合。</td><td style="text-align:left">Time</td></tr><tr><td style="text-align:left"><code>MINUTE</code></td><td style="text-align:left">以分钟为粒度的时间窗口聚合。</td><td style="text-align:left">Time</td></tr><tr><td style="text-align:left"><code>HOUR</code></td><td style="text-align:left">以小时为粒度的时间窗口聚合。</td><td style="text-align:left">Time</td></tr><tr><td style="text-align:left"><code>DAY</code></td><td style="text-align:left">以日为粒度的时间窗口聚合。</td><td style="text-align:left">Time</td></tr><tr><td style="text-align:left"><code>WEEK</code></td><td style="text-align:left">以周为粒度的时间窗口聚合。</td><td style="text-align:left">Time</td></tr><tr><td style="text-align:left"><code>MONTH</code></td><td style="text-align:left">以月为粒度的时间窗口聚合。</td><td style="text-align:left">Time</td></tr><tr><td style="text-align:left"><code>YEAR</code></td><td style="text-align:left">以年为粒度的时间窗口聚合。</td><td style="text-align:left">Time</td></tr></tbody></table>
<div class="theme-admonition theme-admonition-note admonition_lEzE alert alert--secondary"><div class="admonitionHeading_aAf0"><span class="admonitionIcon_xtBN"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_Vfkp"><p>以下聚合方法当前尚未实现：</p><ul>
<li><code>VOLUME_IMBALANCE</code></li>
<li><code>VOLUME_RUNS</code></li>
<li><code>VALUE_IMBALANCE</code></li>
<li><code>VALUE_RUNS</code></li>
</ul></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="聚合类型">聚合类型<a href="#聚合类型" class="hash-link" aria-label="聚合类型的直接链接" title="聚合类型的直接链接" translate="no">​</a></h3>
<p>NautilusTrader 实现了三类主要的聚合方式：</p>
<ol>
<li>
<p><strong>Trade-to-bar（成交到 K 线）</strong>：由 <code>TradeTick</code>（成交数据）生成 K 线。</p>
<ul>
<li>适用场景：分析成交价格或直接以成交数据为输入的策略。</li>
<li>在 Bar 规范中始终使用 <code>LAST</code> 作为 price_type。</li>
</ul>
</li>
<li>
<p><strong>Quote-to-bar（盘口到 K 线）</strong>：由 <code>QuoteTick</code>（买/卖档）生成 K 线。</p>
<ul>
<li>适用场景：关注买卖价差或市场深度的策略。</li>
<li>在 Bar 规范中使用 <code>BID</code>、<code>ASK</code> 或 <code>MID</code> 作为 price_type。</li>
</ul>
</li>
<li>
<p><strong>Bar-to-bar（K 线到 K 线）</strong>：由较小周期的 <code>Bar</code> 生成更大周期的 <code>Bar</code>。</p>
<ul>
<li>适用场景：对已有的小周期 K 线（例如 1 分钟）做重采样得到 5 分钟或小时线等。</li>
<li>这种方式在规范中需要使用 <code>@</code> 符号来标注来源。</li>
</ul>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="bar-类型">Bar 类型<a href="#bar-类型" class="hash-link" aria-label="Bar 类型的直接链接" title="Bar 类型的直接链接" translate="no">​</a></h3>
<p><code>BarType</code>（Bar 类型）由以下几个要素组成：</p>
<ul>
<li><strong>Instrument ID</strong>（<code>InstrumentId</code>）：指定该 Bar 所属的合约。</li>
<li><strong>Bar Specification</strong>（<code>BarSpecification</code>）：<!-- -->
<ul>
<li><code>step</code>：定义 Bar 的时间间隔或频率。</li>
<li><code>aggregation</code>：指定使用的聚合方法（参见上表）。</li>
<li><code>price_type</code>：指定 Bar 的价格基准（如 bid、ask、mid、last）。</li>
</ul>
</li>
<li><strong>Aggregation Source</strong>（<code>AggregationSource</code>）：标明 Bar 是在本地（INTERNAL）还是由外部（EXTERNAL）聚合得到的。</li>
</ul>
<p>BarType 还可以分为 <em>standard</em>（标准）或 <em>composite</em>（复合）：</p>
<ul>
<li><strong>标准（Standard）</strong>：由原始市场数据（quote-ticks、trade-ticks）直接生成。</li>
<li><strong>复合（Composite）</strong>：由更高粒度的 Bar 通过子抽样（subsampling）得到（例如 5 分钟 Bar 从 1 分钟 Bar 聚合而来）。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="聚合来源aggregation-sources">聚合来源（Aggregation sources）<a href="#聚合来源aggregation-sources" class="hash-link" aria-label="聚合来源（Aggregation sources）的直接链接" title="聚合来源（Aggregation sources）的直接链接" translate="no">​</a></h3>
<p>聚合来源可为：</p>
<ul>
<li><code>INTERNAL</code>：在本地 Nautilus 系统内完成聚合。</li>
<li><code>EXTERNAL</code>：由场外或数据提供方在系统外完成聚合。</li>
</ul>
<p>对于 bar-to-bar（K 线到 K 线）聚合，目标 BarType 总是 <code>INTERNAL</code>（因为聚合在 Nautilus 内部完成），但来源 Bar 可以是 <code>INTERNAL</code> 或 <code>EXTERNAL</code>。</p>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="使用字符串语法定义-bartype">使用字符串语法定义 BarType<a href="#使用字符串语法定义-bartype" class="hash-link" aria-label="使用字符串语法定义 BarType的直接链接" title="使用字符串语法定义 BarType的直接链接" translate="no">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="标准-bar">标准 Bar<a href="#标准-bar" class="hash-link" aria-label="标准 Bar的直接链接" title="标准 Bar的直接链接" translate="no">​</a></h4>
<p>可用如下格式从字符串定义标准 BarType：</p>
<p><code>{instrument_id}-{step}-{aggregation}-{price_type}-{INTERNAL | EXTERNAL}</code></p>
<p>例如：在 Nasdaq（XNAS）上为 AAPL 定义一个 5 分钟、基于成交价（LAST）且在本地聚合的 BarType：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">bar_type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BarType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;AAPL.XNAS-5-MINUTE-LAST-INTERNAL&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="复合-bar">复合 Bar<a href="#复合-bar" class="hash-link" aria-label="复合 Bar的直接链接" title="复合 Bar的直接链接" translate="no">​</a></h4>
<p>复合 Bar 的定义格式为：</p>
<p><code>{instrument_id}-{step}-{aggregation}-{price_type}-INTERNAL@{step}-{aggregation}-{INTERNAL | EXTERNAL}</code></p>
<p>注意事项：</p>
<ul>
<li>派生（derived）的 BarType 必须使用 <code>INTERNAL</code> 作为聚合来源（因为聚合在本地完成）。</li>
<li>被采样的 BarType 必须具有比派生 Bar 更高的粒度。</li>
<li>被采样的 instrument_id 会被推断为与派生 BarType 相同。</li>
<li>复合 Bar 可从 <code>INTERNAL</code> 或 <code>EXTERNAL</code> 的来源进行聚合。</li>
</ul>
<p>例如：从外部提供的 1 分钟 Bar 聚合为在本地生成的 AAPL 5 分钟成交价 Bar：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">bar_type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BarType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;AAPL.XNAS-5-MINUTE-LAST-INTERNAL@1-MINUTE-EXTERNAL&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="聚合语法示例">聚合语法示例<a href="#聚合语法示例" class="hash-link" aria-label="聚合语法示例的直接链接" title="聚合语法示例的直接链接" translate="no">​</a></h3>
<p><code>BarType</code> 字符串格式同时编码目标 BarType 和可选的来源数据类型：</p>
<div class="language-txt codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-txt codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">{instrument_id}-{step}-{aggregation}-{price_type}-{source}@{step}-{aggregation}-{source}</span><br></span></code></pre></div></div>
<p><code>@</code> 之后的部分是可选的，仅用于 bar-to-bar 聚合：</p>
<ul>
<li><strong>无 <code>@</code></strong>：当 price_type 为 <code>LAST</code> 时从 <code>TradeTick</code> 聚合；当 price_type 为 <code>BID</code>/<code>ASK</code>/<code>MID</code> 时从 <code>QuoteTick</code> 聚合。</li>
<li><strong>有 <code>@</code></strong>：从已有的 <code>Bar</code> 对象聚合（指定来源 BarType）。</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="trade-to-bar-示例">Trade-to-bar 示例<a href="#trade-to-bar-示例" class="hash-link" aria-label="Trade-to-bar 示例的直接链接" title="Trade-to-bar 示例的直接链接" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">on_start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 定义一个从 TradeTick 聚合的 BarType</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 使用 price_type=LAST 表示以 TradeTick 为数据源</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bar_type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BarType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;6EH4.XCME-50-VOLUME-LAST-INTERNAL&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 请求历史数据（将在 on_historical_data 回调收到 bars）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">request_bars</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bar_type</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 订阅实时数据（将在 on_bar 回调收到 bars）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">subscribe_bars</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bar_type</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="quote-to-bar-示例">Quote-to-bar 示例<a href="#quote-to-bar-示例" class="hash-link" aria-label="Quote-to-bar 示例的直接链接" title="Quote-to-bar 示例的直接链接" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">on_start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 从 ASK 价生成 1 分钟 Bar</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bar_type_ask </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BarType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;6EH4.XCME-1-MINUTE-ASK-INTERNAL&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 从 BID 价生成 1 分钟 Bar</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bar_type_bid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BarType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;6EH4.XCME-1-MINUTE-BID-INTERNAL&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 从 MID 价生成 1 分钟 Bar（MID 为 BID 与 ASK 的中间价）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bar_type_mid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BarType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;6EH4.XCME-1-MINUTE-MID-INTERNAL&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 请求历史并订阅实时</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">request_bars</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bar_type_ask</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 历史数据在 on_historical_data 中处理</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">subscribe_bars</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bar_type_ask</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 实时数据在 on_bar 中处理</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="bar-to-bar-示例">Bar-to-bar 示例<a href="#bar-to-bar-示例" class="hash-link" aria-label="Bar-to-bar 示例的直接链接" title="Bar-to-bar 示例的直接链接" translate="no">​</a></h4>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">on_start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 从 1 分钟 Bar 生成 5 分钟 Bar（格式：target_bar_type@source_bar_type）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 注意：左侧目标的 price_type（如 LAST）需要指定，来源侧无需 price_type</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bar_type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BarType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;6EH4.XCME-5-MINUTE-LAST-INTERNAL@1-MINUTE-EXTERNAL&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 请求历史数据（将在 on_historical_data(...) 处理）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">request_bars</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bar_type</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 订阅实时更新（将在 on_bar(...) 处理）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">subscribe_bars</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bar_type</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="高级-bar-to-bar-示例">高级 Bar-to-bar 示例<a href="#高级-bar-to-bar-示例" class="hash-link" aria-label="高级 Bar-to-bar 示例的直接链接" title="高级 Bar-to-bar 示例的直接链接" translate="no">​</a></h4>
<p>可以构建多级的聚合链条，例如：先从 TradeTick 生成 1 分钟 Bar，再从 1 分钟 Bar 生成 5 分钟 Bar，如下：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 先从 TradeTick 生成 1 分钟 Bar（LAST 表示 TradeTick 来源）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">primary_bar_type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BarType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;6EH4.XCME-1-MINUTE-LAST-INTERNAL&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 再从 1 分钟 Bar 生成 5 分钟 Bar</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 注意 @1-MINUTE-INTERNAL 指明了来源 Bar</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">intermediate_bar_type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BarType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;6EH4.XCME-5-MINUTE-LAST-INTERNAL@1-MINUTE-INTERNAL&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 最后从 5 分钟 Bar 生成小时线</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 注意 @5-MINUTE-INTERNAL 指明了来源 Bar</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hourly_bar_type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BarType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;6EH4.XCME-1-HOUR-LAST-INTERNAL@5-MINUTE-INTERNAL&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="使用-barsrequest-与-subscribe-的区别">使用 Bars：request 与 subscribe 的区别<a href="#使用-barsrequest-与-subscribe-的区别" class="hash-link" aria-label="使用 Bars：request 与 subscribe 的区别的直接链接" title="使用 Bars：request 与 subscribe 的区别的直接链接" translate="no">​</a></h3>
<p>NautilusTrader 提供两种与 Bar 交互的操作：</p>
<ul>
<li><strong><code>request_bars()</code></strong>：请求历史数据，由 <code>on_historical_data()</code> 回调处理。</li>
<li><strong><code>subscribe_bars()</code></strong>：订阅实时数据流，由 <code>on_bar()</code> 回调处理。</li>
</ul>
<p>典型流程为：</p>
<ol>
<li>先用 <code>request_bars()</code> 加载历史数据以初始化指标或策略状态。</li>
<li>再用 <code>subscribe_bars()</code> 保证策略在实时形成新 Bar 时能持续接收更新。</li>
</ol>
<p>示例（在 <code>on_start()</code> 中）：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">on_start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 定义 BarType</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bar_type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BarType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;6EH4.XCME-5-MINUTE-LAST-INTERNAL&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 请求历史数据用于初始化指标</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 这些 Bar 会在策略的 on_historical_data(...) 回调中收到</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">request_bars</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bar_type</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 订阅实时更新</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 新生成的 Bar 会在策略的 on_bar(...) 回调中收到</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">subscribe_bars</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bar_type</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 注册指标以接收 Bar 更新（指标会自动用历史数据和后续实时数据进行更新）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">register_indicator_for_bars</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bar_type</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">my_indicator</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>策略需要实现的回调以接收数据：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">on_historical_data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 处理由 request_bars() 返回的历史 Bar 批量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 注意：通过 register_indicator_for_bars 注册的指标会自动被历史数据更新</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pass</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">on_bar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bar</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 处理 subscribe_bars() 推送的实时单条 Bar</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 相关指标会在此回调之前完成更新</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pass</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="带聚合的历史数据请求">带聚合的历史数据请求<a href="#带聚合的历史数据请求" class="hash-link" aria-label="带聚合的历史数据请求的直接链接" title="带聚合的历史数据请求的直接链接" translate="no">​</a></h3>
<p>在请求用于回测或初始化指标的历史 Bar 时，<code>request_bars()</code> 支持直接请求或基于更低级别数据的聚合请求：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 请求原始的 1 分钟 Bar（从 TradeTick 聚合，price_type=LAST）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">request_bars</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">BarType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;6EH4.XCME-1-MINUTE-LAST-EXTERNAL&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 请求从 1 分钟 Bar 聚合得到的 5 分钟 Bar</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">request_bars</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">BarType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;6EH4.XCME-5-MINUTE-LAST-INTERNAL@1-MINUTE-EXTERNAL&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>如果需要专门请求已聚合的历史 Bar，可使用 <code>request_aggregated_bars()</code>：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 请求从历史成交 ticks 聚合得到的 Bar</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">request_aggregated_bars</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">BarType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;6EH4.XCME-100-VOLUME-LAST-INTERNAL&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 请求从其他 Bar 聚合得到的 Bar</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">request_aggregated_bars</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">BarType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;6EH4.XCME-5-MINUTE-LAST-INTERNAL@1-MINUTE-EXTERNAL&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="常见陷阱">常见陷阱<a href="#常见陷阱" class="hash-link" aria-label="常见陷阱的直接链接" title="常见陷阱的直接链接" translate="no">​</a></h3>
<p><strong>在请求历史数据前先注册指标</strong>：确保在请求历史数据前完成指标注册，否则指标不会用历史数据进行初始化。</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 正确顺序</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">register_indicator_for_bars</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bar_type</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ema</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">request_bars</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bar_type</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 错误顺序</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">request_bars</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bar_type</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 指标不会收到历史数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">register_indicator_for_bars</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bar_type</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ema</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="时间戳timestamps">时间戳（Timestamps）<a href="#时间戳timestamps" class="hash-link" aria-label="时间戳（Timestamps）的直接链接" title="时间戳（Timestamps）的直接链接" translate="no">​</a></h2>
<p>平台使用两个核心时间戳字段，出现在众多对象（市场数据、订单和事件）中：
这些字段用途不同，有助于在系统中保持精确的时间语义：</p>
<ul>
<li><code>ts_event</code>：UNIX 时间戳（纳秒），表示事件在外部真实发生的时间。</li>
<li><code>ts_init</code>：UNIX 时间戳（纳秒），表示 Nautilus 在内部创建表示该事件对象的时间。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="示例">示例<a href="#示例" class="hash-link" aria-label="示例的直接链接" title="示例的直接链接" translate="no">​</a></h3>
<table><thead><tr><th><strong>事件类型</strong></th><th><strong><code>ts_event</code></strong></th><th><strong><code>ts_init</code></strong></th></tr></thead><tbody><tr><td><code>TradeTick</code></td><td>交易在交易所实际发生的时间。</td><td>Nautilus 接收到该成交数据的时间。</td></tr><tr><td><code>QuoteTick</code></td><td>报价在交易所发生的时间。</td><td>Nautilus 接收到该报价数据的时间。</td></tr><tr><td><code>OrderBookDelta</code></td><td>订单簿更新在交易所发生的时间。</td><td>Nautilus 接收到订单簿更新的时间。</td></tr><tr><td><code>Bar</code></td><td>Bar 的收盘时间（精确到分/小时）。</td><td>Nautilus 在本地生成（针对 INTERNAL 条件）或接收到该 Bar（针对 EXTERNAL 条件）的时间。</td></tr><tr><td><code>OrderFilled</code></td><td>订单在交易所被成交的时间。</td><td>Nautilus 接收到并处理成交回执的时间。</td></tr><tr><td><code>OrderCanceled</code></td><td>取消在交易所被处理的时间。</td><td>Nautilus 接收到并处理取消确认的时间。</td></tr><tr><td><code>NewsEvent</code></td><td>新闻发布的时间。</td><td>如果是内部事件则为对象创建时间；如果是外部事件则为接收时间。</td></tr><tr><td>自定义事件</td><td>事件条件实际发生的时间。</td><td>如果是内部事件则为对象创建时间；如果是外部事件则为接收时间。</td></tr></tbody></table>
<div class="theme-admonition theme-admonition-note admonition_lEzE alert alert--secondary"><div class="admonitionHeading_aAf0"><span class="admonitionIcon_xtBN"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_Vfkp"><p><code>ts_init</code> 的概念比简单的“接收时间”更广泛。
它表示某个对象（数据点或命令）在 Nautilus 内部被初始化的时间。
因此 <code>ts_init</code> 并不限于“接收到的外部事件”，也适用于所有内部初始化的场景。</p><p>例如，命令（command）也会使用 <code>ts_init</code> 字段，此时“接收”概念并不适用。
这一更广泛的定义可确保不同对象类型在时间戳处理上的一致性。</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="延迟分析latency-analysis">延迟分析（Latency analysis）<a href="#延迟分析latency-analysis" class="hash-link" aria-label="延迟分析（Latency analysis）的直接链接" title="延迟分析（Latency analysis）的直接链接" translate="no">​</a></h3>
<p>采用双时间戳机制后可以方便在平台内进行延迟分析：</p>
<ul>
<li>延迟可按 <code>ts_init - ts_event</code> 计算。</li>
<li>该差值代表了系统端到端的延迟，包括网络传输、处理开销和排队时间等。</li>
<li>注意：生成这些时间戳的时钟可能并未同步，因此直接比较时需谨慎。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="不同环境下的行为">不同环境下的行为<a href="#不同环境下的行为" class="hash-link" aria-label="不同环境下的行为的直接链接" title="不同环境下的行为的直接链接" translate="no">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="回测环境">回测环境<a href="#回测环境" class="hash-link" aria-label="回测环境的直接链接" title="回测环境的直接链接" translate="no">​</a></h4>
<ul>
<li>数据按 <code>ts_init</code> 进行稳定排序（stable sort）。</li>
<li>这样可以确保确定性的处理顺序，并在回测中模拟合理的系统延迟行为。</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="实盘环境">实盘环境<a href="#实盘环境" class="hash-link" aria-label="实盘环境的直接链接" title="实盘环境的直接链接" translate="no">​</a></h4>
<ul>
<li>系统按数据到达顺序处理，以最小化端到端延迟并支持实时决策。<!-- -->
<ul>
<li><code>ts_init</code> 记录数据被 Nautilus 实时接收的精确时刻。</li>
<li><code>ts_event</code> 反映外部事件发生的时间，便于对比外部事件时间与系统接收时间。</li>
</ul>
</li>
<li>我们可以用 <code>ts_init - ts_event</code> 的差值来检测网络或处理的延迟问题。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="其他注意事项">其他注意事项<a href="#其他注意事项" class="hash-link" aria-label="其他注意事项的直接链接" title="其他注意事项的直接链接" translate="no">​</a></h3>
<ul>
<li>对于来自外部的数据，<code>ts_init</code> 总是等于或晚于 <code>ts_event</code>。</li>
<li>对于 Nautilus 内部创建的数据，<code>ts_init</code> 与 <code>ts_event</code> 可能相同，因为对象是在事件发生时立即初始化的。</li>
<li>并非所有带有 <code>ts_init</code> 字段的类型都必须包含 <code>ts_event</code> 字段：<!-- -->
<ul>
<li>例如对象初始化时间与事件发生时间相同，或根本不存在外部事件时间的概念。</li>
</ul>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="持久化数据">持久化数据<a href="#持久化数据" class="hash-link" aria-label="持久化数据的直接链接" title="持久化数据的直接链接" translate="no">​</a></h4>
<p><code>ts_init</code> 字段也用来指示消息最初被接收的时间。</p>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="数据流data-flow">数据流（Data flow）<a href="#数据流data-flow" class="hash-link" aria-label="数据流（Data flow）的直接链接" title="数据流（Data flow）的直接链接" translate="no">​</a></h2>
<p>平台通过相同的数据通路在所有运行环境（参见 <a href="/concepts/architecture#environment-contexts">environment contexts</a>）中保证一致性（例如 <code>backtest</code>、<code>sandbox</code>、<code>live</code>）。
数据主要通过 <code>MessageBus</code> 流向 <code>DataEngine</code>，然后分发到已订阅或注册的处理器。</p>
<p>对于需要更多灵活性的用户，平台也支持自定义数据类型的创建。关于如何实现用户自定义数据类型，请参见下文的 <a href="#custom-data">Custom Data</a> 部分。</p>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="数据加载loading-data">数据加载（Loading data）<a href="#数据加载loading-data" class="hash-link" aria-label="数据加载（Loading data）的直接链接" title="数据加载（Loading data）的直接链接" translate="no">​</a></h2>
<p>NautilusTrader 支持三类主要的用例下的数据加载和格式转换：</p>
<ul>
<li>为 <code>BacktestEngine</code> 提供回测所需的数据。</li>
<li>使用 <code>ParquetDataCatalog.write_data(...)</code> 将数据以 Nautilus 特定的 Parquet 格式持久化，供 <code>BacktestNode</code> 后续使用。</li>
<li>用于研究用途，确保研究与回测间的数据一致性。</li>
</ul>
<p>无论目标为何，流程都是将不同的外部数据格式转换为 Nautilus 所使用的数据结构。</p>
<p>为此通常需要两个组件：</p>
<ul>
<li>一类 DataLoader（通常针对原始来源/格式实现），该组件读取数据并返回符合目标 Nautilus 对象 schema 的 <code>pd.DataFrame</code>。</li>
<li>一类 DataWrangler（针对具体数据类型实现），它将 <code>pd.DataFrame</code> 转换为 Nautilus 对象构成的 <code>list[Data]</code>。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="data-loaders">Data loaders<a href="#data-loaders" class="hash-link" aria-label="Data loaders的直接链接" title="Data loaders的直接链接" translate="no">​</a></h3>
<p>DataLoader 通常针对具体的原始来源/格式实现。例如，Binance 的订单簿原始 CSV 文件与 <a href="https://databento.com/docs/knowledge-base/new-users/dbn-encoding/getting-started-with-dbn" target="_blank" rel="noopener noreferrer">Databento Binary Encoding (DBN)</a> 的文件格式完全不同，需要不同的 loader。</p>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="data-wranglers">Data wranglers<a href="#data-wranglers" class="hash-link" aria-label="Data wranglers的直接链接" title="Data wranglers的直接链接" translate="no">​</a></h3>
<p>DataWrangler 按 Nautilus 的数据类型实现，可在 <code>nautilus_trader.persistence.wranglers</code> 模块中找到。目前包含：</p>
<ul>
<li><code>OrderBookDeltaDataWrangler</code></li>
<li><code>OrderBookDepth10DataWrangler</code></li>
<li><code>QuoteTickDataWrangler</code></li>
<li><code>TradeTickDataWrangler</code></li>
<li><code>BarDataWrangler</code></li>
</ul>
<div class="theme-admonition theme-admonition-warning admonition_lEzE alert alert--warning"><div class="admonitionHeading_aAf0"><span class="admonitionIcon_xtBN"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_Vfkp"><p>存在一些 <strong>DataWrangler v2</strong> 组件，它们接收通常具有不同定宽 Nautilus Arrow v2 schema 的 <code>pd.DataFrame</code>，并输出基于 PyO3 的 Nautilus 对象，
这些对象只兼容正在开发中的新版 Nautilus core。</p><p><strong>这些 PyO3 提供的数据对象与当前仍在使用的旧版 Cython 对象不兼容（例如不能直接添加到现有的 <code>BacktestEngine</code>）。</strong></p></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="转换管线transformation-pipeline">转换管线（Transformation pipeline）<a href="#转换管线transformation-pipeline" class="hash-link" aria-label="转换管线（Transformation pipeline）的直接链接" title="转换管线（Transformation pipeline）的直接链接" translate="no">​</a></h3>
<p>流程概览：</p>
<ol>
<li>原始数据（例如 CSV）作为输入进入管线。</li>
<li>DataLoader 处理原始数据并将其转换为 <code>pd.DataFrame</code>。</li>
<li>DataWrangler 进一步处理 <code>pd.DataFrame</code>，输出 Nautilus 对象的列表。</li>
<li>Nautilus 的 <code>list[Data]</code> 即为数据加载流程的最终输出。</li>
</ol>
<p>下图示意了原始数据如何被转换为 Nautilus 数据结构：</p>
<div class="language-graph codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-graph codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">  ┌──────────┐    ┌──────────────────────┐                  ┌──────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  │          │    │                      │                  │                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  │          │    │                      │                  │                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  │ Raw data │    │                      │  `pd.DataFrame`  │                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  │ (CSV)    ├───►│      DataLoader      ├─────────────────►│     DataWrangler     ├───► Nautilus `list[Data]`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  │          │    │                      │                  │                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  │          │    │                      │                  │                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  │          │    │                      │                  │                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  └──────────┘    └──────────────────────┘                  └──────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>具体例子：</p>
<ul>
<li><code>BinanceOrderBookDeltaDataLoader.load(...)</code> 读取磁盘上的 Binance CSV 文件并返回 <code>pd.DataFrame</code>。</li>
<li><code>OrderBookDeltaDataWrangler.process(...)</code> 接收该 <code>pd.DataFrame</code> 并返回 <code>list[OrderBookDelta]</code>。</li>
</ul>
<p>下面的示例展示了如何在 Python 中完成上述操作：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> TEST_DATA_DIR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adapters</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">binance</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">loaders </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> BinanceOrderBookDeltaDataLoader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">persistence</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">wranglers </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> OrderBookDeltaDataWrangler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">test_kit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">providers </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> TestInstrumentProvider</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 加载原始数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data_path </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> TEST_DATA_DIR </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;binance&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;btcusdt-depth-snap.csv&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">df </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BinanceOrderBookDeltaDataLoader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data_path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 设置一个 wrangler</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">instrument </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> TestInstrumentProvider</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">btcusdt_binance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wrangler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> OrderBookDeltaDataWrangler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">instrument</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 处理并得到 Nautilus 的 `OrderBookDelta` 对象列表</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deltas </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> wrangler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">process</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">df</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="数据目录data-catalog">数据目录（Data catalog）<a href="#数据目录data-catalog" class="hash-link" aria-label="数据目录（Data catalog）的直接链接" title="数据目录（Data catalog）的直接链接" translate="no">​</a></h2>
<p>数据目录是 Nautilus 数据的集中存储，使用 <a href="https://parquet.apache.org" target="_blank" rel="noopener noreferrer">Parquet</a> 格式持久化。它是回测和实盘场景下的主要数据管理系统，提供高效的存储、检索和流式能力。</p>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="概览与架构">概览与架构<a href="#概览与架构" class="hash-link" aria-label="概览与架构的直接链接" title="概览与架构的直接链接" translate="no">​</a></h3>
<p>NautilusTrader 的数据目录采用双后端架构，兼顾 Rust 的性能和 Python 的灵活性：</p>
<p><strong>核心组件：</strong></p>
<ul>
<li><strong>ParquetDataCatalog</strong>：主要的 Python 接口，用于数据操作。</li>
<li><strong>Rust backend</strong>：针对核心数据类型（OrderBookDelta、QuoteTick、TradeTick、Bar、MarkPriceUpdate）的高性能查询引擎。</li>
<li><strong>PyArrow backend</strong>：用于自定义数据类型和复杂过滤的灵活后备实现。</li>
<li><strong>fsspec 集成</strong>：支持本地和云存储（S3、GCS、Azure 等）。</li>
</ul>
<p><strong>主要优势：</strong></p>
<ul>
<li><strong>性能</strong>：Rust 后端为核心市场数据类型提供优化查询性能。</li>
<li><strong>灵活性</strong>：PyArrow 后端适配自定义数据类型及复杂过滤场景。</li>
<li><strong>可扩展性</strong>：高效的压缩和列式存储降低存储成本并提升 I/O 性能。</li>
<li><strong>云原生</strong>：通过 fsspec 内置对云存储的支持。</li>
<li><strong>无外部依赖</strong>：自包含的方案，无需额外数据库或服务。</li>
</ul>
<p><strong>存储格式优势：</strong></p>
<ul>
<li>相较于 CSV/JSON/HDF5，Parquet 在压缩率和读取性能上更优。</li>
<li>列式存储便于高效过滤与聚合。</li>
<li>支持 schema 演化，便于数据模型升级。</li>
<li>跨语言兼容（Python、Rust、Java、C++ 等）。</li>
</ul>
<p>用于 Parquet 的 Arrow schema 主要统一来源于 core 的 <code>persistence</code> Rust crate，部分遗留 schema 存在于 <code>/serialization/arrow/schema.py</code> 模块中。</p>
<div class="theme-admonition theme-admonition-note admonition_lEzE alert alert--secondary"><div class="admonitionHeading_aAf0"><span class="admonitionIcon_xtBN"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_Vfkp"><p>当前计划是逐步淘汰 Python 端的 schema 模块，把 schema 单一来源迁移到 Rust core，以提高一致性和性能。</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="初始化">初始化<a href="#初始化" class="hash-link" aria-label="初始化的直接链接" title="初始化的直接链接" translate="no">​</a></h3>
<p>数据目录可以通过 <code>NAUTILUS_PATH</code> 环境变量初始化，或显式传入路径对象进行创建。</p>
<div class="theme-admonition theme-admonition-note admonition_lEzE alert alert--secondary"><div class="admonitionHeading_aAf0"><span class="admonitionIcon_xtBN"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>NAUTILUS_PATH environment variable</div><div class="admonitionContent_Vfkp"><p><code>NAUTILUS_PATH</code> 应当指向包含 Nautilus 数据的根目录，目录下会自动追加 <code>/catalog</code> 作为数据目录。</p><p>例如：</p><ul>
<li>若 <code>NAUTILUS_PATH=/home/user/trading_data</code>。</li>
<li>则目录位于 <code>/home/user/trading_data/catalog</code>。</li>
</ul><p>使用 <code>ParquetDataCatalog.from_env()</code> 时请确保 <code>NAUTILUS_PATH</code> 指向父目录而非 catalog 目录本身。</p></div></div>
<p>下面示例展示了如何在已有数据的路径上初始化数据目录：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pathlib </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">persistence</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">catalog </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> ParquetDataCatalog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CATALOG_PATH </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Path</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cwd</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;catalog&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 创建一个新的 catalog 实例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">catalog </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ParquetDataCatalog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CATALOG_PATH</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 或者：基于环境变量初始化</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">catalog </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ParquetDataCatalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_env</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 使用 NAUTILUS_PATH 环境变量</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="文件系统协议与存储选项">文件系统协议与存储选项<a href="#文件系统协议与存储选项" class="hash-link" aria-label="文件系统协议与存储选项的直接链接" title="文件系统协议与存储选项的直接链接" translate="no">​</a></h3>
<p>目录通过 fsspec 支持多种文件系统协议，便于在本地与云之间无缝切换。</p>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="支持的文件系统协议">支持的文件系统协议<a href="#支持的文件系统协议" class="hash-link" aria-label="支持的文件系统协议的直接链接" title="支持的文件系统协议的直接链接" translate="no">​</a></h4>
<p><strong>本地文件系统（<code>file</code>）：</strong></p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">catalog </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ParquetDataCatalog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    path</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;/path/to/catalog&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fs_protocol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;file&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 默认协议</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>Amazon S3（<code>s3</code>）：</strong></p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">catalog </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ParquetDataCatalog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    path</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;s3://my-bucket/nautilus-data/&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fs_protocol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;s3&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fs_storage_options</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;key&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;your-access-key-id&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;secret&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;your-secret-access-key&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;region&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;us-east-1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;endpoint_url&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;https://s3.amazonaws.com&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 可选自定义 endpoint</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>Google Cloud Storage（<code>gcs</code>）：</strong></p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">catalog </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ParquetDataCatalog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    path</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;gcs://my-bucket/nautilus-data/&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fs_protocol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;gcs&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fs_storage_options</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;project&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;my-project-id&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;token&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/path/to/service-account.json&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 或使用 &quot;cloud&quot; 以使用默认凭证</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>Azure Blob Storage（<code>abfs</code>）：</strong></p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">catalog </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ParquetDataCatalog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    path</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;abfs://container@account.dfs.core.windows.net/nautilus-data/&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fs_protocol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;abfs&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fs_storage_options</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;account_name&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;your-storage-account&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;account_key&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;your-account-key&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 或使用 SAS token： &quot;sas_token&quot;: &quot;your-sas-token&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="基于-uri-的初始化">基于 URI 的初始化<a href="#基于-uri-的初始化" class="hash-link" aria-label="基于 URI 的初始化的直接链接" title="基于 URI 的初始化的直接链接" translate="no">​</a></h4>
<p>为方便起见，可使用 URI 字符串自动解析协议和存储选项：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 本地文件系统</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">catalog </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ParquetDataCatalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_uri</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;/path/to/catalog&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># S3 存储</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">catalog </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ParquetDataCatalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_uri</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;s3://my-bucket/nautilus-data/&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 带存储选项的示例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">catalog </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ParquetDataCatalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_uri</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;s3://my-bucket/nautilus-data/&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    storage_options</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;region&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;us-east-1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;access_key_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;your-key&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;secret_access_key&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;your-secret&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="写入数据">写入数据<a href="#写入数据" class="hash-link" aria-label="写入数据的直接链接" title="写入数据的直接链接" translate="no">​</a></h3>
<p>使用 <code>write_data()</code> 方法将数据写入 catalog。所有 Nautilus 内置的 <code>Data</code> 对象以及继承自 <code>Data</code> 的对象均受支持。</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 写入一个数据对象列表</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">catalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">write_data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">quote_ticks</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 指定时间戳范围写入</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">catalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">write_data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    trade_ticks</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    start</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1704067200000000000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 可选的起始时间覆盖（UNIX 纳秒）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1704153600000000000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 可选的结束时间覆盖（UNIX 纳秒）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 在覆盖/重叠数据时跳过 disjoint 检查</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">catalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">write_data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bars</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> skip_disjoint_check</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="文件命名与数据组织">文件命名与数据组织<a href="#文件命名与数据组织" class="hash-link" aria-label="文件命名与数据组织的直接链接" title="文件命名与数据组织的直接链接" translate="no">​</a></h3>
<p>catalog 会根据写入数据的时间范围自动生成文件名，采用 <code>{start_timestamp}_{end_timestamp}.parquet</code> 的命名规则，时间戳使用 ISO 格式。</p>
<p>数据按数据类型和 instrument id 分目录存放：</p>
<div class="language-tree codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-tree codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">catalog/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── data/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── quote_ticks/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── eurusd.sim/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │       └── 20240101T000000000000000_20240101T235959999999999.parquet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── trade_ticks/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       └── btcusd.binance/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│           └── 20240101T000000000000000_20240101T235959999999999.parquet</span><br></span></code></pre></div></div>
<p><strong>Rust backend 支持的数据类型（性能增强）：</strong></p>
<p>下列数据类型在 Rust 端有优化实现：</p>
<ul>
<li><code>OrderBookDelta</code>。</li>
<li><code>OrderBookDeltas</code>。</li>
<li><code>OrderBookDepth10</code>。</li>
<li><code>QuoteTick</code>。</li>
<li><code>TradeTick</code>。</li>
<li><code>Bar</code>。</li>
<li><code>MarkPriceUpdate</code>。</li>
</ul>
<div class="theme-admonition theme-admonition-warning admonition_lEzE alert alert--warning"><div class="admonitionHeading_aAf0"><span class="admonitionIcon_xtBN"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_Vfkp"><p>默认情况下，重叠数据会触发断言错误以保证数据完整性。如需绕过此检查，可在 <code>write_data()</code> 中使用 <code>skip_disjoint_check=True</code>。</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="读取数据">读取数据<a href="#读取数据" class="hash-link" aria-label="读取数据的直接链接" title="读取数据的直接链接" translate="no">​</a></h3>
<p>通过 <code>query()</code> 方法从 catalog 中读取数据：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> QuoteTick</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TradeTick</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 查询某合约在时间区间内的 quote ticks</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">quotes </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> catalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">query</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data_cls</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">QuoteTick</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    identifiers</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;EUR/USD.SIM&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    start</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-01T00:00:00Z&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-02T00:00:00Z&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 带过滤条件的 trade ticks 查询</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">trades </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> catalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">query</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data_cls</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">TradeTick</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    identifiers</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;BTC/USD.BINANCE&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    start</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-01&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-02&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    where</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;price &gt; 50000&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="backtestdataconfig--回测的数据规范"><code>BacktestDataConfig</code> —— 回测的数据规范<a href="#backtestdataconfig--回测的数据规范" class="hash-link" aria-label="backtestdataconfig--回测的数据规范的直接链接" title="backtestdataconfig--回测的数据规范的直接链接" translate="no">​</a></h3>
<p><code>BacktestDataConfig</code> 类是回测启动前指定数据需求的主要方式。它定义了回测执行期间应从 catalog 加载哪些数据，以及如何过滤与处理这些数据。</p>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="核心参数">核心参数<a href="#核心参数" class="hash-link" aria-label="核心参数的直接链接" title="核心参数的直接链接" translate="no">​</a></h4>
<p><strong>必需参数：</strong></p>
<ul>
<li><code>catalog_path</code>：数据目录的路径。</li>
<li><code>data_cls</code>：数据类型类（例如 QuoteTick、TradeTick、OrderBookDelta、Bar）。</li>
</ul>
<p><strong>可选参数：</strong></p>
<ul>
<li><code>catalog_fs_protocol</code>：文件系统协议（&#x27;file&#x27;、&#x27;s3&#x27;、&#x27;gcs&#x27; 等）。</li>
<li><code>catalog_fs_storage_options</code>：存储相关选项（凭证、区域等）。</li>
<li><code>instrument_id</code>：要加载的单个合约。</li>
<li><code>instrument_ids</code>：合约列表（可替代单一的 instrument_id）。</li>
<li><code>start_time</code>：数据筛选起始时间（ISO 字符串或 UNIX 纳秒）。</li>
<li><code>end_time</code>：数据筛选结束时间（ISO 字符串或 UNIX 纳秒）。</li>
<li><code>filter_expr</code>：额外的 PyArrow 过滤表达式。</li>
<li><code>client_id</code>：自定义数据类型的客户端 ID。</li>
<li><code>metadata</code>：查询时附加的元数据。</li>
<li><code>bar_spec</code>：Bar 数据的规范（例如 &quot;1-MINUTE-LAST&quot;）。</li>
<li><code>bar_types</code>：BarType 列表（可替代 bar_spec）。</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="基本使用示例">基本使用示例<a href="#基本使用示例" class="hash-link" aria-label="基本使用示例的直接链接" title="基本使用示例的直接链接" translate="no">​</a></h4>
<p><strong>加载 quote ticks：</strong></p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> BacktestDataConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> QuoteTick</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> InstrumentId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BacktestDataConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    catalog_path</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;/path/to/catalog&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data_cls</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">QuoteTick</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instrument_id</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">InstrumentId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;EUR/USD.SIM&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    start_time</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-01T00:00:00Z&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end_time</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-02T00:00:00Z&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>加载多个合约：</strong></p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">data_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BacktestDataConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    catalog_path</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;/path/to/catalog&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data_cls</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">TradeTick</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instrument_ids</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;BTC/USD.BINANCE&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ETH/USD.BINANCE&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    start_time</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-01T00:00:00Z&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end_time</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-02T00:00:00Z&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>加载 Bar 数据：</strong></p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">data_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BacktestDataConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    catalog_path</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;/path/to/catalog&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data_cls</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">Bar</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instrument_id</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">InstrumentId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;AAPL.NASDAQ&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bar_spec</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;5-MINUTE-LAST&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    start_time</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-01&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end_time</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-31&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="高级配置示例">高级配置示例<a href="#高级配置示例" class="hash-link" aria-label="高级配置示例的直接链接" title="高级配置示例的直接链接" translate="no">​</a></h4>
<p><strong>带自定义过滤的云存储示例：</strong></p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">data_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BacktestDataConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    catalog_path</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;s3://my-bucket/nautilus-data/&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    catalog_fs_protocol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;s3&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    catalog_fs_storage_options</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;key&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;your-access-key&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;secret&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;your-secret-key&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;region&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;us-east-1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data_cls</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">OrderBookDelta</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instrument_id</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">InstrumentId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;BTC/USD.COINBASE&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    start_time</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-01T09:30:00Z&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end_time</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-01T16:00:00Z&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    filter_expr</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;side == &#x27;BUY&#x27;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Only buy-side deltas</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>带 Client ID 的自定义数据示例：</strong></p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">data_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BacktestDataConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    catalog_path</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;/path/to/catalog&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data_cls</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;my_package.data.NewsEventData&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    client_id</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;NewsClient&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;source&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;reuters&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;category&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;earnings&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    start_time</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-01&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end_time</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-31&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="与-backtestrunconfig-的集成">与 BacktestRunConfig 的集成<a href="#与-backtestrunconfig-的集成" class="hash-link" aria-label="与 BacktestRunConfig 的集成的直接链接" title="与 BacktestRunConfig 的集成的直接链接" translate="no">​</a></h4>
<p><code>BacktestDataConfig</code> 对象通过 <code>BacktestRunConfig</code> 集成进回测框架：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> BacktestRunConfig</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> BacktestVenueConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 定义多个数据配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data_configs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BacktestDataConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        catalog_path</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;/path/to/catalog&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data_cls</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">QuoteTick</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        instrument_id</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;EUR/USD.SIM&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        start_time</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-01&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        end_time</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-02&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BacktestDataConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        catalog_path</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;/path/to/catalog&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data_cls</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">TradeTick</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        instrument_id</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;EUR/USD.SIM&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        start_time</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-01&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        end_time</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-02&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 创建回测运行配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BacktestRunConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    venues</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">BacktestVenueConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;SIM&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> oms_type</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;HEDGING&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">data_configs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 数据配置列表</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    start</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-01T00:00:00Z&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-02T00:00:00Z&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="数据加载流程">数据加载流程<a href="#数据加载流程" class="hash-link" aria-label="数据加载流程的直接链接" title="数据加载流程的直接链接" translate="no">​</a></h4>
<p>当回测运行时，<code>BacktestNode</code> 会依次处理每个 <code>BacktestDataConfig</code>：</p>
<ol>
<li>Catalog 加载：根据配置创建 <code>ParquetDataCatalog</code> 实例。</li>
<li>查询构建：从配置属性构建查询参数。</li>
<li>数据检索：使用合适的后端执行 catalog 查询。</li>
<li>合约/合约定义加载（Instrument Loading）：如需则加载标的定义。</li>
<li>引擎集成：按正确顺序将数据加入回测引擎。</li>
</ol>
<p>系统会自动处理：</p>
<ul>
<li>Instrument ID 的解析与验证（保留英文术语 Instrument ID）。</li>
<li>数据类型的验证与转换。</li>
<li>对大数据集的内存高效流式处理。</li>
<li>错误处理与日志记录。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="datacatalogconfig--即时on-the-fly数据加载">DataCatalogConfig —— 即时（on-the-fly）数据加载<a href="#datacatalogconfig--即时on-the-fly数据加载" class="hash-link" aria-label="DataCatalogConfig —— 即时（on-the-fly）数据加载的直接链接" title="DataCatalogConfig —— 即时（on-the-fly）数据加载的直接链接" translate="no">​</a></h3>
<p><code>DataCatalogConfig</code> 类用于配置运行时的按需（on-the-fly）数据加载场景，特别适用于标的数量巨大且无法在回测前全部列举的情况。
与事先为回测指定数据的 <code>BacktestDataConfig</code> 不同，<code>DataCatalogConfig</code> 允许在运行时灵活访问 catalog。
以这种方式定义的 catalog 同样可以用于历史数据请求。</p>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="核心参数-1">核心参数<a href="#核心参数-1" class="hash-link" aria-label="核心参数的直接链接" title="核心参数的直接链接" translate="no">​</a></h4>
<p>必填参数：</p>
<ul>
<li><code>path</code>：数据 catalog 的目录路径。</li>
</ul>
<p>可选参数：</p>
<ul>
<li><code>fs_protocol</code>：文件系统协议（如 &#x27;file&#x27;、&#x27;s3&#x27;、&#x27;gcs&#x27;、&#x27;azure&#x27; 等）。</li>
<li><code>fs_storage_options</code>：协议相关的存储选项。</li>
<li><code>name</code>：可选的 catalog 配置标识名。</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="基本使用示例-1">基本使用示例<a href="#基本使用示例-1" class="hash-link" aria-label="基本使用示例的直接链接" title="基本使用示例的直接链接" translate="no">​</a></h4>
<p><strong>本地 catalog 配置：</strong></p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">persistence</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> DataCatalogConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">catalog_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> DataCatalogConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    path</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;/path/to/catalog&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fs_protocol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;file&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;local_market_data&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 转换为 catalog 实例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">catalog </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> catalog_config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">as_catalog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>云存储配置示例：</strong></p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">catalog_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> DataCatalogConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    path</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;s3://my-bucket/market-data/&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fs_protocol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;s3&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fs_storage_options</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;key&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;your-access-key&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;secret&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;your-secret-key&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;region&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;us-west-2&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;endpoint_url&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;https://s3.us-west-2.amazonaws.com&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;cloud_market_data&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="在实盘live-trading中的集成">在实盘（live trading）中的集成<a href="#在实盘live-trading中的集成" class="hash-link" aria-label="在实盘（live trading）中的集成的直接链接" title="在实盘（live trading）中的集成的直接链接" translate="no">​</a></h4>
<p><code>DataCatalogConfig</code> 常用于实盘系统中以便访问历史数据：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> TradingNodeConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">persistence</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> DataCatalogConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 为实盘系统配置 catalog</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">catalog_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> DataCatalogConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    path</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;/data/nautilus/catalog&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fs_protocol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;file&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;historical_data&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 在交易节点配置中使用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">node_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> TradingNodeConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># ... 其他配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    catalog</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">catalog_config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 启用历史数据访问</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="流式streaming配置">流式（streaming）配置<a href="#流式streaming配置" class="hash-link" aria-label="流式（streaming）配置的直接链接" title="流式（streaming）配置的直接链接" translate="no">​</a></h4>
<p>在实盘或回测期间将数据流式写入 catalog 时，可使用 <code>StreamingConfig</code>：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">persistence</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> StreamingConfig</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> RotationMode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> pandas </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> pd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">streaming_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> StreamingConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    catalog_path</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;/path/to/streaming/catalog&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fs_protocol</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;file&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    flush_interval_ms</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 每秒 flush</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    replace_existing</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rotation_mode</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">RotationMode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DAILY</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rotation_interval</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">pd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Timedelta</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hours</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    max_file_size</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1024</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1024</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 最大 100MB</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="常见用例">常见用例<a href="#常见用例" class="hash-link" aria-label="常见用例的直接链接" title="常见用例的直接链接" translate="no">​</a></h4>
<p>历史数据分析：</p>
<ul>
<li>在实盘期间加载历史数据以供策略计算。</li>
<li>访问参考数据以进行标的查找（instrument lookup）。</li>
<li>检索历史表现指标。</li>
</ul>
<p>动态数据加载：</p>
<ul>
<li>根据运行时条件按需加载数据。</li>
<li>实现自定义的数据加载策略。</li>
<li>支持多个 catalog 源。</li>
</ul>
<p>研发与研究：</p>
<ul>
<li>在 Jupyter 笔记本中进行交互式数据探索。</li>
<li>即席分析与回测。</li>
<li>数据质量验证与监控。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="查询系统与双后端dual-backend架构">查询系统与双后端（dual backend）架构<a href="#查询系统与双后端dual-backend架构" class="hash-link" aria-label="查询系统与双后端（dual backend）架构的直接链接" title="查询系统与双后端（dual backend）架构的直接链接" translate="no">​</a></h3>
<p>catalog 的查询系统采用双后端架构，会根据数据类型和查询参数自动选择最合适的查询引擎。</p>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="后端选择逻辑">后端选择逻辑<a href="#后端选择逻辑" class="hash-link" aria-label="后端选择逻辑的直接链接" title="后端选择逻辑的直接链接" translate="no">​</a></h4>
<p><strong>Rust 后端（高性能）：</strong></p>
<ul>
<li>支持类型（Supported Types）：OrderBookDelta、OrderBookDeltas、OrderBookDepth10、QuoteTick、TradeTick、Bar、MarkPriceUpdate。</li>
<li>使用条件：当 <code>files</code> 参数为 None（自动发现文件）时使用。</li>
<li>优点：性能与内存效率优化，原生 Arrow 集成。</li>
</ul>
<p><strong>PyArrow 后端（灵活）：</strong></p>
<ul>
<li>支持类型：包含自定义数据类在内的所有数据类型。</li>
<li>使用条件：用于自定义数据类型或当指定 <code>files</code> 参数时。</li>
<li>优点：高级过滤、自定义数据支持、复杂查询表达式。</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="查询方法与参数">查询方法与参数<a href="#查询方法与参数" class="hash-link" aria-label="查询方法与参数的直接链接" title="查询方法与参数的直接链接" translate="no">​</a></h4>
<p>核心查询参数示例：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">catalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">query</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data_cls</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">QuoteTick</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic"># 要查询的数据类型</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    identifiers</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;EUR/USD.SIM&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic"># 标的标识列表</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    start</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-01T00:00:00Z&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 起始时间（支持多种格式）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-02T00:00:00Z&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># 结束时间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    where</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;bid &gt; 1.1000&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">               </span><span class="token comment" style="color:#999988;font-style:italic"># PyArrow 过滤表达式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    files</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                            </span><span class="token comment" style="color:#999988;font-style:italic"># 指定文件会强制使用 PyArrow 后端</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>时间格式支持：</p>
<ul>
<li>ISO 8601 字符串：<code>&quot;2024-01-01T00:00:00Z&quot;</code>。</li>
<li>UNIX 纳秒（UNIX nanoseconds）：<code>1704067200000000000</code>（或使用 ISO 字符串）。</li>
<li>Pandas Timestamp：<code>pd.Timestamp(&quot;2024-01-01&quot;, tz=&quot;UTC&quot;)</code>。</li>
<li>Python datetime 对象（建议使用带时区）。</li>
</ul>
<p>高级过滤示例：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 复杂的 PyArrow 表达式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">catalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">query</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data_cls</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">TradeTick</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    identifiers</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;BTC/USD.BINANCE&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    where</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;price &gt; 50000 AND size &gt; 1.0&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    start</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-01&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-02&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 多个标的并按 metadata 过滤</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">catalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">query</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data_cls</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">Bar</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    identifiers</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;AAPL.NASDAQ&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;MSFT.NASDAQ&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    where</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;volume &gt; 1000000&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;bar_type&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1-MINUTE-LAST&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="catalog-操作">Catalog 操作<a href="#catalog-操作" class="hash-link" aria-label="Catalog 操作的直接链接" title="Catalog 操作的直接链接" translate="no">​</a></h3>
<p>catalog 提供若干维护和组织数据文件的操作函数，这些操作能优化存储、提升查询性能并保证数据完整性。</p>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="重设文件名reset-file-names">重设文件名（Reset file names）<a href="#重设文件名reset-file-names" class="hash-link" aria-label="重设文件名（Reset file names）的直接链接" title="重设文件名（Reset file names）的直接链接" translate="no">​</a></h4>
<p>将 parquet 文件名重置为匹配实际内容的时间戳，确保基于文件名的过滤正常工作。</p>
<p><strong>重置 catalog 中的所有文件：</strong></p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 重置 catalog 中所有 parquet 文件的文件名</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">catalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reset_all_file_names</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>重置特定数据类型的文件名：</strong></p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 重置所有 quote tick 文件名</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">catalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reset_data_file_names</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">QuoteTick</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 重置特定标的的 trade 文件名</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">catalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reset_data_file_names</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TradeTick</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;BTC/USD.BINANCE&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="合并consolidate-catalog">合并（Consolidate catalog）<a href="#合并consolidate-catalog" class="hash-link" aria-label="合并（Consolidate catalog）的直接链接" title="合并（Consolidate catalog）的直接链接" translate="no">​</a></h4>
<p>将多个小的 parquet 文件合并成更大的文件，以提升查询性能并减少存储开销。</p>
<p><strong>合并整个 catalog：</strong></p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 合并 catalog 中的所有文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">catalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">consolidate_catalog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 在指定时间范围内合并文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">catalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">consolidate_catalog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    start</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-01T00:00:00Z&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-02T00:00:00Z&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ensure_contiguous_files</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>合并特定数据类型：</strong></p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 合并所有 quote tick 文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">catalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">consolidate_data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">QuoteTick</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 合并特定标的的文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">catalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">consolidate_data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TradeTick</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    identifier</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;BTC/USD.BINANCE&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    start</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-01&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-31&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="按周期合并consolidate-by-period">按周期合并（Consolidate by period）<a href="#按周期合并consolidate-by-period" class="hash-link" aria-label="按周期合并（Consolidate by period）的直接链接" title="按周期合并（Consolidate by period）的直接链接" translate="no">​</a></h4>
<p>按固定时间周期拆分/合并数据文件，以实现标准化的文件组织。</p>
<p><strong>按周期合并整个 catalog：</strong></p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> pandas </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> pd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 将所有文件按天（1-day）合并</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">catalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">consolidate_catalog_by_period</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    period</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">pd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Timedelta</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">days</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 在时间范围内按小时（1-hour）合并</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">catalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">consolidate_catalog_by_period</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    period</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">pd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Timedelta</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hours</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    start</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-01T00:00:00Z&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-02T00:00:00Z&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>按周期合并特定数据：</strong></p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 将 quote 数据按 4 小时合并</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">catalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">consolidate_data_by_period</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data_cls</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">QuoteTick</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    period</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">pd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Timedelta</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hours</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 将特定标的按 30 分钟合并</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">catalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">consolidate_data_by_period</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data_cls</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">TradeTick</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    identifier</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;EUR/USD.SIM&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    period</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">pd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Timedelta</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">minutes</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    start</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-01&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-31&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="删除数据区间delete-data-range">删除数据区间（Delete data range）<a href="#删除数据区间delete-data-range" class="hash-link" aria-label="删除数据区间（Delete data range）的直接链接" title="删除数据区间（Delete data range）的直接链接" translate="no">​</a></h4>
<p>删除指定时间范围内的某类数据或某个标的的数据。此操作会永久删除数据，并会智能处理与之相交的文件。</p>
<p><strong>删除整个 catalog 的时间区间：</strong></p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 删除整个 catalog 中某一时间段的数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">catalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">delete_catalog_range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    start</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-01T00:00:00Z&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-02T00:00:00Z&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 删除从开始到指定时间点之前的所有数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">catalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">delete_catalog_range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">end</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-01T00:00:00Z&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>删除特定数据类型：</strong></p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 删除特定标的的所有 quote tick 数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">catalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">delete_data_range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data_cls</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">QuoteTick</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    identifier</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;BTC/USD.BINANCE&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 删除某时间段内的 trade 数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">catalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">delete_data_range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data_cls</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">TradeTick</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    identifier</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;EUR/USD.SIM&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    start</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-01T00:00:00Z&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-31T23:59:59Z&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-warning admonition_lEzE alert alert--warning"><div class="admonitionHeading_aAf0"><span class="admonitionIcon_xtBN"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_Vfkp"><p>删除操作会永久移除数据，且不可撤销。与删除区间部分重叠的文件会被拆分以保留区间外的数据。</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="feather-流式与格式转换">Feather 流式与格式转换<a href="#feather-流式与格式转换" class="hash-link" aria-label="Feather 流式与格式转换的直接链接" title="Feather 流式与格式转换的直接链接" translate="no">​</a></h3>
<p>catalog 支持在回测期间将数据流式写入临时的 feather 文件，随后再转换为高效查询的 parquet 格式。</p>
<p><strong>示例：期权 Greeks 的流式处理</strong></p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> option_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">greeks </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> GreeksData</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">persistence</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> StreamingConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 1. 为自定义数据配置流式写入</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">streaming </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> StreamingConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    catalog_path</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">catalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    include_types</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">GreeksData</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    flush_interval_ms</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 2. 启用流式写入后运行回测</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">engine_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BacktestEngineConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">streaming</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">streaming</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">results </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> node</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 3. 将流式数据转换为持久化的 catalog 数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">catalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">convert_stream_to_data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    results</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">instance_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GreeksData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 4. 查询已转换的数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">greeks_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> catalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">query</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data_cls</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">GreeksData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    start</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-01&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;2024-01-31&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    where</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;delta &gt; 0.5&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="catalog-摘要">Catalog 摘要<a href="#catalog-摘要" class="hash-link" aria-label="Catalog 摘要的直接链接" title="Catalog 摘要的直接链接" translate="no">​</a></h3>
<p>NautilusTrader 的数据 catalog 提供了全面的市场数据管理能力：</p>
<p>核心特性：</p>
<ul>
<li>双后端（Dual Backend）：Rust 性能 + Python 的灵活性。</li>
<li>多协议支持（Multi-Protocol）：本地、S3、GCS、Azure 等存储。</li>
<li>流式处理（Streaming）：Feather → Parquet 的转换管道。</li>
<li>运维操作：重置文件名、合并数据、按周期组织文件等。</li>
</ul>
<p>主要使用场景：</p>
<ul>
<li>回测（Backtesting）：通过 <code>BacktestDataConfig</code> 预配置数据加载。</li>
<li>实盘（Live Trading）：通过 <code>DataCatalogConfig</code> 按需访问历史数据。</li>
<li>维护（Maintenance）：文件合并与组织操作。</li>
<li>研究（Research）：交互式查询与分析。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="数据迁移data-migrations">数据迁移（Data migrations）<a href="#数据迁移data-migrations" class="hash-link" aria-label="数据迁移（Data migrations）的直接链接" title="数据迁移（Data migrations）的直接链接" translate="no">​</a></h2>
<p>NautilusTrader 定义了一个内部数据格式，位于 <code>nautilus_model</code> crate 中。
这些模型会序列化为 Arrow record batch，并写入 Parquet 文件。
使用 Nautilus 格式的 Parquet 文件能让 Nautilus 的回测达到最佳效率。</p>
<p>不过，在不同的精度模式（precision modes）或架构（schema）变更之间迁移数据模型可能具有一定挑战性。
本节介绍如何使用我们的工具来处理数据迁移。</p>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="迁移工具">迁移工具<a href="#迁移工具" class="hash-link" aria-label="迁移工具的直接链接" title="迁移工具的直接链接" translate="no">​</a></h3>
<p><code>nautilus_persistence</code> crate 提供两个关键的实用工具：</p>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="to_json"><code>to_json</code><a href="#to_json" class="hash-link" aria-label="to_json的直接链接" title="to_json的直接链接" translate="no">​</a></h4>
<p>将 Parquet 文件转换为 JSON，同时保留元数据：</p>
<ul>
<li>
<p>会生成两个文件：</p>
<ul>
<li><code>&lt;input&gt;.json</code>：包含反序列化后的数据</li>
<li><code>&lt;input&gt;.metadata.json</code>：包含 schema 元数据和 row group 配置</li>
</ul>
</li>
<li>
<p>根据文件名自动检测数据类型：</p>
<ul>
<li><code>OrderBookDelta</code>（文件名包含 &quot;deltas&quot; 或 &quot;order_book_delta&quot;）</li>
<li><code>QuoteTick</code>（文件名包含 &quot;quotes&quot; 或 &quot;quote_tick&quot;）</li>
<li><code>TradeTick</code>（文件名包含 &quot;trades&quot; 或 &quot;trade_tick&quot;）</li>
<li><code>Bar</code>（文件名包含 &quot;bars&quot;）</li>
</ul>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="to_parquet"><code>to_parquet</code><a href="#to_parquet" class="hash-link" aria-label="to_parquet的直接链接" title="to_parquet的直接链接" translate="no">​</a></h4>
<p>将 JSON 转换回 Parquet：</p>
<ul>
<li>同时读取数据 JSON 与元数据 JSON 文件。</li>
<li>保留原始元数据中的 row group 大小配置。</li>
<li>使用 ZSTD 压缩。</li>
<li>生成 <code>&lt;input&gt;.parquet</code> 文件。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="迁移流程">迁移流程<a href="#迁移流程" class="hash-link" aria-label="迁移流程的直接链接" title="迁移流程的直接链接" translate="no">​</a></h3>
<p>下面的迁移示例使用 trade 数据（其他数据类型的迁移方法类似）。
所有命令应在 <code>persistence</code> crate 根目录下运行。</p>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="从标准精度64-bit迁移到高精度128-bit">从标准精度（64-bit）迁移到高精度（128-bit）<a href="#从标准精度64-bit迁移到高精度128-bit" class="hash-link" aria-label="从标准精度（64-bit）迁移到高精度（128-bit）的直接链接" title="从标准精度（64-bit）迁移到高精度（128-bit）的直接链接" translate="no">​</a></h4>
<p>该示例展示如何将标准精度 schema 的 Parquet 转换为高精度 schema 的过程。</p>
<div class="theme-admonition theme-admonition-note admonition_lEzE alert alert--secondary"><div class="admonitionHeading_aAf0"><span class="admonitionIcon_xtBN"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_Vfkp"><p>如果你要迁移的 catalog 使用了 Arrow 的 <code>Int64</code> 与 <code>UInt64</code> 类型来表示价格和数量，请在编译生成初始 JSON 之前，参考提交记录 <a href="https://github.com/nautechsystems/nautilus_trader/commit/e284162cf27a3222115aeb5d10d599c8cf09cf50" target="_blank" rel="noopener noreferrer">e284162</a>。</p></div></div>
<p><strong>1. 将标准精度 Parquet 转为 JSON：</strong></p>
<div class="language-bash codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-bash codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">cargo run --bin to_json trades.parquet</span><br></span></code></pre></div></div>
<p>此操作会生成 <code>trades.json</code> 与 <code>trades.metadata.json</code> 文件。</p>
<p><strong>2. 将 JSON 转回高精度 Parquet：</strong></p>
<p>添加 <code>--features high-precision</code> 标志以写入高精度（128-bit）schema 的 Parquet。</p>
<div class="language-bash codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-bash codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">cargo run --features high-precision --bin to_parquet trades.json</span><br></span></code></pre></div></div>
<p>该命令会生成使用高精度 schema 的 <code>trades.parquet</code> 文件。</p>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="迁移-schema-版本">迁移 schema 版本<a href="#迁移-schema-版本" class="hash-link" aria-label="迁移 schema 版本的直接链接" title="迁移 schema 版本的直接链接" translate="no">​</a></h4>
<p>该示例演示如何将数据从一个 schema 版本迁移到另一个版本。</p>
<p><strong>1. 将旧 schema 的 Parquet 转为 JSON：</strong></p>
<p>如果源数据使用了高精度 schema（128-bit），请添加 <code>--features high-precision</code> 标志。</p>
<div class="language-bash codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-bash codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">cargo run --bin to_json trades.parquet</span><br></span></code></pre></div></div>
<p>此操作会生成 <code>trades.json</code> 与 <code>trades.metadata.json</code> 文件。</p>
<p><strong>2. 切换到新的 schema 版本：</strong></p>
<div class="language-bash codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-bash codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">git checkout &lt;new-version&gt;</span><br></span></code></pre></div></div>
<p><strong>3. 将 JSON 转回新 schema 的 Parquet：</strong></p>
<div class="language-bash codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-bash codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">cargo run --features high-precision --bin to_parquet trades.json</span><br></span></code></pre></div></div>
<p>此命令会生成使用新 schema 的 <code>trades.parquet</code> 文件。</p>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="最佳实践">最佳实践<a href="#最佳实践" class="hash-link" aria-label="最佳实践的直接链接" title="最佳实践的直接链接" translate="no">​</a></h3>
<ul>
<li>先用小数据集测试迁移流程。</li>
<li>保留原始文件的备份。</li>
<li>迁移后验证数据完整性。</li>
<li>在将变更应用到生产数据之前，先在预发布（staging）环境中演练迁移。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_RpWm" id="自定义数据custom-data">自定义数据（Custom data）<a href="#自定义数据custom-data" class="hash-link" aria-label="自定义数据（Custom data）的直接链接" title="自定义数据（Custom data）的直接链接" translate="no">​</a></h2>
<p>由于 Nautilus 设计的模块化特性，系统可以搭建非常灵活的数据流，包括自定义的用户数据类型。本节讨论几种常见用例。</p>
<p>要在 Nautilus 中创建自定义数据类型，首先需要继承自基类 <code>Data</code>。</p>
<div class="theme-admonition theme-admonition-info admonition_lEzE alert alert--info"><div class="admonitionHeading_aAf0"><span class="admonitionIcon_xtBN"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>信息</div><div class="admonitionContent_Vfkp"><p>由于 <code>Data</code> 本身不保存状态，因此并非严格要求在子类中调用 <code>super().__init__()</code>。</p></div></div>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">core </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">MyDataPoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    这是一个示例的用户自定义数据类，继承自基类 `Data`。</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    类中字段 `label`, `x`, `y`, `z` 只是示例，可以根据需要任意扩展。</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        label</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        y</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        z</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ts_event</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ts_init</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">label </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> label</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">y </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">z </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_ts_event </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ts_event</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_ts_init </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ts_init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:#393A34">@property</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ts_event</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        事件发生时的 UNIX 时间戳（纳秒）。</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        返回值类型：int</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_ts_event</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:#393A34">@property</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ts_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        对象初始化时的 UNIX 时间戳（纳秒）。</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        返回值类型：int</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_ts_init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p><code>Data</code> 抽象基类在系统内部作为契约（contract），要求所有数据类型提供两个属性：<code>ts_event</code> 与 <code>ts_init</code>，分别表示事件发生时间和对象初始化时间，均为 UNIX 纳秒时间戳。</p>
<p>推荐的实现方式是将 <code>ts_event</code> 与 <code>ts_init</code> 存储到私有字段，再通过 <code>@property</code> 暴露（如上示例，部分 docstring 从 <code>Data</code> 基类中摘抄）。</p>
<div class="theme-admonition theme-admonition-info admonition_lEzE alert alert--info"><div class="admonitionHeading_aAf0"><span class="admonitionIcon_xtBN"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>信息</div><div class="admonitionContent_Vfkp"><p>这些时间戳能确保 Nautilus 在回测中对数据流按单调递增的 <code>ts_init</code>（UNIX 纳秒）正确排序。</p></div></div>
<p>有了这个自定义数据类型后，你可以在回测或实盘中使用它。例如，可以实现一个 adapter 将外部数据解析为该类型的对象，并发送回 <code>DataEngine</code> 供订阅者消费。</p>
<p>在 actor/strategy 中，你可以通过 message bus 发布自定义数据类型：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">publish_data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DataType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">MyDataPoint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> metadata</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;some_optional_category&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MyDataPoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><code>metadata</code> 字典是可选的，用于在 topic 名称中添加更细粒度的信息以区分数据流。</p>
<p>你也可以将额外的 metadata 信息传入 <code>BacktestDataConfig</code>，以便在回测配置中描述自定义数据对象：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> BacktestDataConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BacktestDataConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    catalog_path</span><span class="token operator" style="color:#393A34">=</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">catalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data_cls</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">MyDataPoint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;some_optional_category&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>在 actor/strategy 中订阅自定义数据类型的方式示例：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">subscribe_data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data_type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">DataType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">MyDataPoint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;some_optional_category&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    client_id</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ClientId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;MY_ADAPTER&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><code>client_id</code> 用于将数据订阅路由到特定客户端。</p>
<p>订阅后，actor/strategy 会将接收到的 <code>MyDataPoint</code> 对象传入 <code>on_data</code> 方法，你需要在方法中做类型判断并处理对应数据：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">on_data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 先判断数据类型</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin">isinstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> MyDataPoint</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 对数据执行处理逻辑</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="发布与接收信号数据signals">发布与接收信号数据（signals）<a href="#发布与接收信号数据signals" class="hash-link" aria-label="发布与接收信号数据（signals）的直接链接" title="发布与接收信号数据（signals）的直接链接" translate="no">​</a></h3>
<p>下面示例演示如何在 actor 或 strategy 中通过 <code>MessageBus</code> 发布与接收信号数据（signal）。
信号是一种自动生成的自定义数据，其名称对应单一的基础类型值（str、float、int、bool 或 bytes）。</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">publish_signal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;signal_name&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ts_event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">subscribe_signal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;signal_name&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">on_signal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> signal</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Signal&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="期权-greeks-示例">期权 Greeks 示例<a href="#期权-greeks-示例" class="hash-link" aria-label="期权 Greeks 示例的直接链接" title="期权 Greeks 示例的直接链接" translate="no">​</a></h3>
<p>本示例演示如何为期权 Greeks（例如 delta）创建自定义数据类型。按照示例，你可以创建、订阅、发布并将其存入 <code>Cache</code> 或 <code>ParquetDataCatalog</code> 以便高效检索。</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> msgspec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">core </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">datetime </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> unix_nanos_to_iso8601</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> DataType</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">serialization</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">base </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> register_serializable_type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">serialization</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">arrow</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">serializer </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> register_arrow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> pyarrow </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> pa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> InstrumentId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">datetime </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> dt_to_unix_nanos</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> unix_nanos_to_dt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> format_iso8601</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">GreeksData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> instrument_id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> InstrumentId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> InstrumentId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;ES.GLBX&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ts_event</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ts_init</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        delta</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">float</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">instrument_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> instrument_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_ts_event </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ts_event</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_ts_init </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ts_init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">delta </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> delta</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__repr__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;GreeksData(ts_init=</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">unix_nanos_to_iso8601</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation">self</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">_ts_init</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">, instrument_id=</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">self</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">instrument_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">, delta=</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">self</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">delta</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.2f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">)&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:#393A34">@property</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ts_event</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_ts_event</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:#393A34">@property</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ts_init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_ts_init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">to_dict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;instrument_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">instrument_id</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;ts_event&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_ts_event</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;ts_init&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_ts_init</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;delta&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">delta</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:#393A34">@classmethod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">from_dict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cls</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">dict</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> GreeksData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">InstrumentId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;instrument_id&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;ts_event&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;ts_init&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;delta&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">to_bytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> msgspec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">msgpack</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">encode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_dict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:#393A34">@classmethod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">from_bytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cls</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">bytes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> cls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_dict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msgspec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">msgpack</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">decode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">to_catalog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> pa</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RecordBatch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_pylist</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_dict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> schema</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">GreeksData</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">schema</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:#393A34">@classmethod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">from_catalog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cls</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> table</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pa</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Table</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">GreeksData</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_dict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">d</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> d </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> table</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_pylist</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:#393A34">@classmethod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">schema</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cls</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> pa</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">schema</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;instrument_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pa</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;ts_event&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pa</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">int64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;ts_init&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pa</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">int64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;delta&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pa</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">float64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="发布与接收数据示例">发布与接收数据示例<a href="#发布与接收数据示例" class="hash-link" aria-label="发布与接收数据示例的直接链接" title="发布与接收数据示例的直接链接" translate="no">​</a></h4>
<p>下面示例展示如何在 actor 或 strategy 中使用 <code>MessageBus</code> 发布与接收数据：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">register_serializable_type</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GreeksData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GreeksData</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_dict</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GreeksData</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_dict</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">publish_greeks</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> greeks_data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> GreeksData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">publish_data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">DataType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GreeksData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> greeks_data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">subscribe_to_greeks</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">subscribe_data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">DataType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GreeksData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">on_data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin">isinstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GreeksData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Data&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="使用-cache-写入与读取数据">使用 Cache 写入与读取数据<a href="#使用-cache-写入与读取数据" class="hash-link" aria-label="使用 Cache 写入与读取数据的直接链接" title="使用 Cache 写入与读取数据的直接链接" translate="no">​</a></h4>
<p>下面示例展示如何在 actor 或 strategy 中使用 <code>Cache</code> 写入和读取数据：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">greeks_key</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">instrument_id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> InstrumentId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">instrument_id</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">_GREEKS&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">cache_greeks</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> greeks_data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> GreeksData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">greeks_key</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">greeks_data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">instrument_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> greeks_data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_bytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">greeks_from_cache</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> instrument_id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> InstrumentId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> GreeksData</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_bytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">greeks_key</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">instrument_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="使用-catalog-写入与读取自定义数据">使用 catalog 写入与读取自定义数据<a href="#使用-catalog-写入与读取自定义数据" class="hash-link" aria-label="使用 catalog 写入与读取自定义数据的直接链接" title="使用 catalog 写入与读取自定义数据的直接链接" translate="no">​</a></h4>
<p>将自定义数据流式写入 feather，或写为 catalog 中的 parquet 文件（需先调用 <code>register_arrow</code>）：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token plain">register_arrow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GreeksData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GreeksData</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">schema</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GreeksData</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_catalog</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GreeksData</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_catalog</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">persistence</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">catalog </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> ParquetDataCatalog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">catalog </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ParquetDataCatalog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;.&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">catalog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">write_data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">GreeksData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_RpWm" id="自动创建自定义数据类">自动创建自定义数据类<a href="#自动创建自定义数据类" class="hash-link" aria-label="自动创建自定义数据类的直接链接" title="自动创建自定义数据类的直接链接" translate="no">​</a></h3>
<p><code>@customdataclass</code> 装饰器可用于自动生成自定义数据类，并为上面提到的功能提供默认实现。</p>
<p>方法均可按需重写。下面是一个使用示例：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">custom </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> customdataclass</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#393A34">@customdataclass</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">GreeksTestData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instrument_id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> InstrumentId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> InstrumentId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;ES.GLBX&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    delta</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">float</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GreeksTestData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instrument_id</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">InstrumentId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;CL.GLBX&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    delta</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1000.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ts_event</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ts_init</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_RpWm" id="自定义数据类型的类型存根stub">自定义数据类型的类型存根（stub）<a href="#自定义数据类型的类型存根stub" class="hash-link" aria-label="自定义数据类型的类型存根（stub）的直接链接" title="自定义数据类型的类型存根（stub）的直接链接" translate="no">​</a></h4>
<p>为提高开发便捷性并改善 IDE 的代码提示，可以为动态生成构造函数的自定义数据类型创建一个 <code>.pyi</code> 类型存根文件，提供正确的构造器签名和属性类型提示。
这样可以让 IDE 识别并为类的方法和属性提供补全建议。</p>
<p>例如，若自定义数据类定义在 <code>greeks.py</code> 中，可创建对应的 <code>greeks.pyi</code> 文件，包含如下构造函数签名：</p>
<div class="language-python codeBlockContainer_euGm theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zF3K"><pre tabindex="0" class="prism-code language-python codeBlock_G1mO thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_QZRj"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">core </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> nautilus_trader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> InstrumentId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">GreeksData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    instrument_id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> InstrumentId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    delta</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">float</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ts_event</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ts_init</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        instrument_id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> InstrumentId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> InstrumentId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;ES.GLBX&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        delta</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">float</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> GreeksData</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/Aloento/NautilusTraderDoc/tree/main/docs/concepts/data.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_F7ru" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_GNoA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/concepts/cache"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">Cache</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/concepts/execution"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">执行</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_pg_n thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#订单簿order-books" class="table-of-contents__link toc-highlight">订单簿（Order books）</a></li><li><a href="#合约品种instruments" class="table-of-contents__link toc-highlight">合约/品种（Instruments）</a></li><li><a href="#k-线与聚合bars-and-aggregation" class="table-of-contents__link toc-highlight">K 线与聚合（Bars and aggregation）</a><ul><li><a href="#k-线简介" class="table-of-contents__link toc-highlight">K 线简介</a></li><li><a href="#聚合的目的" class="table-of-contents__link toc-highlight">聚合的目的</a></li><li><a href="#聚合方法" class="table-of-contents__link toc-highlight">聚合方法</a></li><li><a href="#聚合类型" class="table-of-contents__link toc-highlight">聚合类型</a></li><li><a href="#bar-类型" class="table-of-contents__link toc-highlight">Bar 类型</a></li><li><a href="#聚合来源aggregation-sources" class="table-of-contents__link toc-highlight">聚合来源（Aggregation sources）</a></li><li><a href="#使用字符串语法定义-bartype" class="table-of-contents__link toc-highlight">使用字符串语法定义 BarType</a></li><li><a href="#聚合语法示例" class="table-of-contents__link toc-highlight">聚合语法示例</a></li><li><a href="#使用-barsrequest-与-subscribe-的区别" class="table-of-contents__link toc-highlight">使用 Bars：request 与 subscribe 的区别</a></li><li><a href="#带聚合的历史数据请求" class="table-of-contents__link toc-highlight">带聚合的历史数据请求</a></li><li><a href="#常见陷阱" class="table-of-contents__link toc-highlight">常见陷阱</a></li></ul></li><li><a href="#时间戳timestamps" class="table-of-contents__link toc-highlight">时间戳（Timestamps）</a><ul><li><a href="#示例" class="table-of-contents__link toc-highlight">示例</a></li><li><a href="#延迟分析latency-analysis" class="table-of-contents__link toc-highlight">延迟分析（Latency analysis）</a></li><li><a href="#不同环境下的行为" class="table-of-contents__link toc-highlight">不同环境下的行为</a></li><li><a href="#其他注意事项" class="table-of-contents__link toc-highlight">其他注意事项</a></li></ul></li><li><a href="#数据流data-flow" class="table-of-contents__link toc-highlight">数据流（Data flow）</a></li><li><a href="#数据加载loading-data" class="table-of-contents__link toc-highlight">数据加载（Loading data）</a><ul><li><a href="#data-loaders" class="table-of-contents__link toc-highlight">Data loaders</a></li><li><a href="#data-wranglers" class="table-of-contents__link toc-highlight">Data wranglers</a></li><li><a href="#转换管线transformation-pipeline" class="table-of-contents__link toc-highlight">转换管线（Transformation pipeline）</a></li></ul></li><li><a href="#数据目录data-catalog" class="table-of-contents__link toc-highlight">数据目录（Data catalog）</a><ul><li><a href="#概览与架构" class="table-of-contents__link toc-highlight">概览与架构</a></li><li><a href="#初始化" class="table-of-contents__link toc-highlight">初始化</a></li><li><a href="#文件系统协议与存储选项" class="table-of-contents__link toc-highlight">文件系统协议与存储选项</a></li><li><a href="#写入数据" class="table-of-contents__link toc-highlight">写入数据</a></li><li><a href="#文件命名与数据组织" class="table-of-contents__link toc-highlight">文件命名与数据组织</a></li><li><a href="#读取数据" class="table-of-contents__link toc-highlight">读取数据</a></li><li><a href="#backtestdataconfig--回测的数据规范" class="table-of-contents__link toc-highlight"><code>BacktestDataConfig</code> —— 回测的数据规范</a></li><li><a href="#datacatalogconfig--即时on-the-fly数据加载" class="table-of-contents__link toc-highlight">DataCatalogConfig —— 即时（on-the-fly）数据加载</a></li><li><a href="#查询系统与双后端dual-backend架构" class="table-of-contents__link toc-highlight">查询系统与双后端（dual backend）架构</a></li><li><a href="#catalog-操作" class="table-of-contents__link toc-highlight">Catalog 操作</a></li><li><a href="#feather-流式与格式转换" class="table-of-contents__link toc-highlight">Feather 流式与格式转换</a></li><li><a href="#catalog-摘要" class="table-of-contents__link toc-highlight">Catalog 摘要</a></li></ul></li><li><a href="#数据迁移data-migrations" class="table-of-contents__link toc-highlight">数据迁移（Data migrations）</a><ul><li><a href="#迁移工具" class="table-of-contents__link toc-highlight">迁移工具</a></li><li><a href="#迁移流程" class="table-of-contents__link toc-highlight">迁移流程</a></li><li><a href="#最佳实践" class="table-of-contents__link toc-highlight">最佳实践</a></li></ul></li><li><a href="#自定义数据custom-data" class="table-of-contents__link toc-highlight">自定义数据（Custom data）</a><ul><li><a href="#发布与接收信号数据signals" class="table-of-contents__link toc-highlight">发布与接收信号数据（signals）</a></li><li><a href="#期权-greeks-示例" class="table-of-contents__link toc-highlight">期权 Greeks 示例</a></li><li><a href="#自动创建自定义数据类" class="table-of-contents__link toc-highlight">自动创建自定义数据类</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 NautilusTrader Documentation.</div></div></div></footer></div>
</body>
</html>