"use strict";(globalThis.webpackChunknautilus_trader=globalThis.webpackChunknautilus_trader||[]).push([[6776],{7137:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>t,metadata:()=>i,toc:()=>a});const i=JSON.parse('{"id":"developer_guide/benchmarking","title":"Benchmarking","description":"This guide explains how NautilusTrader measures Rust performance, when to","source":"@site/docs/developer_guide/benchmarking.md","sourceDirName":"developer_guide","slug":"/developer_guide/benchmarking","permalink":"/developer_guide/benchmarking","draft":false,"unlisted":false,"editUrl":"https://github.com/Aloento/NautilusTraderDoc/tree/main/docs/developer_guide/benchmarking.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Adapters","permalink":"/developer_guide/adapters"},"next":{"title":"Coding Standards","permalink":"/developer_guide/coding_standards"}}');var s=r(7259),c=r(9087);const t={},l="Benchmarking",o={},a=[{value:"Tooling overview",id:"tooling-overview",level:2},{value:"Directory layout",id:"directory-layout",level:2},{value:"Writing Criterion benchmarks",id:"writing-criterion-benchmarks",level:2},{value:"Writing iai benchmarks",id:"writing-iai-benchmarks",level:2},{value:"Running benches locally",id:"running-benches-locally",level:2},{value:"Generating a flamegraph",id:"generating-a-flamegraph",level:3},{value:"Linux",id:"linux",level:4},{value:"macOS",id:"macos",level:4},{value:"Templates",id:"templates",level:2}];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,c.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"benchmarking",children:"Benchmarking"})}),"\n",(0,s.jsx)(n.p,{children:"This guide explains how NautilusTrader measures Rust performance, when to\nuse each tool and the conventions you should follow when adding new benches."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"tooling-overview",children:"Tooling overview"}),"\n",(0,s.jsxs)(n.p,{children:["NautilusTrader relies on ",(0,s.jsx)(n.strong,{children:"two complementary benchmarking frameworks"}),":"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Framework"}),(0,s.jsx)(n.th,{children:"What is it?"}),(0,s.jsx)(n.th,{children:"What it measures"}),(0,s.jsx)(n.th,{children:"When to prefer it"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.a,{href:"https://docs.rs/criterion/latest/criterion/",children:(0,s.jsx)(n.strong,{children:"Criterion"})})}),(0,s.jsx)(n.td,{children:"Statistical benchmark harness that produces detailed HTML reports and performs outlier detection."}),(0,s.jsx)(n.td,{children:"Wall-clock run time with confidence intervals."}),(0,s.jsx)(n.td,{children:"End-to-end scenarios, anything slower than \u2248100 ns, visual comparisons."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.a,{href:"https://docs.rs/iai/latest/iai/",children:(0,s.jsx)(n.strong,{children:"iai"})})}),(0,s.jsx)(n.td,{children:"Deterministic micro-benchmark harness that counts retired CPU instructions via hardware counters."}),(0,s.jsx)(n.td,{children:"Exact instruction counts (noise-free)."}),(0,s.jsx)(n.td,{children:"Ultra-fast functions, CI gating via instruction diff."})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:["Most hot code paths benefit from ",(0,s.jsx)(n.strong,{children:"both"})," kinds of measurements."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"directory-layout",children:"Directory layout"}),"\n",(0,s.jsxs)(n.p,{children:["Each crate keeps its performance tests in a local ",(0,s.jsx)(n.code,{children:"benches/"})," folder:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"crates/<crate_name>/\n\u2514\u2500\u2500 benches/\n    \u251c\u2500\u2500 foo_criterion.rs   # Criterion group(s)\n    \u2514\u2500\u2500 foo_iai.rs         # iai micro benches\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"Cargo.toml"})," must list every benchmark explicitly so ",(0,s.jsx)(n.code,{children:"cargo bench"})," discovers\nthem:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-toml",children:'[[bench]]\nname = "foo_criterion"             # file stem in benches/\npath = "benches/foo_criterion.rs"\nharness = false                    # disable the default libtest harness\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"writing-criterion-benchmarks",children:"Writing Criterion benchmarks"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Perform ",(0,s.jsx)(n.strong,{children:"all expensive set-up outside"})," the timing loop (",(0,s.jsx)(n.code,{children:"b.iter"}),")."]}),"\n",(0,s.jsxs)(n.li,{children:["Wrap inputs/outputs in ",(0,s.jsx)(n.code,{children:"black_box"})," to prevent the optimizer from removing\nwork."]}),"\n",(0,s.jsxs)(n.li,{children:["Group related cases with ",(0,s.jsx)(n.code,{children:"benchmark_group!"})," and set ",(0,s.jsx)(n.code,{children:"throughput"})," or\n",(0,s.jsx)(n.code,{children:"sample_size"})," when the defaults aren\u2019t ideal."]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:'use std::hint::black_box;\n\nuse criterion::{Criterion, criterion_group, criterion_main};\n\nfn bench_my_algo(c: &mut Criterion) {\n    let data = prepare_data(); // heavy set-up done once\n\n    c.bench_function("my_algo", |b| {\n        b.iter(|| my_algo(black_box(&data)));\n    });\n}\n\ncriterion_group!(benches, bench_my_algo);\ncriterion_main!(benches);\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"writing-iai-benchmarks",children:"Writing iai benchmarks"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"iai"})," requires functions that take ",(0,s.jsx)(n.strong,{children:"no parameters"})," and return a value (which\ncan be ignored). Keep them as small as possible so the measured instruction\ncount is meaningful."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:"use std::hint::black_box;\n\nfn bench_add() -> i64 {\n    let a = black_box(123);\n    let b = black_box(456);\n    a + b\n}\n\niai::main!(bench_add);\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"running-benches-locally",children:"Running benches locally"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Single crate"}),": ",(0,s.jsx)(n.code,{children:"cargo bench -p nautilus-core"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Single benchmark module"}),": ",(0,s.jsx)(n.code,{children:"cargo bench -p nautilus-core --bench time"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"CI performance benches"}),": ",(0,s.jsx)(n.code,{children:"make cargo-ci-benches"})," (runs the crates included\nin the CI performance workflow one at a time to avoid the mixed-panic-strategy\nlinker issue)."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Criterion writes HTML reports to ",(0,s.jsx)(n.code,{children:"target/criterion/"}),"; open ",(0,s.jsx)(n.code,{children:"target/criterion/report/index.html"})," in your browser."]}),"\n",(0,s.jsx)(n.h3,{id:"generating-a-flamegraph",children:"Generating a flamegraph"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"cargo-flamegraph"})," lets you see a sampled call-stack profile of a single\nbenchmark. On Linux it uses ",(0,s.jsx)(n.code,{children:"perf"}),", and on macOS it uses ",(0,s.jsx)(n.code,{children:"DTrace"}),"."]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Install ",(0,s.jsx)(n.code,{children:"cargo-flamegraph"})," once per machine (it installs a ",(0,s.jsx)(n.code,{children:"cargo flamegraph"}),"\nsubcommand automatically)."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"cargo install flamegraph\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Run a specific bench with the symbol-rich ",(0,s.jsx)(n.code,{children:"bench"})," profile."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# example: the matching benchmark in nautilus-common\ncargo flamegraph --bench matching -p nautilus-common --profile bench\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Open the generated ",(0,s.jsx)(n.code,{children:"flamegraph.svg"})," in your browser and zoom into hot paths."]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"linux",children:"Linux"}),"\n",(0,s.jsxs)(n.p,{children:["On Linux, ",(0,s.jsx)(n.code,{children:"perf"})," must be available. On Debian/Ubuntu, you can install it with:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"sudo apt install linux-tools-common linux-tools-$(uname -r)\n"})}),"\n",(0,s.jsxs)(n.p,{children:["If you see an error mentioning ",(0,s.jsx)(n.code,{children:"perf_event_paranoid"})," you need to relax the\nkernel\u2019s perf restrictions for the current session (root required):"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"sudo sh -c 'echo 1 > /proc/sys/kernel/perf_event_paranoid'\n"})}),"\n",(0,s.jsxs)(n.p,{children:["A value of ",(0,s.jsx)(n.code,{children:"1"})," is typically enough; set it back to ",(0,s.jsx)(n.code,{children:"2"})," (default) or make\nthe change permanent via ",(0,s.jsx)(n.code,{children:"/etc/sysctl.conf"})," if desired."]}),"\n",(0,s.jsx)(n.h4,{id:"macos",children:"macOS"}),"\n",(0,s.jsxs)(n.p,{children:["On macOS, ",(0,s.jsx)(n.code,{children:"DTrace"})," requires root permissions, so you must run ",(0,s.jsx)(n.code,{children:"cargo flamegraph"}),"\nwith ",(0,s.jsx)(n.code,{children:"sudo"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Note the use of sudo\nsudo cargo flamegraph --bench matching -p nautilus-common --profile bench\n"})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Warning"}),"\nRunning with ",(0,s.jsx)(n.code,{children:"sudo"})," will create files in your ",(0,s.jsx)(n.code,{children:"target/"})," directory that are\nowned by the ",(0,s.jsx)(n.code,{children:"root"})," user. This can cause permission errors with subsequent\n",(0,s.jsx)(n.code,{children:"cargo"})," commands."]}),"\n",(0,s.jsxs)(n.p,{children:["To fix this, you may need to remove the root-owned files manually, or simply\nrun ",(0,s.jsx)(n.code,{children:"sudo cargo clean"})," to remove the entire ",(0,s.jsx)(n.code,{children:"target/"})," directory."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Because ",(0,s.jsx)(n.code,{children:"[profile.bench]"})," keeps full debug symbols the SVG will show readable\nfunction names without bloating production binaries (which still use\n",(0,s.jsx)(n.code,{children:'panic = "abort"'})," and are built via ",(0,s.jsx)(n.code,{children:"[profile.release]"}),")."]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Note"})," Benchmark binaries are compiled with the custom ",(0,s.jsx)(n.code,{children:"[profile.bench]"}),"\ndefined in the workspace ",(0,s.jsx)(n.code,{children:"Cargo.toml"}),".  That profile inherits from\n",(0,s.jsx)(n.code,{children:"release-debugging"}),", preserving full optimisation ",(0,s.jsx)(n.em,{children:"and"})," debug symbols so that\ntools like ",(0,s.jsx)(n.code,{children:"cargo flamegraph"})," or ",(0,s.jsx)(n.code,{children:"perf"})," produce human-readable stack traces."]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"templates",children:"Templates"}),"\n",(0,s.jsxs)(n.p,{children:["Ready-to-copy starter files live in ",(0,s.jsx)(n.code,{children:"docs/dev_templates/"}),"."]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Criterion"}),": ",(0,s.jsx)(n.code,{children:"criterion_template.rs"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"iai"}),": ",(0,s.jsx)(n.code,{children:"iai_template.rs"})]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Copy the template into ",(0,s.jsx)(n.code,{children:"benches/"}),", adjust imports and names, and start measuring!"]})]})}function h(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},9087:(e,n,r)=>{r.d(n,{R:()=>t,x:()=>l});var i=r(6363);const s={},c=i.createContext(s);function t(e){const n=i.useContext(c);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:t(e.components),i.createElement(c.Provider,{value:n},e.children)}}}]);