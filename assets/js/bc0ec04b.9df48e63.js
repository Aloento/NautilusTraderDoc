"use strict";(globalThis.webpackChunknautilus_trader=globalThis.webpackChunknautilus_trader||[]).push([[3864],{4049:(e,t,s)=>{s.r(t),s.d(t,{assets:()=>c,contentTitle:()=>d,default:()=>h,frontMatter:()=>o,metadata:()=>n,toc:()=>l});const n=JSON.parse('{"id":"developer_guide/testing","title":"Testing","description":"Our automated tests serve as executable specifications for the trading platform.","source":"@site/docs/developer_guide/testing.md","sourceDirName":"developer_guide","slug":"/developer_guide/testing","permalink":"/developer_guide/testing","draft":false,"unlisted":false,"editUrl":"https://github.com/Aloento/NautilusTraderDoc/tree/main/docs/developer_guide/testing.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Rust Style Guide","permalink":"/developer_guide/rust"},"next":{"title":"\u5165\u95e8","permalink":"/getting_started/"}}');var i=s(7259),r=s(9087);const o={},d="Testing",c={},l=[{value:"Running tests",id:"running-tests",level:2},{value:"Python tests",id:"python-tests",level:3},{value:"Rust tests",id:"rust-tests",level:3},{value:"IDE integration",id:"ide-integration",level:3},{value:"Test style",id:"test-style",level:2},{value:"Waiting for asynchronous effects",id:"waiting-for-asynchronous-effects",level:2},{value:"Mocks",id:"mocks",level:2},{value:"Code coverage",id:"code-coverage",level:2},{value:"Excluded code coverage",id:"excluded-code-coverage",level:2},{value:"Debugging Rust tests",id:"debugging-rust-tests",level:2},{value:"Python + Rust Mixed Debugging",id:"python--rust-mixed-debugging",level:2},{value:"Setup",id:"setup",level:3},{value:"Step 0: Compile <code>nautilus_trader</code> with debug symbols",id:"step-0-compile-nautilus_trader-with-debug-symbols",level:3},{value:"Step 1: Set up debugging configuration",id:"step-1-set-up-debugging-configuration",level:3},{value:"Step 2: Set breakpoints",id:"step-2-set-breakpoints",level:3},{value:"Step 3: Start mixed debugging",id:"step-3-start-mixed-debugging",level:3},{value:"Step 4: Execute code",id:"step-4-execute-code",level:3},{value:"Available configurations",id:"available-configurations",level:3},{value:"Example",id:"example",level:3},{value:"Reference",id:"reference",level:3}];function a(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"testing",children:"Testing"})}),"\n",(0,i.jsx)(t.p,{children:"Our automated tests serve as executable specifications for the trading platform.\nA healthy suite documents intended behaviour, gives contributors confidence to refactor, and catches regressions before they reach production.\nTests also double as living examples that clarify complex flows and provide rapid CI feedback so issues surface early."}),"\n",(0,i.jsx)(t.p,{children:"The suite covers these categories:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"Unit tests"}),"\n",(0,i.jsx)(t.li,{children:"Integration tests"}),"\n",(0,i.jsx)(t.li,{children:"Acceptance tests"}),"\n",(0,i.jsx)(t.li,{children:"Performance tests"}),"\n",(0,i.jsx)(t.li,{children:"Memory leak tests"}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"Performance tests help evolve performance-critical components."}),"\n",(0,i.jsxs)(t.p,{children:["Run tests with ",(0,i.jsx)(t.a,{href:"https://docs.pytest.org",children:"pytest"}),", our primary test runner.\nUse parametrized tests and fixtures (e.g., ",(0,i.jsx)(t.code,{children:"@pytest.mark.parametrize"}),") to avoid repetitive code and improve clarity."]}),"\n",(0,i.jsx)(t.h2,{id:"running-tests",children:"Running tests"}),"\n",(0,i.jsx)(t.h3,{id:"python-tests",children:"Python tests"}),"\n",(0,i.jsx)(t.p,{children:"From the repository root:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:"make pytest\n# or\nuv run --active --no-sync pytest --new-first --failed-first\n# or simply\npytest\n"})}),"\n",(0,i.jsx)(t.p,{children:"For performance tests:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:"make test-performance\n# or\nuv run --active --no-sync pytest tests/performance_tests --benchmark-disable-gc --codspeed\n"})}),"\n",(0,i.jsx)(t.h3,{id:"rust-tests",children:"Rust tests"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:'make cargo-test\n# or\ncargo nextest run --workspace --features "python,ffi,high-precision,defi" --cargo-profile nextest\n'})}),"\n",(0,i.jsx)(t.h3,{id:"ide-integration",children:"IDE integration"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"PyCharm"}),': Right-click the tests folder or file \u2192 "Run pytest".']}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"VS Code"}),": Use the Python Test Explorer extension."]}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"test-style",children:"Test style"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"Name test functions after what they exercise; you do not need to encode the expected assertions in the name."}),"\n",(0,i.jsx)(t.li,{children:"Add docstrings when they clarify setup, scenarios, or expectations."}),"\n",(0,i.jsx)(t.li,{children:"Prefer pytest-style free functions for Python tests instead of test classes with setup methods."}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Group assertions"})," when possible: perform all setup/act steps first, then assert together to avoid the act-assert-act smell."]}),"\n",(0,i.jsxs)(t.li,{children:["Use ",(0,i.jsx)(t.code,{children:"unwrap"}),", ",(0,i.jsx)(t.code,{children:"expect"}),", or direct ",(0,i.jsx)(t.code,{children:"panic!"}),"/",(0,i.jsx)(t.code,{children:"assert"})," calls inside tests; clarity and conciseness matter more than defensive error handling here."]}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"waiting-for-asynchronous-effects",children:"Waiting for asynchronous effects"}),"\n",(0,i.jsxs)(t.p,{children:["When waiting for background work to complete, prefer the polling helpers ",(0,i.jsx)(t.code,{children:"await eventually(...)"})," from ",(0,i.jsx)(t.code,{children:"nautilus_trader.test_kit.functions"})," and ",(0,i.jsx)(t.code,{children:"wait_until_async(...)"})," from ",(0,i.jsx)(t.code,{children:"nautilus_common::testing"})," instead of arbitrary sleeps. They surface failures faster and reduce flakiness in CI because they stop as soon as the condition is satisfied or time out with a useful error."]}),"\n",(0,i.jsx)(t.h2,{id:"mocks",children:"Mocks"}),"\n",(0,i.jsxs)(t.p,{children:["Use lightweight collaborators as mocks to keep the suite simple and avoid heavy mocking frameworks.\nWe still rely on ",(0,i.jsx)(t.code,{children:"MagicMock"})," in specific cases where it provides the most convenient tooling."]}),"\n",(0,i.jsx)(t.h2,{id:"code-coverage",children:"Code coverage"}),"\n",(0,i.jsxs)(t.p,{children:["We generate coverage reports with ",(0,i.jsx)(t.code,{children:"coverage"})," and publish them to ",(0,i.jsx)(t.a,{href:"https://about.codecov.io/",children:"codecov"}),"."]}),"\n",(0,i.jsx)(t.p,{children:'Aim for high coverage without sacrificing appropriate error handling or causing "test induced damage" to the architecture.'}),"\n",(0,i.jsx)(t.p,{children:"Some branches remain untestable without modifying production behaviour.\nFor example, a final condition in a defensive if-else block may only trigger for unexpected values; leave these checks in place so future changes can exercise them if needed."}),"\n",(0,i.jsx)(t.p,{children:"Design-time exceptions can also be impractical to test, so 100% coverage is not the target."}),"\n",(0,i.jsx)(t.h2,{id:"excluded-code-coverage",children:"Excluded code coverage"}),"\n",(0,i.jsxs)(t.p,{children:["We use ",(0,i.jsx)(t.code,{children:"pragma: no cover"})," comments to ",(0,i.jsx)(t.a,{href:"https://coverage.readthedocs.io/en/coverage-4.3.3/excluding.html",children:"exclude code from coverage"})," when tests would be redundant.\nTypical examples include:"]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["Asserting an abstract method raises ",(0,i.jsx)(t.code,{children:"NotImplementedError"})," when called."]}),"\n",(0,i.jsx)(t.li,{children:"Asserting the final condition check of an if-else block when impossible to test (as above)."}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["Such tests are expensive to maintain because they must track refactors while providing little value.\nEnsure concrete implementations of abstract methods remain fully covered.\nRemove ",(0,i.jsx)(t.code,{children:"pragma: no cover"})," when it no longer applies and restrict its use to the cases above."]}),"\n",(0,i.jsx)(t.h2,{id:"debugging-rust-tests",children:"Debugging Rust tests"}),"\n",(0,i.jsx)(t.p,{children:"Use the default test configuration to debug Rust tests."}),"\n",(0,i.jsxs)(t.p,{children:["To run the full suite with debug symbols for later, run ",(0,i.jsx)(t.code,{children:"make cargo-test-debug"})," instead of ",(0,i.jsx)(t.code,{children:"make cargo-test"}),"."]}),"\n",(0,i.jsxs)(t.p,{children:["In IntelliJ IDEA, adjust the run configuration for parametrised ",(0,i.jsx)(t.code,{children:"#[rstest]"})," cases so it reads ",(0,i.jsx)(t.code,{children:"test --package nautilus-model --lib data::bar::tests::test_get_time_bar_start::case_1"}),"\n(remove ",(0,i.jsx)(t.code,{children:"-- --exact"})," and append ",(0,i.jsx)(t.code,{children:"::case_n"})," where ",(0,i.jsx)(t.code,{children:"n"})," starts at 1). This workaround matches the behaviour explained ",(0,i.jsx)(t.a,{href:"https://github.com/rust-lang/rust-analyzer/issues/8964#issuecomment-871592851",children:"here"}),"."]}),"\n",(0,i.jsx)(t.p,{children:"In VS Code you can pick the specific test case to debug directly."}),"\n",(0,i.jsx)(t.h2,{id:"python--rust-mixed-debugging",children:"Python + Rust Mixed Debugging"}),"\n",(0,i.jsx)(t.p,{children:"This workflow lets you debug Python and Rust code simultaneously from a Jupyter notebook inside VS Code."}),"\n",(0,i.jsx)(t.h3,{id:"setup",children:"Setup"}),"\n",(0,i.jsx)(t.p,{children:"Install these VS Code extensions: Rust Analyzer, CodeLLDB, Python, Jupyter."}),"\n",(0,i.jsxs)(t.h3,{id:"step-0-compile-nautilus_trader-with-debug-symbols",children:["Step 0: Compile ",(0,i.jsx)(t.code,{children:"nautilus_trader"})," with debug symbols"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:"cd nautilus_trader && make build-debug-pyo3\n"})}),"\n",(0,i.jsx)(t.h3,{id:"step-1-set-up-debugging-configuration",children:"Step 1: Set up debugging configuration"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-python",children:"from nautilus_trader.test_kit.debug_helpers import setup_debugging\n\nsetup_debugging()\n"})}),"\n",(0,i.jsxs)(t.p,{children:["This command creates the required VS Code debugging configurations and starts a ",(0,i.jsx)(t.code,{children:"debugpy"})," server for the Python debugger."]}),"\n",(0,i.jsxs)(t.p,{children:["By default ",(0,i.jsx)(t.code,{children:"setup_debugging()"})," expects the ",(0,i.jsx)(t.code,{children:".vscode"})," folder one level above the ",(0,i.jsx)(t.code,{children:"nautilus_trader"})," root directory.\nAdjust the target location if your workspace layout differs."]}),"\n",(0,i.jsx)(t.h3,{id:"step-2-set-breakpoints",children:"Step 2: Set breakpoints"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Python breakpoints:"})," Set in VS Code in the Python source files."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Rust breakpoints:"})," Set in VS Code in the Rust source files."]}),"\n"]}),"\n",(0,i.jsx)(t.h3,{id:"step-3-start-mixed-debugging",children:"Step 3: Start mixed debugging"}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsxs)(t.li,{children:["In VS Code select the ",(0,i.jsx)(t.strong,{children:'"Debug Jupyter + Rust (Mixed)"'})," configuration."]}),"\n",(0,i.jsx)(t.li,{children:"Start debugging (F5) or press the green run arrow."}),"\n",(0,i.jsx)(t.li,{children:"Both Python and Rust debuggers attach to your Jupyter session."}),"\n"]}),"\n",(0,i.jsx)(t.h3,{id:"step-4-execute-code",children:"Step 4: Execute code"}),"\n",(0,i.jsx)(t.p,{children:"Run Jupyter notebook cells that call Rust functions. The debugger stops at breakpoints in both Python and Rust code."}),"\n",(0,i.jsx)(t.h3,{id:"available-configurations",children:"Available configurations"}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.code,{children:"setup_debugging()"})," creates these VS Code configurations:"]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:(0,i.jsx)(t.code,{children:"Debug Jupyter + Rust (Mixed)"})})," - Mixed debugging for Jupyter notebooks."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:(0,i.jsx)(t.code,{children:"Jupyter Mixed Debugging (Python)"})})," - Python-only debugging for notebooks."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:(0,i.jsx)(t.code,{children:"Rust Debugger (for Jupyter debugging)"})})," - Rust-only debugging for notebooks."]}),"\n"]}),"\n",(0,i.jsx)(t.h3,{id:"example",children:"Example"}),"\n",(0,i.jsxs)(t.p,{children:["Open and run the example notebook: ",(0,i.jsx)(t.code,{children:"debug_mixed_jupyter.ipynb"}),"."]}),"\n",(0,i.jsx)(t.h3,{id:"reference",children:"Reference"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.a,{href:"https://pyo3.rs/v0.25.1/debugging.html?highlight=deb#debugging-from-jupyter-notebooks",children:"PyO3 debugging"})}),"\n"]})]})}function h(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}},9087:(e,t,s)=>{s.d(t,{R:()=>o,x:()=>d});var n=s(6363);const i={},r=n.createContext(i);function o(e){const t=n.useContext(r);return n.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function d(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),n.createElement(r.Provider,{value:t},e.children)}}}]);