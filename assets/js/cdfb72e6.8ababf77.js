"use strict";(globalThis.webpackChunknautilus_trader=globalThis.webpackChunknautilus_trader||[]).push([[6152],{2633:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>i,default:()=>u,frontMatter:()=>s,metadata:()=>a,toc:()=>l});const a=JSON.parse('{"id":"tutorials/backtest_binance_orderbook","title":"\u56de\u6d4b\uff1aBinance OrderBook \u6570\u636e","description":"\u672c\u6559\u7a0b\u9488\u5bf9 NautilusTrader\uff08\u9ad8\u6027\u80fd\u7b97\u6cd5\u4ea4\u6613\u4e0e\u4e8b\u4ef6\u9a71\u52a8\u56de\u6d4b\u6846\u67b6\uff09\uff0c\u5c55\u793a\u5982\u4f55\u4e3a OrderBook \u6570\u636e\u5efa\u7acb\u6570\u636e\u76ee\u5f55\uff08data catalog\uff09\u5e76\u7528 BacktestNode \u56de\u6d4b OrderBookImbalance \u7b56\u7565\u3002\u8be5\u793a\u4f8b\u9700\u8981\u4f60\u81ea\u884c\u51c6\u5907 Binance \u7684 order book \u6570\u636e\uff08\u4e0d\u968f\u4ed3\u5e93\u63d0\u4f9b\uff09\u3002","source":"@site/docs/tutorials/backtest_binance_orderbook.md","sourceDirName":"tutorials","slug":"/tutorials/backtest_binance_orderbook","permalink":"/tutorials/backtest_binance_orderbook","draft":false,"unlisted":false,"editUrl":"https://github.com/Aloento/NautilusTraderDoc/tree/main/docs/tutorials/backtest_binance_orderbook.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"\u6559\u7a0b","permalink":"/tutorials/"},"next":{"title":"\u56de\u6d4b\uff1aBybit OrderBook \u6570\u636e","permalink":"/tutorials/backtest_bybit_orderbook"}}');var r=t(7259),o=t(9087);const s={},i="\u56de\u6d4b\uff1aBinance OrderBook \u6570\u636e",d={},l=[{value:"\u6982\u8ff0",id:"\u6982\u8ff0",level:2},{value:"\u524d\u7f6e\u6761\u4ef6",id:"\u524d\u7f6e\u6761\u4ef6",level:2},{value:"\u5bfc\u5165",id:"\u5bfc\u5165",level:2},{value:"\u52a0\u8f7d\u6570\u636e",id:"\u52a0\u8f7d\u6570\u636e",level:2},{value:"\u4f7f\u7528 wrangler \u5904\u7406\u589e\u91cf\uff08deltas\uff09",id:"\u4f7f\u7528-wrangler-\u5904\u7406\u589e\u91cfdeltas",level:3},{value:"\u5efa\u7acb\u6570\u636e\u76ee\u5f55\uff08data catalog\uff09",id:"\u5efa\u7acb\u6570\u636e\u76ee\u5f55data-catalog",level:3},{value:"\u914d\u7f6e\u56de\u6d4b",id:"\u914d\u7f6e\u56de\u6d4b",level:2},{value:"\u8fd0\u884c\u56de\u6d4b",id:"\u8fd0\u884c\u56de\u6d4b",level:2}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"\u56de\u6d4bbinance-orderbook-\u6570\u636e",children:"\u56de\u6d4b\uff1aBinance OrderBook \u6570\u636e"})}),"\n",(0,r.jsxs)(n.p,{children:["\u672c\u6559\u7a0b\u9488\u5bf9 NautilusTrader\uff08\u9ad8\u6027\u80fd\u7b97\u6cd5\u4ea4\u6613\u4e0e\u4e8b\u4ef6\u9a71\u52a8\u56de\u6d4b\u6846\u67b6\uff09\uff0c\u5c55\u793a\u5982\u4f55\u4e3a OrderBook \u6570\u636e\u5efa\u7acb\u6570\u636e\u76ee\u5f55\uff08data catalog\uff09\u5e76\u7528 ",(0,r.jsx)(n.code,{children:"BacktestNode"})," \u56de\u6d4b ",(0,r.jsx)(n.code,{children:"OrderBookImbalance"})," \u7b56\u7565\u3002\u8be5\u793a\u4f8b\u9700\u8981\u4f60\u81ea\u884c\u51c6\u5907 Binance \u7684 order book \u6570\u636e\uff08\u4e0d\u968f\u4ed3\u5e93\u63d0\u4f9b\uff09\u3002"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://github.com/nautechsystems/nautilus_trader/blob/develop/docs/tutorials/backtest_binance_orderbook.ipynb",children:"\u5728 GitHub \u67e5\u770b\u6e90\u7801"}),"\u3002"]}),"\n",(0,r.jsx)(n.admonition,{type:"info",children:(0,r.jsx)(n.p,{children:"\u672c\u6559\u7a0b\u4ecd\u5728\u7f16\u5199\u4e2d\uff0c\u90e8\u5206\u7ec6\u8282\u53ef\u80fd\u4f1a\u66f4\u65b0\u3002"})}),"\n",(0,r.jsx)(n.h2,{id:"\u6982\u8ff0",children:"\u6982\u8ff0"}),"\n",(0,r.jsxs)(n.p,{children:["\u672c\u6559\u7a0b\u6f14\u793a\u5982\u4f55\u51c6\u5907\u6570\u636e\u76ee\u5f55\u5e76\u6784\u5efa\u4e00\u4e2a ",(0,r.jsx)(n.code,{children:"BacktestNode"}),"\uff0c\u4ee5\u5728 Order Book \u6570\u636e\u4e0a\u56de\u6d4b ",(0,r.jsx)(n.code,{children:"OrderBookImbalance"})," \u7b56\u7565\u3002\u793a\u4f8b\u5047\u5b9a\u4f60\u5df2\u7ecf\u62e5\u6709 Binance \u7684\u8ba2\u5355\u7c3f\uff08order book\uff09\u5feb\u7167\u4e0e\u66f4\u65b0\u6570\u636e\u3002"]}),"\n",(0,r.jsx)(n.h2,{id:"\u524d\u7f6e\u6761\u4ef6",children:"\u524d\u7f6e\u6761\u4ef6"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u5df2\u5b89\u88c5 Python 3.11+\u3002"}),"\n",(0,r.jsxs)(n.li,{children:["\u5df2\u5b89\u88c5 JupyterLab \u6216\u540c\u7c7b\u5de5\u5177\uff08",(0,r.jsx)(n.code,{children:"pip install -U jupyterlab"}),"\uff09\u3002"]}),"\n",(0,r.jsxs)(n.li,{children:["\u5df2\u5b89\u88c5 NautilusTrader \u6700\u65b0\u53d1\u5e03\u7248\uff08",(0,r.jsx)(n.code,{children:"pip install -U nautilus_trader"}),"\uff09\u3002"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"\u5bfc\u5165",children:"\u5bfc\u5165"}),"\n",(0,r.jsx)(n.p,{children:"\u4e0b\u9762\u5217\u51fa\u672c\u6307\u5357\u5176\u4f59\u90e8\u5206\u6240\u9700\u7684 import\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"import os\nimport shutil\nfrom decimal import Decimal\nfrom pathlib import Path\n\nimport pandas as pd\n\nfrom nautilus_trader.adapters.binance.loaders import BinanceOrderBookDeltaDataLoader\nfrom nautilus_trader.backtest.node import BacktestDataConfig\nfrom nautilus_trader.backtest.node import BacktestEngineConfig\nfrom nautilus_trader.backtest.node import BacktestNode\nfrom nautilus_trader.backtest.node import BacktestRunConfig\nfrom nautilus_trader.backtest.node import BacktestVenueConfig\nfrom nautilus_trader.config import ImportableStrategyConfig\nfrom nautilus_trader.config import LoggingConfig\nfrom nautilus_trader.core.datetime import dt_to_unix_nanos\nfrom nautilus_trader.model import OrderBookDelta\nfrom nautilus_trader.persistence.catalog import ParquetDataCatalog\nfrom nautilus_trader.persistence.wranglers import OrderBookDeltaDataWrangler\nfrom nautilus_trader.test_kit.providers import TestInstrumentProvider\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u52a0\u8f7d\u6570\u636e",children:"\u52a0\u8f7d\u6570\u636e"}),"\n",(0,r.jsx)(n.p,{children:"\u793a\u4f8b\u4e2d\u6211\u4eec\u5047\u8bbe\u6570\u636e\u653e\u5728\u7528\u6237\u7684 Downloads \u4e0b\u7684\u4e00\u4e2a Binance \u5b50\u76ee\u5f55\uff0c\u4e0b\u9762\u7ed9\u51fa\u793a\u4f8b\u8def\u5f84\u914d\u7f6e\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'# \u6307\u5411\u4f60\u7684\u6570\u636e\u76ee\u5f55\uff0c\u8fd9\u91cc\u4ee5\u7528\u6237\u7684 ~/Downloads \u4e3a\u4f8b\nDATA_DIR = "~/Downloads"\n'})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'data_path = Path(DATA_DIR).expanduser() / "Data" / "Binance"\nraw_files = list(data_path.iterdir())\nassert raw_files, f"Unable to find any histdata files in directory {data_path}"\nraw_files\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u9996\u5148\u8bfb\u53d6\u521d\u59cb\u7684 order book \u5feb\u7167\uff08snapshot\uff09\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'# \u8bfb\u53d6\u521d\u59cb\u5feb\u7167\npath_snap = data_path / "BTCUSDT_T_DEPTH_2022-11-01_depth_snap.csv"\ndf_snap = BinanceOrderBookDeltaDataLoader.load(path_snap)\ndf_snap.head()\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u968f\u540e\u8bfb\u53d6 order book \u7684\u66f4\u65b0\uff08updates\uff09\u3002\u4e3a\u8282\u7701\u65f6\u95f4\uff0c\u793a\u4f8b\u4e2d\u5c06\u8bfb\u53d6\u884c\u6570\u9650\u5236\u4e3a 1 \u767e\u4e07\u884c\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'# \u8bfb\u53d6 order book \u66f4\u65b0\uff08\u6b64\u5904\u4e3a\u793a\u4f8b\uff0c\u9650\u5236 1M \u884c\uff09\npath_update = data_path / "BTCUSDT_T_DEPTH_2022-11-01_depth_update.csv"\nnrows = 1_000_000\ndf_update = BinanceOrderBookDeltaDataLoader.load(path_update, nrows=nrows)\ndf_update.head()\n'})}),"\n",(0,r.jsx)(n.h3,{id:"\u4f7f\u7528-wrangler-\u5904\u7406\u589e\u91cfdeltas",children:"\u4f7f\u7528 wrangler \u5904\u7406\u589e\u91cf\uff08deltas\uff09"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"BTCUSDT_BINANCE = TestInstrumentProvider.btcusdt_binance()\nwrangler = OrderBookDeltaDataWrangler(BTCUSDT_BINANCE)\n\ndeltas = wrangler.process(df_snap)\ndeltas += wrangler.process(df_update)\ndeltas.sort(key=lambda x: x.ts_init)  # \u786e\u4fdd\u6570\u636e\u6309 `ts_init` \u975e\u964d\u5e8f\ndeltas[:10]\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u5efa\u7acb\u6570\u636e\u76ee\u5f55data-catalog",children:"\u5efa\u7acb\u6570\u636e\u76ee\u5f55\uff08data catalog\uff09"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'CATALOG_PATH = os.getcwd() + "/catalog"\n\n# \u82e5\u5df2\u5b58\u5728\u5219\u5148\u5220\u9664\u518d\u521b\u5efa\nif os.path.exists(CATALOG_PATH):\n    shutil.rmtree(CATALOG_PATH)\nos.mkdir(CATALOG_PATH)\n\n# \u521b\u5efa ParquetDataCatalog \u5b9e\u4f8b\ncatalog = ParquetDataCatalog(CATALOG_PATH)\n'})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"# \u5c06 instrument \u4e0e deltas \u5199\u5165 catalog\ncatalog.write_data([BTCUSDT_BINANCE])\ncatalog.write_data(deltas)\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"# \u786e\u8ba4 instrument \u5df2\u5199\u5165\ncatalog.instruments()\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'# \u5728 catalog \u4e2d\u63a2\u67e5\u53ef\u7528\u6570\u636e\u8303\u56f4\nstart = dt_to_unix_nanos(pd.Timestamp("2022-11-01", tz="UTC"))\nend =  dt_to_unix_nanos(pd.Timestamp("2022-11-04", tz="UTC"))\n\n\nprint(len(deltas))\ndeltas[:10]\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u914d\u7f6e\u56de\u6d4b",children:"\u914d\u7f6e\u56de\u6d4b"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'instrument = catalog.instruments()[0]\nbook_type = "L2_MBP"  # \u786e\u4fdd\u6570\u636e\u7684 book_type \u4e0e venue \u7684 book_type \u5339\u914d\n\ndata_configs = [BacktestDataConfig(\n        catalog_path=CATALOG_PATH,\n        data_cls=OrderBookDelta,\n        instrument_id=instrument.id,\n        # start_time=start,  # \u53ef\u6309\u9700\u9650\u5b9a\u65f6\u95f4\u8303\u56f4\n        # end_time=end,  # \u53ef\u6309\u9700\u9650\u5b9a\u65f6\u95f4\u8303\u56f4\n    )\n]\n\nvenues_configs = [\n    BacktestVenueConfig(\n        name="BINANCE",\n        oms_type="NETTING",\n        account_type="CASH",\n        base_currency=None,\n        starting_balances=["20 BTC", "100000 USDT"],\n        book_type=book_type,  # <-- venue \u7684 book_type\n    )\n]\n\nstrategies = [\n    ImportableStrategyConfig(\n        strategy_path="nautilus_trader.examples.strategies.orderbook_imbalance:OrderBookImbalance",\n        config_path="nautilus_trader.examples.strategies.orderbook_imbalance:OrderBookImbalanceConfig",\n        config={\n            "instrument_id": instrument.id,\n            "book_type": book_type,\n            "max_trade_size": Decimal("1.000"),\n            "min_seconds_between_triggers": 1.0,\n        },\n    ),\n]\n\n# NautilusTrader \u5728 Jupyter \u4e2d\u7684\u65e5\u5fd7\u8f93\u51fa\u4f1a\u8d85\u8fc7\u9ed8\u8ba4\u901f\u7387\u9650\u5236\uff08stdout\uff09\uff0c\n# \u56e0\u6b64\u793a\u4f8b\u4e2d\u5c06 `log_level` \u8bbe\u7f6e\u4e3a "ERROR"\u3002\u82e5\u5c06\u5176\u8c03\u4f4e\u4ee5\u67e5\u770b\u66f4\u591a\u65e5\u5fd7\uff0cnotebook \u53ef\u80fd\u4f1a\u5728\u6267\u884c\u65f6\u6302\u8d77\u3002\n# \u76ee\u524d\u7684\u89e3\u51b3\u65b9\u6848\u65b9\u5411\u5305\u62ec\u63d0\u9ad8 Jupyter \u7684\u901f\u7387\u9650\u5236\u6216\u5bf9 Nautilus \u7684\u65e5\u5fd7\u5237\u65b0\u8fdb\u884c\u9650\u6d41\u3002\n# https://github.com/jupyterlab/jupyterlab/issues/12845\n# https://github.com/deshaw/jupyterlab-limit-output\nconfig = BacktestRunConfig(\n    engine=BacktestEngineConfig(\n        strategies=strategies,\n        logging=LoggingConfig(log_level="ERROR"),\n    ),\n    data=data_configs,\n    venues=venues_configs,\n)\n\nconfig\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u8fd0\u884c\u56de\u6d4b",children:"\u8fd0\u884c\u56de\u6d4b"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"node = BacktestNode(configs=[config])\n\nresult = node.run()\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"result\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u8fd0\u884c\u7ed3\u675f\u540e\uff0c\u4f60\u53ef\u4ee5\u83b7\u53d6\u5185\u90e8\u7684 ",(0,r.jsx)(n.code,{children:"BacktestEngine"})," \u5b9e\u4f8b\u4ee5\u4fbf\u8fdb\u4e00\u6b65\u67e5\u8be2\u62a5\u544a\uff1a"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"from nautilus_trader.backtest.engine import BacktestEngine\nfrom nautilus_trader.model import Venue\n\n\nengine: BacktestEngine = node.get_engine(config.id)\n\nengine.trader.generate_order_fills_report()\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"engine.trader.generate_positions_report()\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'engine.trader.generate_account_report(Venue("BINANCE"))\n'})})]})}function u(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},9087:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>i});var a=t(6363);const r={},o=a.createContext(r);function s(e){const n=a.useContext(o);return a.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),a.createElement(o.Provider,{value:n},e.children)}}}]);